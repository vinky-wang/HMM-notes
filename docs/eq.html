<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Major Earthquake Analysis | Hidden Markov Model Notes</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Major Earthquake Analysis | Hidden Markov Model Notes" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="vinky-wang/HMM-Notes" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Major Earthquake Analysis | Hidden Markov Model Notes" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Vinky Wang" />


<meta name="date" content="2023-06-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-inference-for-hmms.html"/>
<link rel="next" href="appendix.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">HMM Notes</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a></li>
<li class="chapter" data-level="2" data-path="prelim.html"><a href="prelim.html"><i class="fa fa-check"></i><b>2</b> Preliminaries</a>
<ul>
<li class="chapter" data-level="2.1" data-path="prelim.html"><a href="prelim.html#mix"><i class="fa fa-check"></i><b>2.1</b> Independent Mixture Models</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="prelim.html"><a href="prelim.html#properties"><i class="fa fa-check"></i><b>2.1.1</b> Properties</a></li>
<li class="chapter" data-level="2.1.2" data-path="prelim.html"><a href="prelim.html#parameter-estimation"><i class="fa fa-check"></i><b>2.1.2</b> Parameter Estimation</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="prelim.html"><a href="prelim.html#mc"><i class="fa fa-check"></i><b>2.2</b> Markov Chains</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="prelim.html"><a href="prelim.html#probabilities"><i class="fa fa-check"></i><b>2.2.1</b> Probabilities</a></li>
<li class="chapter" data-level="2.2.2" data-path="prelim.html"><a href="prelim.html#stationary-distribution"><i class="fa fa-check"></i><b>2.2.2</b> Stationary Distribution</a></li>
<li class="chapter" data-level="2.2.3" data-path="prelim.html"><a href="prelim.html#tp"><i class="fa fa-check"></i><b>2.2.3</b> Transition Probabilities Estimation</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="prelim.html"><a href="prelim.html#exercises"><i class="fa fa-check"></i><b>2.3</b> Exercises</a></li>
<li class="chapter" data-level="2.4" data-path="prelim.html"><a href="prelim.html#solutions"><i class="fa fa-check"></i><b>2.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introhmm.html"><a href="introhmm.html"><i class="fa fa-check"></i><b>3</b> Introduction to Hidden Markov Models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introhmm.html"><a href="introhmm.html#sdd"><i class="fa fa-check"></i><b>3.1</b> State-Dependent Distributions</a></li>
<li class="chapter" data-level="3.2" data-path="introhmm.html"><a href="introhmm.html#marginal-distributions"><i class="fa fa-check"></i><b>3.2</b> Marginal Distributions</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="introhmm.html"><a href="introhmm.html#univariate-case"><i class="fa fa-check"></i><b>3.2.1</b> Univariate Case</a></li>
<li class="chapter" data-level="3.2.2" data-path="introhmm.html"><a href="introhmm.html#bivariate"><i class="fa fa-check"></i><b>3.2.2</b> Bivariate Case</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="introhmm.html"><a href="introhmm.html#moments"><i class="fa fa-check"></i><b>3.3</b> Moments</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="introhmm.html"><a href="introhmm.html#univariate-case-1"><i class="fa fa-check"></i><b>3.3.1</b> Univariate Case</a></li>
<li class="chapter" data-level="3.3.2" data-path="introhmm.html"><a href="introhmm.html#bivariate-case"><i class="fa fa-check"></i><b>3.3.2</b> Bivariate Case</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="introhmm.html"><a href="introhmm.html#lik"><i class="fa fa-check"></i><b>3.4</b> Likelihood of Hidden Markov Models</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="introhmm.html"><a href="introhmm.html#forsec"><i class="fa fa-check"></i><b>3.4.1</b> Forward Algorithm</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="introhmm.html"><a href="introhmm.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
<li class="chapter" data-level="3.6" data-path="introhmm.html"><a href="introhmm.html#solutions-1"><i class="fa fa-check"></i><b>3.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="numerical.html"><a href="numerical.html"><i class="fa fa-check"></i><b>4</b> Numerical Maximization of the Likelihood</a>
<ul>
<li class="chapter" data-level="4.1" data-path="numerical.html"><a href="numerical.html#likscale"><i class="fa fa-check"></i><b>4.1</b> Scaling the Likelihood Computation</a></li>
<li class="chapter" data-level="4.2" data-path="numerical.html"><a href="numerical.html#reparam"><i class="fa fa-check"></i><b>4.2</b> Reparameterization to Avoid Constraints</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="numerical.html"><a href="numerical.html#transition-probabilities"><i class="fa fa-check"></i><b>4.2.1</b> Transition Probabilities</a></li>
<li class="chapter" data-level="4.2.2" data-path="numerical.html"><a href="numerical.html#parameters-of-state-dependent-distributions"><i class="fa fa-check"></i><b>4.2.2</b> Parameters of State-Dependent Distributions</a></li>
<li class="chapter" data-level="4.2.3" data-path="numerical.html"><a href="numerical.html#initial-probabilities"><i class="fa fa-check"></i><b>4.2.3</b> Initial Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="numerical.html"><a href="numerical.html#startval"><i class="fa fa-check"></i><b>4.3</b> Strategies for Choosing Starting Values</a></li>
<li class="chapter" data-level="4.4" data-path="numerical.html"><a href="numerical.html#boot"><i class="fa fa-check"></i><b>4.4</b> Obtaining Standard Errors and Confidence Intervals</a></li>
<li class="chapter" data-level="4.5" data-path="numerical.html"><a href="numerical.html#exercises-2"><i class="fa fa-check"></i><b>4.5</b> Exercises</a></li>
<li class="chapter" data-level="4.6" data-path="numerical.html"><a href="numerical.html#solutions-2"><i class="fa fa-check"></i><b>4.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fbalg.html"><a href="fbalg.html"><i class="fa fa-check"></i><b>5</b> The Forward and Backward Algorithm</a>
<ul>
<li class="chapter" data-level="5.1" data-path="fbalg.html"><a href="fbalg.html#forward-and-backward-probabilities"><i class="fa fa-check"></i><b>5.1</b> Forward and Backward Probabilities</a></li>
<li class="chapter" data-level="5.2" data-path="fbalg.html"><a href="fbalg.html#properties-of-hmms"><i class="fa fa-check"></i><b>5.2</b> Properties of HMMs</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="fbalg.html"><a href="fbalg.html#property"><i class="fa fa-check"></i><b>5.2.1</b> Property</a></li>
<li class="chapter" data-level="5.2.2" data-path="fbalg.html"><a href="fbalg.html#property-1"><i class="fa fa-check"></i><b>5.2.2</b> Property</a></li>
<li class="chapter" data-level="5.2.3" data-path="fbalg.html"><a href="fbalg.html#property-2"><i class="fa fa-check"></i><b>5.2.3</b> Property</a></li>
<li class="chapter" data-level="5.2.4" data-path="fbalg.html"><a href="fbalg.html#property-3"><i class="fa fa-check"></i><b>5.2.4</b> Property</a></li>
<li class="chapter" data-level="5.2.5" data-path="fbalg.html"><a href="fbalg.html#property-4"><i class="fa fa-check"></i><b>5.2.5</b> Property</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="fbalg.html"><a href="fbalg.html#forward-probabilities-as-joint-probabilities"><i class="fa fa-check"></i><b>5.3</b> Forward Probabilities as Joint Probabilities</a></li>
<li class="chapter" data-level="5.4" data-path="fbalg.html"><a href="fbalg.html#backward-probabilities-as-conditional-probabilities"><i class="fa fa-check"></i><b>5.4</b> Backward Probabilities as Conditional Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="em.html"><a href="em.html"><i class="fa fa-check"></i><b>6</b> Expectation-Maximization Algorithm (Baum-Welch)</a>
<ul>
<li class="chapter" data-level="6.1" data-path="em.html"><a href="em.html#em-algorithm-general"><i class="fa fa-check"></i><b>6.1</b> EM Algorithm (General)</a></li>
<li class="chapter" data-level="6.2" data-path="em.html"><a href="em.html#em-algorithm-for-hmms"><i class="fa fa-check"></i><b>6.2</b> EM Algorithm (for HMMs)</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="em.html"><a href="em.html#stationary-markov-chain"><i class="fa fa-check"></i><b>6.2.1</b> Stationary Markov Chain</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="em.html"><a href="em.html#exercises-3"><i class="fa fa-check"></i><b>6.3</b> Exercises</a></li>
<li class="chapter" data-level="6.4" data-path="em.html"><a href="em.html#solutions-3"><i class="fa fa-check"></i><b>6.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="fdp.html"><a href="fdp.html"><i class="fa fa-check"></i><b>7</b> Forecasting, Decoding, and State Prediction</a>
<ul>
<li class="chapter" data-level="7.1" data-path="fdp.html"><a href="fdp.html#conditional-distribution"><i class="fa fa-check"></i><b>7.1</b> Conditional Distribution</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="fdp.html"><a href="fdp.html#as-mixtures-of-state-dependent-probabilities"><i class="fa fa-check"></i><b>7.1.1</b> As Mixtures of State-Dependent Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="fdp.html"><a href="fdp.html#forecast-distributions"><i class="fa fa-check"></i><b>7.2</b> Forecast Distributions</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="fdp.html"><a href="fdp.html#as-mixtures-of-state-dependent-probabilities-1"><i class="fa fa-check"></i><b>7.2.1</b> As Mixtures of State-Dependent Probabilities</a></li>
<li class="chapter" data-level="7.2.2" data-path="fdp.html"><a href="fdp.html#forecast-distribution-in-the-limit"><i class="fa fa-check"></i><b>7.2.2</b> Forecast Distribution in the Limit</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="fdp.html"><a href="fdp.html#decoding"><i class="fa fa-check"></i><b>7.3</b> Decoding</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="fdp.html"><a href="fdp.html#local-decoding"><i class="fa fa-check"></i><b>7.3.1</b> Local Decoding</a></li>
<li class="chapter" data-level="7.3.2" data-path="fdp.html"><a href="fdp.html#global-decoding"><i class="fa fa-check"></i><b>7.3.2</b> Global Decoding</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="fdp.html"><a href="fdp.html#state-prediction"><i class="fa fa-check"></i><b>7.4</b> State Prediction</a></li>
<li class="chapter" data-level="7.5" data-path="fdp.html"><a href="fdp.html#exercises-4"><i class="fa fa-check"></i><b>7.5</b> Exercises</a></li>
<li class="chapter" data-level="7.6" data-path="fdp.html"><a href="fdp.html#solutions-4"><i class="fa fa-check"></i><b>7.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html"><i class="fa fa-check"></i><b>8</b> Bayesian Inference for HMMs</a>
<ul>
<li class="chapter" data-level="8.1" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#reparameterization-to-avoid-label-switching"><i class="fa fa-check"></i><b>8.1</b> Reparameterization to Avoid Label Switching</a></li>
<li class="chapter" data-level="8.2" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#gibbs-sampling-procedure"><i class="fa fa-check"></i><b>8.2</b> Gibbs Sampling Procedure</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#gen"><i class="fa fa-check"></i><b>8.2.1</b> Generating Sample Paths of the MC</a></li>
<li class="chapter" data-level="8.2.2" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#decom"><i class="fa fa-check"></i><b>8.2.2</b> Decomposing the Observed Counts into Regime Contributions</a></li>
<li class="chapter" data-level="8.2.3" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#updating-the-parameters"><i class="fa fa-check"></i><b>8.2.3</b> Updating the Parameters</a></li>
<li class="chapter" data-level="8.2.4" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#repeat-the-above"><i class="fa fa-check"></i><b>8.2.4</b> Repeat the Above</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="bayesian-inference-for-hmms.html"><a href="bayesian-inference-for-hmms.html#exercises-5"><i class="fa fa-check"></i><b>8.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="eq.html"><a href="eq.html"><i class="fa fa-check"></i><b>9</b> Major Earthquake Analysis</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="eq.html"><a href="eq.html#fitting-a-poisson-mixture-distribution"><i class="fa fa-check"></i><b>9.0.1</b> Fitting a Poisson Mixture Distribution</a></li>
<li class="chapter" data-level="9.0.2" data-path="eq.html"><a href="eq.html#fitting-a-poisson-hmm-by-numerical-maximization"><i class="fa fa-check"></i><b>9.0.2</b> Fitting a Poisson-HMM by Numerical Maximization</a></li>
<li class="chapter" data-level="9.0.3" data-path="eq.html"><a href="eq.html#fitting-a-poisson-hmm-by-the-em-algorithm"><i class="fa fa-check"></i><b>9.0.3</b> Fitting a Poisson-HMM by the EM Algorithm</a></li>
<li class="chapter" data-level="9.0.4" data-path="eq.html"><a href="eq.html#forecasting-decoding-and-state-prediction"><i class="fa fa-check"></i><b>9.0.4</b> Forecasting, Decoding, and State Prediction</a></li>
<li class="chapter" data-level="9.1" data-path="eq.html"><a href="eq.html#bayesian-inference-in-stan"><i class="fa fa-check"></i><b>9.1</b> Bayesian Inference in STAN</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>10</b> Appendix</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hidden Markov Model Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="eq" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Major Earthquake Analysis<a href="eq.html#eq" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We apply the concepts in the earlier chapters to the series of annual counts of major earthquakes (i.e. magnitude 7 and above) dataset from the textbook.</p>
<p>The data can be read into <strong>R</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="eq.html#cb23-1" aria-hidden="true" tabindex="-1"></a>eq_dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;http://www.hmms-for-time-series.de/second/data/earthquakes.txt&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:e1"></span>
<img src="08-earthquake-example_files/figure-html/e1-1.png" alt="Number of major earthquakes worldwide from 1900-2006." width="672" />
<p class="caption">
Figure 9.1: Number of major earthquakes worldwide from 1900-2006.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:e2"></span>
<img src="08-earthquake-example_files/figure-html/e2-1.png" alt="Histogram of major earthquakes overlaid with a Poisson density of mean equal to the observed counts." width="672" />
<p class="caption">
Figure 9.2: Histogram of major earthquakes overlaid with a Poisson density of mean equal to the observed counts.
</p>
</div>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:e4">Table 9.1: </span>Summary of the major earthquakes.
</caption>
<thead>
<tr>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
variance
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
19.36
</td>
<td style="text-align:right;">
51.57
</td>
</tr>
</tbody>
</table>
<div id="fitting-a-poisson-mixture-distribution" class="section level3 hasAnchor" number="9.0.1">
<h3><span class="header-section-number">9.0.1</span> Fitting a Poisson Mixture Distribution<a href="eq.html#fitting-a-poisson-mixture-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Note:</strong> See <a href="prelim.html#prelim">Preliminaries</a></p>
<p>We may consider fitting a Poisson mixture distribution since earthquake counts are unbounded and there appears to be overdispersion as evident by the multimodal peaks in Figure <a href="eq.html#fig:e2">9.2</a> and sample variance <span class="math inline">\(s^2 \approx 52 &gt; 19 \approx \bar{x}\)</span> in Table <a href="eq.html#tab:e4">9.1</a>.</p>
<p>Suppose <span class="math inline">\(m=3\)</span> and the three components are Poisson-distributed with means <span class="math inline">\(\lambda_1, \lambda_2\)</span>, and <span class="math inline">\(\lambda_3\)</span>. Let <span class="math inline">\(\delta_1\)</span>, <span class="math inline">\(\delta_2\)</span>, and <span class="math inline">\(\delta_3\)</span> be the respective mixing parameters. The mixture distribution <span class="math inline">\(p\)</span> is given by</p>
<p><span class="math display">\[p(x) = \delta_1 \frac{\lambda_1^x e^{-\lambda_1}}{x!} + \delta_2 \frac{\lambda_2^x e^{-\lambda_2}}{x!} + \delta_3 \frac{\lambda_3^x e^{-\lambda_3}}{x!}\]</span></p>
<p>The likelihood is given by</p>
<p><span class="math display">\[L(\lambda_1, \lambda_2, \lambda_3, \delta_1, \delta_2|x_1, \dots, x_n) = \prod_{i=1}^n \left( \delta_1 \frac{\lambda_1^{x_i} e^{-\lambda_1}}{x_i!} + \delta_2 \frac{\lambda_2^{x_i} e^{-\lambda_2}}{x_i!} + (1 - \delta_1 - \delta_2) \frac{\lambda_3^{x_i} e^{-\lambda_3}}{x_i!} \right)\]</span></p>
<p>The log-likelihood can be maximized using an unconstrained optimizer <code>nlm</code> (in <strong>R</strong>) on reparameterized parameters by the following:</p>
<p><strong>Step 1</strong>: Reparameterize the “natural parameters” <span class="math inline">\(\boldsymbol{\delta}\)</span> and <span class="math inline">\(\boldsymbol{\lambda}\)</span> into “working parameters” <span class="math inline">\(\eta_i = \log \lambda_i \qquad{(i = 1, \dots, m)}\)</span> and <span class="math inline">\(\tau_i = \log \left(\frac{\delta_i}{1 - \sum_{j=2}^m \delta_j}\right) (i = 2, \dots, m)\)</span></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="eq.html#cb24-1" aria-hidden="true" tabindex="-1"></a>n2w <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, delta)<span class="fu">log</span>(<span class="fu">c</span>(lambda, delta[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">sum</span>(delta[<span class="sc">-</span><span class="dv">1</span>]))))</span></code></pre></div>
<p><strong>Step 2</strong>: Compute the negative log-likelihood using the working parameters</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="eq.html#cb25-1" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> <span class="cf">function</span>(wpar, x){</span>
<span id="cb25-2"><a href="eq.html#cb25-2" aria-hidden="true" tabindex="-1"></a>  zzz <span class="ot">&lt;-</span> <span class="fu">w2n</span>(wpar)</span>
<span id="cb25-3"><a href="eq.html#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">log</span>(<span class="fu">outer</span>(x, zzz<span class="sc">$</span>lambda, dpois)<span class="sc">%*%</span>zzz<span class="sc">$</span>delta))}</span></code></pre></div>
<p><strong>Step 3</strong>: Transform the parameters back into natural parameters</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="eq.html#cb26-1" aria-hidden="true" tabindex="-1"></a>w2n <span class="ot">&lt;-</span> <span class="cf">function</span>(wpar){</span>
<span id="cb26-2"><a href="eq.html#cb26-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> (<span class="fu">length</span>(wpar)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb26-3"><a href="eq.html#cb26-3" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(wpar[<span class="dv">1</span><span class="sc">:</span>m])</span>
<span id="cb26-4"><a href="eq.html#cb26-4" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">c</span>(<span class="dv">0</span>, wpar[(m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>m<span class="dv">-1</span>)]))</span>
<span id="cb26-5"><a href="eq.html#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda, <span class="at">delta=</span>delta<span class="sc">/</span><span class="fu">sum</span>(delta)))}</span></code></pre></div>
<p>Hence, for a Poisson mixture distribution with means <span class="math inline">\(\lambda_1, = 10, \lambda_2 = 20, \lambda_3 = 25\)</span> and probabilities <span class="math inline">\(\delta_1 = \delta_2 = \delta_3 = \frac{1}{3}\)</span>,</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="eq.html#cb27-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> eq_dat<span class="sc">$</span>V2</span>
<span id="cb27-2"><a href="eq.html#cb27-2" aria-hidden="true" tabindex="-1"></a>wpar <span class="ot">&lt;-</span> <span class="fu">n2w</span>(<span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">25</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">/</span><span class="dv">3</span>)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="eq.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">w2n</span>(<span class="fu">nlm</span>(mllk, wpar, x)<span class="sc">$</span>estimate)</span></code></pre></div>
<p>we obtain the following parameter estimates</p>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-8">Table 9.2: </span>Parameter estimates for the fitted three component Poisson independent mixture model.
</caption>
<thead>
<tr>
<th style="text-align:right;">
lambda
</th>
<th style="text-align:right;">
delta
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
12.73573
</td>
<td style="text-align:right;">
0.2775329
</td>
</tr>
<tr>
<td style="text-align:right;">
19.78515
</td>
<td style="text-align:right;">
0.5928037
</td>
</tr>
<tr>
<td style="text-align:right;">
31.62940
</td>
<td style="text-align:right;">
0.1296634
</td>
</tr>
</tbody>
</table>
<p>and the negative log likelihood</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="eq.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlm</span>(mllk, wpar, x)<span class="sc">$</span>minimum</span></code></pre></div>
<pre><code>## [1] 356.8489</code></pre>
<p><strong>Note:</strong> See Table 1.2 and Figure 1.4 of the textbook for a comparison of fitted mixture models with varying number of components.</p>
</div>
<div id="fitting-a-poisson-hmm-by-numerical-maximization" class="section level3 hasAnchor" number="9.0.2">
<h3><span class="header-section-number">9.0.2</span> Fitting a Poisson-HMM by Numerical Maximization<a href="eq.html#fitting-a-poisson-hmm-by-numerical-maximization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Note:</strong> See <a href="introhmm.html#introhmm">Introduction to Hidden Markov Models</a> and Appendix A of the textbook.</p>
<div class="figure"><span style="display:block;" id="fig:acf"></span>
<img src="08-earthquake-example_files/figure-html/acf-1.png" alt="Autocorrelation plot for major earthquakes." width="672" />
<p class="caption">
Figure 9.3: Autocorrelation plot for major earthquakes.
</p>
</div>
<p>Instead of fitting an (independent) Poisson mixture distribution, we may consider fitting a Poisson-HMM to account for the strong, positive serial dependence as evident in Figure <a href="eq.html#fig:acf">9.3</a>.</p>
<p><strong>Step 1:</strong> Reparameterize the “natural parameters” <span class="math inline">\(\boldsymbol{\Gamma}, \boldsymbol{\lambda}\)</span>, and <span class="math inline">\(\boldsymbol{\delta}\)</span> to the “working parameters”.</p>
<p>Set
<span class="math display">\[\eta_i = \log \lambda_i \qquad{(i = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\nu_{ij} = \begin{cases} 1 &amp; \qquad{\text{for } i = j} \\ \log(\gamma_{ij}) &amp; \qquad{\text{for } i \neq j} \end{cases}\]</span></p>
<p><span class="math display">\[\delta_i = \begin{cases} \log \left(\frac{(\delta_2, \dots, \delta_m)}{\delta_1}\right) &amp; \qquad{\text{if not stationary}}\\ \text{NULL} &amp; \qquad{\text{otherwise}} \end{cases}\]</span></p>
<p>See <a href="numerical.html#reparam">Reparameterization to Avoid Constraints</a>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="eq.html#cb31-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.pn2pw <span class="ot">&lt;-</span> <span class="cf">function</span>(m,lambda,gamma,<span class="at">delta=</span><span class="cn">NULL</span>,<span class="at">stationary=</span><span class="cn">TRUE</span>){ </span>
<span id="cb31-2"><a href="eq.html#cb31-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-3"><a href="eq.html#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># eta = log(lambda)</span></span>
<span id="cb31-4"><a href="eq.html#cb31-4" aria-hidden="true" tabindex="-1"></a>  tlambda <span class="ot">&lt;-</span> <span class="fu">log</span>(lambda)</span>
<span id="cb31-5"><a href="eq.html#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(tlambda)</span>
<span id="cb31-6"><a href="eq.html#cb31-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb31-7"><a href="eq.html#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For i = j, nu_ii = 1 </span></span>
<span id="cb31-8"><a href="eq.html#cb31-8" aria-hidden="true" tabindex="-1"></a>  foo     <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma<span class="sc">/</span><span class="fu">diag</span>(gamma))</span>
<span id="cb31-9"><a href="eq.html#cb31-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-10"><a href="eq.html#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For i != j, nu_ij = log(gamma_ij)</span></span>
<span id="cb31-11"><a href="eq.html#cb31-11" aria-hidden="true" tabindex="-1"></a>  tgamma  <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(foo[<span class="sc">!</span><span class="fu">diag</span>(m)])</span>
<span id="cb31-12"><a href="eq.html#cb31-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-13"><a href="eq.html#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If stationary, set to pi = null</span></span>
<span id="cb31-14"><a href="eq.html#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stationary) {tdelta  <span class="ot">&lt;-</span> <span class="cn">NULL</span>}</span>
<span id="cb31-15"><a href="eq.html#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, pi = log((delta_2, ..., delta_m)/delta_1)</span></span>
<span id="cb31-16"><a href="eq.html#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {tdelta <span class="ot">&lt;-</span> <span class="fu">log</span>(delta[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">/</span>delta[<span class="dv">1</span>])}</span>
<span id="cb31-17"><a href="eq.html#cb31-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb31-18"><a href="eq.html#cb31-18" aria-hidden="true" tabindex="-1"></a>  parvect <span class="ot">&lt;-</span> <span class="fu">c</span>(tlambda,tgamma,tdelta)</span>
<span id="cb31-19"><a href="eq.html#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(parvect)</span>
<span id="cb31-20"><a href="eq.html#cb31-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.pn2pw</code> takes in arguments <code>m</code> number of states (numeric), <code>lambda</code> Poisson means (vector), <code>delta</code> initial probabilities, and <code>stationary</code> (<code>TRUE/FALSE</code>). By default, the MC is assumed to be stationary with the initial distribution equal to the stationary distribution. The function returns a vector containing the working parameters.</p>
<p><strong>Step 2:</strong> Compute the log-likelihood by the forward algorithm using the scaling strategy.</p>
<p>The general algorithm is:</p>
<p><span class="math inline">\(w_1 \leftarrow \boldsymbol{\delta P} (x_1) \boldsymbol{1&#39;};\)</span> <span class="math inline">\(\boldsymbol{\phi}_1 \leftarrow \boldsymbol{\delta P} (x_1);\)</span> <span class="math inline">\(l \leftarrow \log w_1\)</span></p>
<p>for <span class="math inline">\(t=2, 3, \dots, T\)</span></p>
<p><span class="math display">\[\begin{align}
\boldsymbol{v}
&amp;\leftarrow \boldsymbol{\phi}_{t-1} \boldsymbol{\Gamma P} (x_t)\\
u &amp; \leftarrow \boldsymbol{v 1&#39;}\\
l &amp;\leftarrow l + \log u\\
\boldsymbol{\phi}_t &amp; \leftarrow \frac{\boldsymbol{v}}{u}
\end{align}\]</span></p>
<p>See <a href="numerical.html#likscale">Scaling the Likelihood Computation</a> and Note (4).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="eq.html#cb32-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.lforward <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod){</span>
<span id="cb32-2"><a href="eq.html#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="eq.html#cb32-3" aria-hidden="true" tabindex="-1"></a>  n             <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb32-4"><a href="eq.html#cb32-4" aria-hidden="true" tabindex="-1"></a>  lalpha        <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,mod<span class="sc">$</span>m,n)</span>
<span id="cb32-5"><a href="eq.html#cb32-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-6"><a href="eq.html#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># At time t=1</span></span>
<span id="cb32-7"><a href="eq.html#cb32-7" aria-hidden="true" tabindex="-1"></a>  foo           <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb32-8"><a href="eq.html#cb32-8" aria-hidden="true" tabindex="-1"></a>  sumfoo        <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb32-9"><a href="eq.html#cb32-9" aria-hidden="true" tabindex="-1"></a>  lscale        <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb32-10"><a href="eq.html#cb32-10" aria-hidden="true" tabindex="-1"></a>  foo           <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb32-11"><a href="eq.html#cb32-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-12"><a href="eq.html#cb32-12" aria-hidden="true" tabindex="-1"></a>  lalpha[,<span class="dv">1</span>]    <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(foo)</span>
<span id="cb32-13"><a href="eq.html#cb32-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-14"><a href="eq.html#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For t &gt; 1</span></span>
<span id="cb32-15"><a href="eq.html#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb32-16"><a href="eq.html#cb32-16" aria-hidden="true" tabindex="-1"></a>    foo          <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb32-17"><a href="eq.html#cb32-17" aria-hidden="true" tabindex="-1"></a>    sumfoo       <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb32-18"><a href="eq.html#cb32-18" aria-hidden="true" tabindex="-1"></a>    lscale       <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb32-19"><a href="eq.html#cb32-19" aria-hidden="true" tabindex="-1"></a>    foo          <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb32-20"><a href="eq.html#cb32-20" aria-hidden="true" tabindex="-1"></a>    lalpha[,i]   <span class="ot">&lt;-</span> <span class="fu">log</span>(foo)<span class="sc">+</span>lscale</span>
<span id="cb32-21"><a href="eq.html#cb32-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-22"><a href="eq.html#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(lalpha)</span>
<span id="cb32-23"><a href="eq.html#cb32-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.lforward</code> takes in arguments <code>x</code> data and <code>mod</code> list consisting of <code>m</code> states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities.</p>
<p><strong>Step 3:</strong> Maximize the log-likelihood/Minimize the negative log-likelihood</p>
<p>The function <code>nlm</code> in <strong>R</strong> performs the minimization of any function using a Newton-type algorithm. In order to minimize the negative log-likelihood, we first write a function that compute the negative log-likelihood from the working parameters. The same forward algorithm scheme applies.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="eq.html#cb33-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.mllk <span class="ot">&lt;-</span> <span class="cf">function</span>(parvect,x,m,<span class="at">stationary=</span><span class="cn">TRUE</span>,...)</span>
<span id="cb33-2"><a href="eq.html#cb33-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb33-3"><a href="eq.html#cb33-3" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(<span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(x,<span class="fu">exp</span>(parvect),<span class="at">log=</span><span class="cn">TRUE</span>)))</span>
<span id="cb33-4"><a href="eq.html#cb33-4" aria-hidden="true" tabindex="-1"></a> n        <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb33-5"><a href="eq.html#cb33-5" aria-hidden="true" tabindex="-1"></a> pn       <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pw2pn</span>(m,parvect,<span class="at">stationary=</span>stationary)</span>
<span id="cb33-6"><a href="eq.html#cb33-6" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> pn<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],pn<span class="sc">$</span>lambda)</span>
<span id="cb33-7"><a href="eq.html#cb33-7" aria-hidden="true" tabindex="-1"></a> sumfoo   <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb33-8"><a href="eq.html#cb33-8" aria-hidden="true" tabindex="-1"></a> lscale   <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb33-9"><a href="eq.html#cb33-9" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb33-10"><a href="eq.html#cb33-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb33-11"><a href="eq.html#cb33-11" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb33-12"><a href="eq.html#cb33-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(x[i])){P<span class="ot">&lt;-</span><span class="fu">dpois</span>(x[i],pn<span class="sc">$</span>lambda)}</span>
<span id="cb33-13"><a href="eq.html#cb33-13" aria-hidden="true" tabindex="-1"></a>     <span class="cf">else</span> {P<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span>,m)}</span>
<span id="cb33-14"><a href="eq.html#cb33-14" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo <span class="sc">%*%</span> pn<span class="sc">$</span>gamma<span class="sc">*</span>P</span>
<span id="cb33-15"><a href="eq.html#cb33-15" aria-hidden="true" tabindex="-1"></a>   sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb33-16"><a href="eq.html#cb33-16" aria-hidden="true" tabindex="-1"></a>   lscale <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb33-17"><a href="eq.html#cb33-17" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb33-18"><a href="eq.html#cb33-18" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb33-19"><a href="eq.html#cb33-19" aria-hidden="true" tabindex="-1"></a> mllk     <span class="ot">&lt;-</span> <span class="sc">-</span>lscale</span>
<span id="cb33-20"><a href="eq.html#cb33-20" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(mllk)</span>
<span id="cb33-21"><a href="eq.html#cb33-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Step 4</strong>: Transform the parameters back into natural parameters.</p>
<p>Set</p>
<p><span class="math display">\[\hat{\lambda_i} = \exp(\hat{\eta_i}) \qquad{(i = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\hat{\gamma}_{ij} = \frac{\exp(\hat{\nu_{ik}})}{\sum_{k=1, k \neq i}^m\exp(\hat{\nu_ik})} \qquad{\text{for } (i, j = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\hat{\boldsymbol{\delta}} = \begin{cases} \boldsymbol{1} (\boldsymbol{I} - \hat{\boldsymbol{\Gamma}} + \boldsymbol{U})^{-1}&amp; \qquad{\text{if stationary}}\\ \frac{(1, \exp(\hat{\delta_2}), \dots, \exp(\hat{\delta}_m))}{1 + \exp(\hat{\delta_2}) + \dots + \exp(\hat{\delta}_m)} &amp; \qquad{\text{otherwise}} \end{cases}\]</span></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="eq.html#cb34-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.pw2pn <span class="ot">&lt;-</span> <span class="cf">function</span>(m,parvect,<span class="at">stationary=</span><span class="cn">TRUE</span>){</span>
<span id="cb34-2"><a href="eq.html#cb34-2" aria-hidden="true" tabindex="-1"></a> lambda        <span class="ot">&lt;-</span> <span class="fu">exp</span>(parvect[<span class="dv">1</span><span class="sc">:</span>m])</span>
<span id="cb34-3"><a href="eq.html#cb34-3" aria-hidden="true" tabindex="-1"></a> gamma         <span class="ot">&lt;-</span> <span class="fu">diag</span>(m)</span>
<span id="cb34-4"><a href="eq.html#cb34-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda,<span class="at">gamma=</span>gamma,<span class="at">delta=</span><span class="dv">1</span>))</span>
<span id="cb34-5"><a href="eq.html#cb34-5" aria-hidden="true" tabindex="-1"></a> gamma[<span class="sc">!</span>gamma] <span class="ot">&lt;-</span> <span class="fu">exp</span>(parvect[(m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(m<span class="sc">*</span>m)])</span>
<span id="cb34-6"><a href="eq.html#cb34-6" aria-hidden="true" tabindex="-1"></a> gamma         <span class="ot">&lt;-</span> gamma<span class="sc">/</span><span class="fu">apply</span>(gamma,<span class="dv">1</span>,sum)</span>
<span id="cb34-7"><a href="eq.html#cb34-7" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(stationary){delta<span class="ot">&lt;-</span><span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">diag</span>(m)<span class="sc">-</span>gamma<span class="sc">+</span><span class="dv">1</span>),<span class="fu">rep</span>(<span class="dv">1</span>,m))}</span>
<span id="cb34-8"><a href="eq.html#cb34-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> {foo<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">exp</span>(parvect[(m<span class="sc">*</span>m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(m<span class="sc">*</span>m<span class="sc">+</span>m<span class="dv">-1</span>)]))</span>
<span id="cb34-9"><a href="eq.html#cb34-9" aria-hidden="true" tabindex="-1"></a>   delta<span class="ot">&lt;-</span>foo<span class="sc">/</span><span class="fu">sum</span>(foo)}</span>
<span id="cb34-10"><a href="eq.html#cb34-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda,<span class="at">gamma=</span>gamma,<span class="at">delta=</span>delta))</span>
<span id="cb34-11"><a href="eq.html#cb34-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.pw2pn</code> takes in arguments <code>m</code> number of states, <code>parvect</code> working parameters (vector), and <code>stationary</code> (<code>TRUE/FALSE</code>). By default, the MC is assumed to be stationary with the initial distribution equal to the stationary distribution. The function returns a list containing the natural parameters.</p>
<p>Then putting everything together</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="eq.html#cb35-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.mle <span class="ot">&lt;-</span> <span class="cf">function</span>(x,m,lambda0,gamma0,<span class="at">delta0=</span><span class="cn">NULL</span>,<span class="at">stationary=</span><span class="cn">TRUE</span>,...){</span>
<span id="cb35-2"><a href="eq.html#cb35-2" aria-hidden="true" tabindex="-1"></a> parvect0  <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m,lambda0,gamma0,delta0,<span class="at">stationary=</span>stationary)</span>
<span id="cb35-3"><a href="eq.html#cb35-3" aria-hidden="true" tabindex="-1"></a> mod       <span class="ot">&lt;-</span> <span class="fu">nlm</span>(pois.HMM.mllk,parvect0,<span class="at">x=</span>x,<span class="at">m=</span>m,<span class="at">stationary=</span>stationary)</span>
<span id="cb35-4"><a href="eq.html#cb35-4" aria-hidden="true" tabindex="-1"></a> pn        <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pw2pn</span>(<span class="at">m=</span>m,mod<span class="sc">$</span>estimate,<span class="at">stationary=</span>stationary)</span>
<span id="cb35-5"><a href="eq.html#cb35-5" aria-hidden="true" tabindex="-1"></a> mllk      <span class="ot">&lt;-</span> mod<span class="sc">$</span>minimum</span>
<span id="cb35-6"><a href="eq.html#cb35-6" aria-hidden="true" tabindex="-1"></a> np        <span class="ot">&lt;-</span> <span class="fu">length</span>(parvect0)</span>
<span id="cb35-7"><a href="eq.html#cb35-7" aria-hidden="true" tabindex="-1"></a> AIC       <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>(mllk<span class="sc">+</span>np)</span>
<span id="cb35-8"><a href="eq.html#cb35-8" aria-hidden="true" tabindex="-1"></a> n         <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(x))</span>
<span id="cb35-9"><a href="eq.html#cb35-9" aria-hidden="true" tabindex="-1"></a> BIC       <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>mllk<span class="sc">+</span>np<span class="sc">*</span><span class="fu">log</span>(n)</span>
<span id="cb35-10"><a href="eq.html#cb35-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">list</span>(<span class="at">m=</span>m,<span class="at">lambda=</span>pn<span class="sc">$</span>lambda,<span class="at">gamma=</span>pn<span class="sc">$</span>gamma,<span class="at">delta=</span>pn<span class="sc">$</span>delta,<span class="at">code=</span>mod<span class="sc">$</span>code,<span class="at">mllk=</span>mllk,<span class="at">AIC=</span>AIC,<span class="at">BIC=</span>BIC)</span>
<span id="cb35-11"><a href="eq.html#cb35-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Hence, for a three-state Poisson-HMM with parameters <span class="math inline">\(\boldsymbol{\lambda} = (10, 20, 25)\)</span>, <span class="math inline">\(\boldsymbol{\Gamma} = \begin{pmatrix} 0.8 &amp; 0.1 &amp; 0.1\\ 0.1 &amp; 0.8 &amp; 0.1\\ 0.1 &amp; 0.1 &amp; 0.8 \end{pmatrix}\)</span>,</p>
<p>if we assume that the MC is stationary</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="eq.html#cb36-1" aria-hidden="true" tabindex="-1"></a>eq_init <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span><span class="dv">3</span>, </span>
<span id="cb36-2"><a href="eq.html#cb36-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">lambda=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">25</span>), </span>
<span id="cb36-3"><a href="eq.html#cb36-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">gamma =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.8</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.8</span>),<span class="dv">3</span>,<span class="dv">3</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb36-4"><a href="eq.html#cb36-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">delta=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb36-5"><a href="eq.html#cb36-5" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb36-6"><a href="eq.html#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="eq.html#cb36-7" aria-hidden="true" tabindex="-1"></a>(mod3s<span class="ot">&lt;-</span><span class="fu">pois.HMM.mle</span>(x,eq_init<span class="sc">$</span>m,eq_init<span class="sc">$</span>lambda,eq_init<span class="sc">$</span>gamma,<span class="at">stationary=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.14573 19.72101 29.71437
## 
## $gamma
##              [,1]      [,2]       [,3]
## [1,] 9.546243e-01 0.0244426 0.02093313
## [2,] 4.976679e-02 0.8993673 0.05086592
## [3,] 1.504495e-09 0.1966420 0.80335799
## 
## $delta
## [1] 0.4436420 0.4044983 0.1518597
## 
## $code
## [1] 1
## 
## $mllk
## [1] 329.4603
## 
## $AIC
## [1] 676.9206
## 
## $BIC
## [1] 700.976</code></pre>
<p>if we do not assume stationary and that <span class="math inline">\(\boldsymbol{\delta} = (\frac{1}{3}, \frac{1}{3}, \frac{1}{3})\)</span></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="eq.html#cb38-1" aria-hidden="true" tabindex="-1"></a>(mod3h <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(x,eq_init<span class="sc">$</span>m,eq_init<span class="sc">$</span>lambda,eq_init<span class="sc">$</span>gamma,<span class="at">delta=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">/</span><span class="dv">3</span>,<span class="at">stationary=</span><span class="cn">FALSE</span>))</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.13374 19.71312 29.70964
## 
## $gamma
##              [,1]       [,2]       [,3]
## [1,] 9.392937e-01 0.03209754 0.02860881
## [2,] 4.040106e-02 0.90643731 0.05316163
## [3,] 9.052023e-12 0.19025401 0.80974599
## 
## $delta
## [1] 9.999998e-01 8.700482e-08 8.281945e-08
## 
## $code
## [1] 1
## 
## $mllk
## [1] 328.5275
## 
## $AIC
## [1] 679.055
## 
## $BIC
## [1] 708.4561</code></pre>
<p>We can also perform parameteric bootstrapping to obtain confidence intervals.</p>
<p><strong>Note:</strong> See <a href="numerical.html#boot">Obtaining Standard Errors and Confidence Intervals</a>.</p>
<p><strong>Step 1</strong>: Fit the model</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="eq.html#cb40-1" aria-hidden="true" tabindex="-1"></a>eq_mle <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(x,eq_init<span class="sc">$</span>m,eq_init<span class="sc">$</span>lambda,eq_init<span class="sc">$</span>gamma,<span class="at">delta=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">/</span><span class="dv">3</span>,<span class="at">stationary=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><strong>Step 2</strong>: Generate a bootstrap sample from the fitted model.</p>
<p>The following function generates a sample from a Poisson-HMM of length <code>ns</code> from starting values <code>m</code> number of states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities which are stored as <code>mod</code> (list).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="eq.html#cb41-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_sample  <span class="ot">&lt;-</span> <span class="cf">function</span>(ns,mod){</span>
<span id="cb41-2"><a href="eq.html#cb41-2" aria-hidden="true" tabindex="-1"></a> mvect                    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m</span>
<span id="cb41-3"><a href="eq.html#cb41-3" aria-hidden="true" tabindex="-1"></a> state                    <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ns)</span>
<span id="cb41-4"><a href="eq.html#cb41-4" aria-hidden="true" tabindex="-1"></a> state[<span class="dv">1</span>]                 <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect,<span class="dv">1</span>,<span class="at">prob=</span>mod<span class="sc">$</span>delta)</span>
<span id="cb41-5"><a href="eq.html#cb41-5" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ns) state[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect,<span class="dv">1</span>,<span class="at">prob=</span>mod<span class="sc">$</span>gamma[state[i<span class="dv">-1</span>],])</span>
<span id="cb41-6"><a href="eq.html#cb41-6" aria-hidden="true" tabindex="-1"></a> x                        <span class="ot">&lt;-</span> <span class="fu">rpois</span>(ns,<span class="at">lambda=</span>mod<span class="sc">$</span>lambda[state])</span>
<span id="cb41-7"><a href="eq.html#cb41-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(x)</span>
<span id="cb41-8"><a href="eq.html#cb41-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="eq.html#cb42-1" aria-hidden="true" tabindex="-1"></a>boot_sample <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="fu">length</span>(x), eq_mle)</span></code></pre></div>
<p><strong>Step 3</strong>: Estimate parameters using the bootstrap sample.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="eq.html#cb43-1" aria-hidden="true" tabindex="-1"></a>boot_mle <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(boot_sample, eq_mle<span class="sc">$</span>m, eq_mle<span class="sc">$</span>lambda, eq_mle<span class="sc">$</span>gamma)</span></code></pre></div>
<p><strong>Step 4</strong>: Repeat (for a large) B times.</p>
<p>Then putting everything together</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="eq.html#cb44-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.boot <span class="ot">&lt;-</span> <span class="cf">function</span>(B, x, m, lambda0, gamma0, <span class="at">delta0=</span><span class="cn">NULL</span>, <span class="at">stationary=</span><span class="cn">TRUE</span>){</span>
<span id="cb44-2"><a href="eq.html#cb44-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-3"><a href="eq.html#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model</span></span>
<span id="cb44-4"><a href="eq.html#cb44-4" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(x, m, lambda0, gamma0, <span class="at">stationary=</span>stationary)</span>
<span id="cb44-5"><a href="eq.html#cb44-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-6"><a href="eq.html#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize</span></span>
<span id="cb44-7"><a href="eq.html#cb44-7" aria-hidden="true" tabindex="-1"></a>  bs_sample <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb44-8"><a href="eq.html#cb44-8" aria-hidden="true" tabindex="-1"></a>  bs_mod <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb44-9"><a href="eq.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-10"><a href="eq.html#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate B bootstrap samples</span></span>
<span id="cb44-11"><a href="eq.html#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb44-12"><a href="eq.html#cb44-12" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb44-13"><a href="eq.html#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(a){</span>
<span id="cb44-14"><a href="eq.html#cb44-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb44-15"><a href="eq.html#cb44-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(i)</span>
<span id="cb44-16"><a href="eq.html#cb44-16" aria-hidden="true" tabindex="-1"></a>        bs_sample[[i]] <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="fu">length</span>(x), mod)</span>
<span id="cb44-17"><a href="eq.html#cb44-17" aria-hidden="true" tabindex="-1"></a>        bs_mod[[i]] <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(bs_sample[[i]], m, mod<span class="sc">$</span>lambda, mod<span class="sc">$</span>gamma, mod<span class="sc">$</span>delta)</span>
<span id="cb44-18"><a href="eq.html#cb44-18" aria-hidden="true" tabindex="-1"></a>        a <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb44-19"><a href="eq.html#cb44-19" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb44-20"><a href="eq.html#cb44-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">error=</span><span class="cf">function</span>(w){</span>
<span id="cb44-21"><a href="eq.html#cb44-21" aria-hidden="true" tabindex="-1"></a>          a <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb44-22"><a href="eq.html#cb44-22" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb44-23"><a href="eq.html#cb44-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-24"><a href="eq.html#cb44-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-25"><a href="eq.html#cb44-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bs_mod)</span>
<span id="cb44-26"><a href="eq.html#cb44-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> Some errors would occasionally arise from solving the stationary distribution of bootstrap samples that may not have had a unique stationary distribution. To overcome this, the <code>tryCatch</code> function was used to throw out these problematic samples and regenerate a new sample. As there were at most two samples that resulted in the error, the generated bootstrap samples should still be representative of the dataset.</p>
<p>Hence,</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="eq.html#cb45-1" aria-hidden="true" tabindex="-1"></a>eq_boot <span class="ot">&lt;-</span> <span class="fu">pois.HMM.boot</span>(<span class="dv">500</span>, x, eq_init<span class="sc">$</span>m, eq_init<span class="sc">$</span>lambda, eq_init<span class="sc">$</span>gamma)</span></code></pre></div>
<p>and the <span class="math inline">\(90\%\)</span> confidence interval using the “percentile method”</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="eq.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe for parameters from bootstrap samples</span></span>
<span id="cb46-2"><a href="eq.html#cb46-2" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">2</span>)</span>
<span id="cb46-3"><a href="eq.html#cb46-3" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_lambda_boot)</span>
<span id="cb46-4"><a href="eq.html#cb46-4" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_lambda_boot)</span>
<span id="cb46-5"><a href="eq.html#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="eq.html#cb46-6" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">3</span>)</span>
<span id="cb46-7"><a href="eq.html#cb46-7" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_gamma_boot)</span>
<span id="cb46-8"><a href="eq.html#cb46-8" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_gamma_boot)</span>
<span id="cb46-9"><a href="eq.html#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="eq.html#cb46-10" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">4</span>)</span>
<span id="cb46-11"><a href="eq.html#cb46-11" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_delta_boot)</span>
<span id="cb46-12"><a href="eq.html#cb46-12" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_delta_boot)</span>
<span id="cb46-13"><a href="eq.html#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="eq.html#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the 90% confidence interval</span></span>
<span id="cb46-15"><a href="eq.html#cb46-15" aria-hidden="true" tabindex="-1"></a>eq_boot_df <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">cbind</span>(<span class="fu">sapply</span>(eq_lambda_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)),</span>
<span id="cb46-16"><a href="eq.html#cb46-16" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(eq_gamma_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)),</span>
<span id="cb46-17"><a href="eq.html#cb46-17" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(eq_delta_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb46-18"><a href="eq.html#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() </span>
<span id="cb46-19"><a href="eq.html#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="eq.html#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;lambda&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-21"><a href="eq.html#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-22"><a href="eq.html#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-23"><a href="eq.html#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-24"><a href="eq.html#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">13</span><span class="sc">:</span><span class="dv">15</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;delta&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-25"><a href="eq.html#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="eq.html#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="eq.html#cb46-27" aria-hidden="true" tabindex="-1"></a>eq_boot_df <span class="sc">%&gt;%</span></span>
<span id="cb46-28"><a href="eq.html#cb46-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-29"><a href="eq.html#cb46-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">&quot;Bootstrap 90% Confidence Intervals for the parameters of the three-state HMM.&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-30"><a href="eq.html#cb46-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_minimal</span>(<span class="at">full_width=</span>T)</span></code></pre></div>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-23">Table 9.3: </span>Bootstrap 90% Confidence Intervals for the parameters of the three-state HMM.
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
5%
</th>
<th style="text-align:right;">
95%
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
lambda1
</td>
<td style="text-align:right;">
11.8405
</td>
<td style="text-align:right;">
14.6116
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda2
</td>
<td style="text-align:right;">
16.9308
</td>
<td style="text-align:right;">
22.0249
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda3
</td>
<td style="text-align:right;">
19.4806
</td>
<td style="text-align:right;">
33.0097
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma11
</td>
<td style="text-align:right;">
0.8232
</td>
<td style="text-align:right;">
0.9880
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma12
</td>
<td style="text-align:right;">
0.0137
</td>
<td style="text-align:right;">
0.2132
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma13
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma21
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1162
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma22
</td>
<td style="text-align:right;">
0.6603
</td>
<td style="text-align:right;">
0.9637
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma23
</td>
<td style="text-align:right;">
0.0515
</td>
<td style="text-align:right;">
0.5534
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma31
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1108
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma32
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1908
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma33
</td>
<td style="text-align:right;">
0.4466
</td>
<td style="text-align:right;">
0.9485
</td>
</tr>
<tr>
<td style="text-align:left;">
delta1
</td>
<td style="text-align:right;">
0.1370
</td>
<td style="text-align:right;">
0.7485
</td>
</tr>
<tr>
<td style="text-align:left;">
delta2
</td>
<td style="text-align:right;">
0.1114
</td>
<td style="text-align:right;">
0.6606
</td>
</tr>
<tr>
<td style="text-align:left;">
delta3
</td>
<td style="text-align:right;">
0.0404
</td>
<td style="text-align:right;">
0.3770
</td>
</tr>
</tbody>
</table>
<div class="figure"><span style="display:block;" id="fig:boot"></span>
<img src="08-earthquake-example_files/figure-html/boot-1.png" alt="500 Bootstrap samples for the state-dependent parameters of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 9.4: 500 Bootstrap samples for the state-dependent parameters of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:boot3"></span>
<img src="08-earthquake-example_files/figure-html/boot3-1.png" alt="500 Bootstrap samples for the initial probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 9.5: 500 Bootstrap samples for the initial probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:boot2"></span>
<img src="08-earthquake-example_files/figure-html/boot2-1.png" alt="500 Bootstrap samples for the transition probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 9.6: 500 Bootstrap samples for the transition probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
<p>We can also fit the three-state Poisson-HMM from the above using the <code>momentuHMM</code> package.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="eq.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(momentuHMM)</span>
<span id="cb47-2"><a href="eq.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(eq_dat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;count&quot;</span>)</span></code></pre></div>
<p>The data must be converted into the <code>prepData</code> object to use <code>fitHMM</code>.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="eq.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dataframe into prepData object</span></span>
<span id="cb48-2"><a href="eq.html#cb48-2" aria-hidden="true" tabindex="-1"></a>eq_prepped <span class="ot">&lt;-</span> <span class="fu">prepData</span>(eq_dat,</span>
<span id="cb48-3"><a href="eq.html#cb48-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coordNames =</span> <span class="cn">NULL</span>,</span>
<span id="cb48-4"><a href="eq.html#cb48-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">covNames =</span>  <span class="fu">c</span>(<span class="st">&quot;count&quot;</span>))</span>
<span id="cb48-5"><a href="eq.html#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="eq.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the states</span></span>
<span id="cb48-7"><a href="eq.html#cb48-7" aria-hidden="true" tabindex="-1"></a>stateNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;state1&quot;</span>, <span class="st">&quot;state2&quot;</span>, <span class="st">&quot;state3&quot;</span>)</span>
<span id="cb48-8"><a href="eq.html#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="eq.html#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit intercept only model</span></span>
<span id="cb48-10"><a href="eq.html#cb48-10" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> <span class="er">~</span> <span class="dv">1</span></span>
<span id="cb48-11"><a href="eq.html#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="eq.html#cb48-12" aria-hidden="true" tabindex="-1"></a>eq_fit1 <span class="ot">&lt;-</span> <span class="fu">fitHMM</span>(eq_prepped, </span>
<span id="cb48-13"><a href="eq.html#cb48-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">nbStates=</span><span class="dv">3</span>, </span>
<span id="cb48-14"><a href="eq.html#cb48-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">dist=</span><span class="fu">list</span>(<span class="at">count=</span><span class="st">&quot;pois&quot;</span>),</span>
<span id="cb48-15"><a href="eq.html#cb48-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">Par0 =</span> <span class="fu">list</span>(<span class="at">count =</span> eq_init<span class="sc">$</span>lambda, <span class="at">delta=</span><span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>)<span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb48-16"><a href="eq.html#cb48-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">formula =</span> formula,</span>
<span id="cb48-17"><a href="eq.html#cb48-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">stateNames =</span> stateNames,</span>
<span id="cb48-18"><a href="eq.html#cb48-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">stationary =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-19"><a href="eq.html#cb48-19" aria-hidden="true" tabindex="-1"></a>eq_fit1</span></code></pre></div>
<pre><code>## Value of the maximum log-likelihood: -328.5884 
## 
## 
## count parameters:
## -----------------
##          state1   state2   state3
## lambda 13.13513 19.70822 29.70794
## 
## Regression coeffs for the transition probabilities:
## ---------------------------------------------------
##               1 -&gt; 2    1 -&gt; 3    2 -&gt; 1   2 -&gt; 3    3 -&gt; 1    3 -&gt; 2
## (Intercept) -3.42222 -3.520977 -3.119039 -2.83615 -28.60659 -1.448253
## 
## Transition probability matrix:
## ------------------------------
##              state1     state2     state3
## state1 9.414330e-01 0.03072828 0.02783867
## state2 4.007763e-02 0.90674107 0.05318130
## state3 3.052488e-13 0.19027062 0.80972938
## 
## Initial distribution:
## ---------------------
##       state1       state2       state3 
## 1.000000e+00 1.833456e-08 1.427794e-08</code></pre>
<p>The resulting MLEs are very similar to that obtained from running the functions from above.</p>
<p>A plot of the decoded states is shown below.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="eq.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(eq_fit1)</span></code></pre></div>
<pre><code>## Decoding state sequence... DONE</code></pre>
<p><img src="08-earthquake-example_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
<div id="fitting-a-poisson-hmm-by-the-em-algorithm" class="section level3 hasAnchor" number="9.0.3">
<h3><span class="header-section-number">9.0.3</span> Fitting a Poisson-HMM by the EM Algorithm<a href="eq.html#fitting-a-poisson-hmm-by-the-em-algorithm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Note:</strong> See <a href="em.html#em">EM Algorithm (Baum-Welch)</a></p>
<p>Alternatively, we may obtain MLEs of the three-state Poisson HMM by the EM algorithm.</p>
<p><strong>E-Step</strong> Replace all quantities <span class="math inline">\(v_jk (t)\)</span>, <span class="math inline">\(u_j (t)\)</span> by their conditional expectations given the observations <span class="math inline">\(\boldsymbol{x}^(T)\)</span> and current parameter estimates:</p>
<p><span class="math display">\[\hat{u}_j = \Pr (C_t = j|\boldsymbol{x}^{(T)}) = \frac{\alpha_t (j) \beta_t (j)}{L_T}\]</span></p>
<p><span class="math display">\[{\hat{v}}_{jk} (t) = \Pr (C_{t-1} = j, C_t = k| \boldsymbol{x}^{(T)}) \frac{\alpha_{t-1} (j) \gamma_{jk} p_k (x_t) \beta_t (k)}{L_T}\]</span></p>
<p><strong>Step 1</strong>: Compute the forward and backward probabilities.</p>
<p>We use the same forward algorithm from the above and apply the backward algorithm <code>pois.HMM.lbackward</code>.</p>
<p>The general algorithm is:</p>
<p><span class="math inline">\(\boldsymbol{\phi}_T \leftarrow \frac{\boldsymbol{1}}{w_T}\)</span>; <span class="math inline">\(l \leftarrow \log w_T\)</span></p>
<p>for <span class="math inline">\(t = T-1, \dots, 1\)</span></p>
<p><span class="math display">\[\begin{align}
\boldsymbol{v} &amp;\leftarrow \boldsymbol{\Gamma P} (x_{t+1}) \boldsymbol{\phi_{t+1}}\\
l &amp;\leftarrow l + \log \boldsymbol{v}\\
u &amp;\leftarrow \boldsymbol{v 1&#39;}\\
\boldsymbol{\phi}_t &amp;\leftarrow \frac{\boldsymbol{v}}{u}\\
l &amp; \leftarrow l + \log u
\end{align}\]</span></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="eq.html#cb52-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.lbackward<span class="ot">&lt;-</span><span class="cf">function</span>(x,mod){</span>
<span id="cb52-2"><a href="eq.html#cb52-2" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb52-3"><a href="eq.html#cb52-3" aria-hidden="true" tabindex="-1"></a> m          <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb52-4"><a href="eq.html#cb52-4" aria-hidden="true" tabindex="-1"></a> lbeta      <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,m,n)</span>
<span id="cb52-5"><a href="eq.html#cb52-5" aria-hidden="true" tabindex="-1"></a> lbeta[,n]  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,m)</span>
<span id="cb52-6"><a href="eq.html#cb52-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb52-7"><a href="eq.html#cb52-7" aria-hidden="true" tabindex="-1"></a> <span class="co"># For t = T</span></span>
<span id="cb52-8"><a href="eq.html#cb52-8" aria-hidden="true" tabindex="-1"></a> foo        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>m,m)</span>
<span id="cb52-9"><a href="eq.html#cb52-9" aria-hidden="true" tabindex="-1"></a> lscale     <span class="ot">&lt;-</span> <span class="fu">log</span>(m)</span>
<span id="cb52-10"><a href="eq.html#cb52-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb52-11"><a href="eq.html#cb52-11" aria-hidden="true" tabindex="-1"></a> <span class="co"># For t = (T-1),..., 1</span></span>
<span id="cb52-12"><a href="eq.html#cb52-12" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> (n<span class="dv">-1</span>)<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb52-13"><a href="eq.html#cb52-13" aria-hidden="true" tabindex="-1"></a>    foo        <span class="ot">&lt;-</span> mod<span class="sc">$</span>gamma<span class="sc">%*%</span>(<span class="fu">dpois</span>(x[i<span class="sc">+</span><span class="dv">1</span>],mod<span class="sc">$</span>lambda)<span class="sc">*</span>foo)</span>
<span id="cb52-14"><a href="eq.html#cb52-14" aria-hidden="true" tabindex="-1"></a>    lbeta[,i]  <span class="ot">&lt;-</span> <span class="fu">log</span>(foo)<span class="sc">+</span>lscale</span>
<span id="cb52-15"><a href="eq.html#cb52-15" aria-hidden="true" tabindex="-1"></a>    sumfoo     <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb52-16"><a href="eq.html#cb52-16" aria-hidden="true" tabindex="-1"></a>    foo        <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb52-17"><a href="eq.html#cb52-17" aria-hidden="true" tabindex="-1"></a>    lscale     <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb52-18"><a href="eq.html#cb52-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-19"><a href="eq.html#cb52-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(lbeta)</span>
<span id="cb52-20"><a href="eq.html#cb52-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.lbackward</code> takes in the same arguments as the <code>pois.HMM.lforward</code>.</p>
<p><strong>Step 2:</strong> Replace <span class="math inline">\(u_j(t)\)</span> by <span class="math inline">\(\hat{u}_j (t)\)</span> and <span class="math inline">\(v_{jk}(t)\)</span> by <span class="math inline">\(\hat{v}_{jk} (t)\)</span>.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="eq.html#cb53-1" aria-hidden="true" tabindex="-1"></a>uhat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mod){</span>
<span id="cb53-2"><a href="eq.html#cb53-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb53-3"><a href="eq.html#cb53-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb53-4"><a href="eq.html#cb53-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-5"><a href="eq.html#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Forward probabilities</span></span>
<span id="cb53-6"><a href="eq.html#cb53-6" aria-hidden="true" tabindex="-1"></a>  la <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x, mod)</span>
<span id="cb53-7"><a href="eq.html#cb53-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-8"><a href="eq.html#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Backward probabilities</span></span>
<span id="cb53-9"><a href="eq.html#cb53-9" aria-hidden="true" tabindex="-1"></a>  lb <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x, mod)</span>
<span id="cb53-10"><a href="eq.html#cb53-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-11"><a href="eq.html#cb53-11" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb53-12"><a href="eq.html#cb53-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-13"><a href="eq.html#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># L_T (with some constant amount)</span></span>
<span id="cb53-14"><a href="eq.html#cb53-14" aria-hidden="true" tabindex="-1"></a>  llk <span class="ot">&lt;-</span> c <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n] <span class="sc">-</span> c)))</span>
<span id="cb53-15"><a href="eq.html#cb53-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-16"><a href="eq.html#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize</span></span>
<span id="cb53-17"><a href="eq.html#cb53-17" aria-hidden="true" tabindex="-1"></a>  stateprobs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol=</span>n, <span class="at">nrow=</span>m)</span>
<span id="cb53-18"><a href="eq.html#cb53-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-19"><a href="eq.html#cb53-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## (a_t(j) b_t (j))/L_T </span></span>
<span id="cb53-20"><a href="eq.html#cb53-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb53-21"><a href="eq.html#cb53-21" aria-hidden="true" tabindex="-1"></a>    stateprobs[,i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[, i] <span class="sc">+</span> lb[, i] <span class="sc">-</span> llk)</span>
<span id="cb53-22"><a href="eq.html#cb53-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-23"><a href="eq.html#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stateprobs)</span>
<span id="cb53-24"><a href="eq.html#cb53-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-25"><a href="eq.html#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="eq.html#cb53-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-27"><a href="eq.html#cb53-27" aria-hidden="true" tabindex="-1"></a>vhat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mod){</span>
<span id="cb53-28"><a href="eq.html#cb53-28" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb53-29"><a href="eq.html#cb53-29" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb53-30"><a href="eq.html#cb53-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-31"><a href="eq.html#cb53-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Forward probabilities</span></span>
<span id="cb53-32"><a href="eq.html#cb53-32" aria-hidden="true" tabindex="-1"></a>  la <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x, mod)</span>
<span id="cb53-33"><a href="eq.html#cb53-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-34"><a href="eq.html#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Backward probabilities</span></span>
<span id="cb53-35"><a href="eq.html#cb53-35" aria-hidden="true" tabindex="-1"></a>  lb <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x, mod)</span>
<span id="cb53-36"><a href="eq.html#cb53-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-37"><a href="eq.html#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tpm</span></span>
<span id="cb53-38"><a href="eq.html#cb53-38" aria-hidden="true" tabindex="-1"></a>  lgamma <span class="ot">&lt;-</span> <span class="fu">log</span>(mod<span class="sc">$</span>gamma)</span>
<span id="cb53-39"><a href="eq.html#cb53-39" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">max</span>(la[, n])</span>
<span id="cb53-40"><a href="eq.html#cb53-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-41"><a href="eq.html#cb53-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># L_T (with some constant amount)</span></span>
<span id="cb53-42"><a href="eq.html#cb53-42" aria-hidden="true" tabindex="-1"></a>  llk <span class="ot">&lt;-</span> c <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[, n] <span class="sc">-</span> c)))</span>
<span id="cb53-43"><a href="eq.html#cb53-43" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(m, m, n))</span>
<span id="cb53-44"><a href="eq.html#cb53-44" aria-hidden="true" tabindex="-1"></a>  px <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>mod<span class="sc">$</span>m, <span class="at">ncol=</span>n)</span>
<span id="cb53-45"><a href="eq.html#cb53-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-46"><a href="eq.html#cb53-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb53-47"><a href="eq.html#cb53-47" aria-hidden="true" tabindex="-1"></a>    px[, i] <span class="ot">&lt;-</span> <span class="fu">dpois</span>(x[i], mod<span class="sc">$</span>lambda)</span>
<span id="cb53-48"><a href="eq.html#cb53-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-49"><a href="eq.html#cb53-49" aria-hidden="true" tabindex="-1"></a>  lpx <span class="ot">&lt;-</span> <span class="fu">log</span>(px)</span>
<span id="cb53-50"><a href="eq.html#cb53-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-51"><a href="eq.html#cb53-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb53-52"><a href="eq.html#cb53-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m){</span>
<span id="cb53-53"><a href="eq.html#cb53-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m){</span>
<span id="cb53-54"><a href="eq.html#cb53-54" aria-hidden="true" tabindex="-1"></a>        v[j, k, i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[j, i<span class="dv">-1</span>] <span class="sc">+</span> lgamma[j, k] <span class="sc">+</span> lpx[k, i] <span class="sc">+</span> lb[k, i] <span class="sc">-</span> llk)</span>
<span id="cb53-55"><a href="eq.html#cb53-55" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb53-56"><a href="eq.html#cb53-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-57"><a href="eq.html#cb53-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-58"><a href="eq.html#cb53-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(v)</span>
<span id="cb53-59"><a href="eq.html#cb53-59" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> The term <code>c</code> in the code is a constant added to the log-forward and log-backward probabilities to prevent numerical underflow.</p>
<p><strong>M-Step</strong> Maximize the complete data log-likelihood with respect to the parameter estimates, with functions of the missing data replaced by their conditional expectations.</p>
<p>That is, maximize</p>
<p><span class="math display">\[\begin{align}
\log \left(\Pr(\boldsymbol{x}^{(T)}, \boldsymbol{c}^{(T)}) \right)
&amp;= \sum_{j=1}^m \hat{u}_j (1) + \log \delta_j + \sum_{j=1}^m \sum_{k=1}^m \left(\sum_{t=2}^T \hat{v}_{jk} (t)\right) \log \gamma_{jk} + \sum_{j=1}^m \sum_{t=1}^T \hat{u}_j (t) \log p_j (x_t)
\end{align}\]</span></p>
<p>with respect to <span class="math inline">\(\boldsymbol{\theta} = (\boldsymbol{\delta}, \boldsymbol{\Gamma}, \boldsymbol{\lambda})\)</span>.</p>
<p>The maximizations of the parameters are given by</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="eq.html#cb54-1" aria-hidden="true" tabindex="-1"></a>E_delta <span class="ot">&lt;-</span> <span class="cf">function</span>(uhat){</span>
<span id="cb54-2"><a href="eq.html#cb54-2" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> uhat[, <span class="dv">1</span>]</span>
<span id="cb54-3"><a href="eq.html#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(d)</span>
<span id="cb54-4"><a href="eq.html#cb54-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-5"><a href="eq.html#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="eq.html#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="eq.html#cb54-7" aria-hidden="true" tabindex="-1"></a>E_gamma <span class="ot">&lt;-</span> <span class="cf">function</span>(vhat, mod){</span>
<span id="cb54-8"><a href="eq.html#cb54-8" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> <span class="fu">apply</span>(vhat, <span class="at">MARGIN=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">FUN=</span>sum)</span>
<span id="cb54-9"><a href="eq.html#cb54-9" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(num)</span>
<span id="cb54-10"><a href="eq.html#cb54-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> num<span class="sc">/</span>denom</span>
<span id="cb54-11"><a href="eq.html#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(g)</span>
<span id="cb54-12"><a href="eq.html#cb54-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-13"><a href="eq.html#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="eq.html#cb54-14" aria-hidden="true" tabindex="-1"></a>E_pois_lambda <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod,uhat){</span>
<span id="cb54-15"><a href="eq.html#cb54-15" aria-hidden="true" tabindex="-1"></a> n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb54-16"><a href="eq.html#cb54-16" aria-hidden="true" tabindex="-1"></a> m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb54-17"><a href="eq.html#cb54-17" aria-hidden="true" tabindex="-1"></a> xx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(x, m), <span class="at">nrow=</span>m, <span class="at">ncol=</span>n, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb54-18"><a href="eq.html#cb54-18" aria-hidden="true" tabindex="-1"></a> lambda_hat <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(uhat<span class="sc">*</span>xx)<span class="sc">/</span><span class="fu">rowSums</span>(uhat)</span>
<span id="cb54-19"><a href="eq.html#cb54-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(lambda_hat)</span>
<span id="cb54-20"><a href="eq.html#cb54-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>BaumWelch</code> function performs the EM algorithm by taking initial model parameters as inputs, then repeatedly fitting until convergence or the maximum number of iterations is reached (by default <code>maxit=50</code>).</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="eq.html#cb55-1" aria-hidden="true" tabindex="-1"></a>BaumWelch <span class="ot">&lt;-</span> <span class="cf">function</span>(x, m, lambda0, gamma0, delta0, <span class="at">maxit =</span> <span class="dv">50</span>){</span>
<span id="cb55-2"><a href="eq.html#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial parameters</span></span>
<span id="cb55-3"><a href="eq.html#cb55-3" aria-hidden="true" tabindex="-1"></a>  mod_old <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m =</span> m, <span class="at">lambda =</span> lambda0, <span class="at">gamma =</span> gamma0, <span class="at">delta =</span> delta0)</span>
<span id="cb55-4"><a href="eq.html#cb55-4" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb55-5"><a href="eq.html#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(iter <span class="sc">&lt;</span> maxit){</span>
<span id="cb55-6"><a href="eq.html#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># E-step</span></span>
<span id="cb55-7"><a href="eq.html#cb55-7" aria-hidden="true" tabindex="-1"></a>    u_hat <span class="ot">&lt;-</span> <span class="fu">uhat</span>(x, mod_old)</span>
<span id="cb55-8"><a href="eq.html#cb55-8" aria-hidden="true" tabindex="-1"></a>    v_hat <span class="ot">&lt;-</span> <span class="fu">vhat</span>(x, mod_old)</span>
<span id="cb55-9"><a href="eq.html#cb55-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-10"><a href="eq.html#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M-step</span></span>
<span id="cb55-11"><a href="eq.html#cb55-11" aria-hidden="true" tabindex="-1"></a>    delta_new <span class="ot">&lt;-</span> <span class="fu">E_delta</span>(u_hat)</span>
<span id="cb55-12"><a href="eq.html#cb55-12" aria-hidden="true" tabindex="-1"></a>    gamma_new <span class="ot">&lt;-</span> <span class="fu">E_gamma</span>(v_hat, mod_old)</span>
<span id="cb55-13"><a href="eq.html#cb55-13" aria-hidden="true" tabindex="-1"></a>    lambda_new <span class="ot">&lt;-</span> <span class="fu">E_pois_lambda</span>(x, mod_old, u_hat)</span>
<span id="cb55-14"><a href="eq.html#cb55-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-15"><a href="eq.html#cb55-15" aria-hidden="true" tabindex="-1"></a>    mod_old <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m, <span class="at">lambda=</span>lambda_new, <span class="at">gamma=</span>gamma_new, <span class="at">delta=</span>delta_new)</span>
<span id="cb55-16"><a href="eq.html#cb55-16" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">=</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb55-17"><a href="eq.html#cb55-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-18"><a href="eq.html#cb55-18" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m, <span class="at">lambda=</span>lambda_new, <span class="at">gamma=</span>gamma_new, <span class="at">delta=</span>delta_new)</span>
<span id="cb55-19"><a href="eq.html#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mod)</span>
<span id="cb55-20"><a href="eq.html#cb55-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Hence, for the three-state Poisson-HMM</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="eq.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a three-state HMM</span></span>
<span id="cb56-2"><a href="eq.html#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BaumWelch</span>(x, eq_init<span class="sc">$</span>m, eq_init<span class="sc">$</span>lambda, eq_init<span class="sc">$</span>gamma, <span class="at">delta =</span> <span class="fu">rep</span>(<span class="dv">1</span>, eq_init<span class="sc">$</span>m)<span class="sc">/</span>eq_init<span class="sc">$</span>m)</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.13376 19.71316 29.70972
## 
## $gamma
##              [,1]       [,2]       [,3]
## [1,] 9.392939e-01 0.03209847 0.02860765
## [2,] 4.040172e-02 0.90643612 0.05316216
## [3,] 2.113508e-32 0.19025585 0.80974415
## 
## $delta
## [1]  1.000000e+00  3.977303e-84 2.817232e-235</code></pre>
</div>
<div id="forecasting-decoding-and-state-prediction" class="section level3 hasAnchor" number="9.0.4">
<h3><span class="header-section-number">9.0.4</span> Forecasting, Decoding, and State Prediction<a href="eq.html#forecasting-decoding-and-state-prediction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Note:</strong> See <a href="fdp.html#fdp">Forecasting, Decoding, and State Prediction</a>.</p>
<div id="forecasting" class="section level4 hasAnchor" number="9.0.4.1">
<h4><span class="header-section-number">9.0.4.1</span> Forecasting<a href="eq.html#forecasting" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The forecast probabilities <span class="math inline">\(\Pr(X_{T+h} = x|\boldsymbol{X}^{(T)} = \boldsymbol{x}^{(T)})\)</span> can be computed by</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="eq.html#cb58-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.forecast <span class="ot">&lt;-</span> <span class="cf">function</span>(xf,<span class="at">h=</span><span class="dv">1</span>,x,mod)</span>
<span id="cb58-2"><a href="eq.html#cb58-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb58-3"><a href="eq.html#cb58-3" aria-hidden="true" tabindex="-1"></a> n        <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb58-4"><a href="eq.html#cb58-4" aria-hidden="true" tabindex="-1"></a> nxf      <span class="ot">&lt;-</span> <span class="fu">length</span>(xf)</span>
<span id="cb58-5"><a href="eq.html#cb58-5" aria-hidden="true" tabindex="-1"></a> dxf      <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>h,<span class="at">ncol=</span>nxf)</span>
<span id="cb58-6"><a href="eq.html#cb58-6" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb58-7"><a href="eq.html#cb58-7" aria-hidden="true" tabindex="-1"></a> sumfoo   <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb58-8"><a href="eq.html#cb58-8" aria-hidden="true" tabindex="-1"></a> lscale   <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb58-9"><a href="eq.html#cb58-9" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb58-10"><a href="eq.html#cb58-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb58-11"><a href="eq.html#cb58-11" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb58-12"><a href="eq.html#cb58-12" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb58-13"><a href="eq.html#cb58-13" aria-hidden="true" tabindex="-1"></a>   sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb58-14"><a href="eq.html#cb58-14" aria-hidden="true" tabindex="-1"></a>   lscale <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb58-15"><a href="eq.html#cb58-15" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb58-16"><a href="eq.html#cb58-16" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb58-17"><a href="eq.html#cb58-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h)</span>
<span id="cb58-18"><a href="eq.html#cb58-18" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb58-19"><a href="eq.html#cb58-19" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma</span>
<span id="cb58-20"><a href="eq.html#cb58-20" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m) dxf[i,] <span class="ot">&lt;-</span> dxf[i,] <span class="sc">+</span> foo[j]<span class="sc">*</span><span class="fu">dpois</span>(xf,mod<span class="sc">$</span>lambda[j])</span>
<span id="cb58-21"><a href="eq.html#cb58-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-22"><a href="eq.html#cb58-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(dxf)</span>
<span id="cb58-23"><a href="eq.html#cb58-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.forecast</code> takes in arguments <code>xf</code> the range of <span class="math inline">\(x\)</span>-values for the forecast probabilities, <code>h</code> the forecast horizon, <code>x</code> data, and <code>mod</code> list consisting of <code>m</code> states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities.</p>
<p>For example, the forecast distributions for 1 to 4 years ahead with possible values up to 45 earthquakes is</p>
<div class="figure"><span style="display:block;" id="fig:forecastfour"></span>
<img src="08-earthquake-example_files/figure-html/forecastfour-1.png" alt="Forecast probabilities for the fitted three-state Poisson-HMM for 1 to 4 years ahead." width="672" />
<p class="caption">
Figure 9.7: Forecast probabilities for the fitted three-state Poisson-HMM for 1 to 4 years ahead.
</p>
</div>
</div>
<div id="decoding-1" class="section level4 hasAnchor" number="9.0.4.2">
<h4><span class="header-section-number">9.0.4.2</span> Decoding<a href="eq.html#decoding-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Local decoding can be computed using the forward and backward algorithms from above. Similar to computing <span class="math inline">\(\hat{u}\)</span> in the <strong>E step</strong> of the EM algorithm, the <code>pois.HMM.state_probs</code> computes the state probabilities then <code>pois.HMM.local_decoding</code> determines the most likely state at each time.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="eq.html#cb59-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.state_probs <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod)</span>
<span id="cb59-2"><a href="eq.html#cb59-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb59-3"><a href="eq.html#cb59-3" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb59-4"><a href="eq.html#cb59-4" aria-hidden="true" tabindex="-1"></a> la         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x,mod)</span>
<span id="cb59-5"><a href="eq.html#cb59-5" aria-hidden="true" tabindex="-1"></a> lb         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x,mod)</span>
<span id="cb59-6"><a href="eq.html#cb59-6" aria-hidden="true" tabindex="-1"></a> c          <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb59-7"><a href="eq.html#cb59-7" aria-hidden="true" tabindex="-1"></a> llk        <span class="ot">&lt;-</span> c<span class="sc">+</span><span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n]<span class="sc">-</span>c)))</span>
<span id="cb59-8"><a href="eq.html#cb59-8" aria-hidden="true" tabindex="-1"></a> stateprobs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span>n,<span class="at">nrow=</span>mod<span class="sc">$</span>m)</span>
<span id="cb59-9"><a href="eq.html#cb59-9" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) stateprobs[,i]<span class="ot">&lt;-</span><span class="fu">exp</span>(la[,i]<span class="sc">+</span>lb[,i]<span class="sc">-</span>llk)</span>
<span id="cb59-10"><a href="eq.html#cb59-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(stateprobs)</span>
<span id="cb59-11"><a href="eq.html#cb59-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-12"><a href="eq.html#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="eq.html#cb59-13" aria-hidden="true" tabindex="-1"></a>pois.HMM.local_decoding <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod)</span>
<span id="cb59-14"><a href="eq.html#cb59-14" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb59-15"><a href="eq.html#cb59-15" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb59-16"><a href="eq.html#cb59-16" aria-hidden="true" tabindex="-1"></a> stateprobs <span class="ot">&lt;-</span> <span class="fu">pois.HMM.state_probs</span>(x,mod)</span>
<span id="cb59-17"><a href="eq.html#cb59-17" aria-hidden="true" tabindex="-1"></a> ild        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,n)</span>
<span id="cb59-18"><a href="eq.html#cb59-18" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) ild[i]<span class="ot">&lt;-</span><span class="fu">which.max</span>(stateprobs[,i])</span>
<span id="cb59-19"><a href="eq.html#cb59-19" aria-hidden="true" tabindex="-1"></a> ild</span>
<span id="cb59-20"><a href="eq.html#cb59-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, local decoding for the three state Poisson-HMM is</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="eq.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Local decoding</span></span>
<span id="cb60-2"><a href="eq.html#cb60-2" aria-hidden="true" tabindex="-1"></a>(earthquake_local <span class="ot">&lt;-</span> <span class="fu">pois.HMM.local_decoding</span>(x, eq_init))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 3 3 3 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 3 1 2 2 2 2 2 2 2 2 2 3 3 3 3 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 2 2 1 1 1 2 2 2 2 2 2 2 2 2 1 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:local"></span>
<img src="08-earthquake-example_files/figure-html/local-1.png" alt="Local decoding for the three-state Poisson-HMM. The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time." width="672" />
<p class="caption">
Figure 9.8: Local decoding for the three-state Poisson-HMM. The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time.
</p>
</div>
<p>We can also perform local decoding using <code>momentuHMM</code></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="eq.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Local decoding</span></span>
<span id="cb62-2"><a href="eq.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute state probabilities for each time step</span></span>
<span id="cb62-3"><a href="eq.html#cb62-3" aria-hidden="true" tabindex="-1"></a>state_probs <span class="ot">&lt;-</span> <span class="fu">stateProbs</span>(eq_fit1)</span>
<span id="cb62-4"><a href="eq.html#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="eq.html#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Select state that maximizes probability</span></span>
<span id="cb62-6"><a href="eq.html#cb62-6" aria-hidden="true" tabindex="-1"></a>local_vec        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(x))</span>
<span id="cb62-7"><a href="eq.html#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)) local_vec[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(state_probs[i,])</span>
<span id="cb62-8"><a href="eq.html#cb62-8" aria-hidden="true" tabindex="-1"></a>local_vec</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 2 2 2 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 2 2 2 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 2 2 2
##  [75] 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:comparelocal"></span>
<img src="08-earthquake-example_files/figure-html/comparelocal-1.png" alt="Local decoding for the three-state Poisson-HMM. The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time using  pois.HMM.local_decoding (purple) and momentuHMM (orange)." width="672" />
<p class="caption">
Figure 9.9: Local decoding for the three-state Poisson-HMM. The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time using pois.HMM.local_decoding (purple) and momentuHMM (orange).
</p>
</div>
<p>Global decoding can be computed using the Viterbi algorithm</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="eq.html#cb64-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.viterbi<span class="ot">&lt;-</span><span class="cf">function</span>(x,mod)</span>
<span id="cb64-2"><a href="eq.html#cb64-2" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb64-3"><a href="eq.html#cb64-3" aria-hidden="true" tabindex="-1"></a> n              <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb64-4"><a href="eq.html#cb64-4" aria-hidden="true" tabindex="-1"></a> xi             <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,n,mod<span class="sc">$</span>m)</span>
<span id="cb64-5"><a href="eq.html#cb64-5" aria-hidden="true" tabindex="-1"></a> foo            <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb64-6"><a href="eq.html#cb64-6" aria-hidden="true" tabindex="-1"></a> xi[<span class="dv">1</span>,]         <span class="ot">&lt;-</span> foo<span class="sc">/</span><span class="fu">sum</span>(foo)</span>
<span id="cb64-7"><a href="eq.html#cb64-7" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb64-8"><a href="eq.html#cb64-8" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb64-9"><a href="eq.html#cb64-9" aria-hidden="true" tabindex="-1"></a>  foo<span class="ot">&lt;-</span><span class="fu">apply</span>(xi[i<span class="dv">-1</span>,]<span class="sc">*</span>mod<span class="sc">$</span>gamma,<span class="dv">2</span>,max)<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb64-10"><a href="eq.html#cb64-10" aria-hidden="true" tabindex="-1"></a>  xi[i,] <span class="ot">&lt;-</span> foo<span class="sc">/</span><span class="fu">sum</span>(foo)</span>
<span id="cb64-11"><a href="eq.html#cb64-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-12"><a href="eq.html#cb64-12" aria-hidden="true" tabindex="-1"></a> iv<span class="ot">&lt;-</span><span class="fu">numeric</span>(n)</span>
<span id="cb64-13"><a href="eq.html#cb64-13" aria-hidden="true" tabindex="-1"></a> iv[n]     <span class="ot">&lt;-</span><span class="fu">which.max</span>(xi[n,])</span>
<span id="cb64-14"><a href="eq.html#cb64-14" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> (n<span class="dv">-1</span>)<span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb64-15"><a href="eq.html#cb64-15" aria-hidden="true" tabindex="-1"></a>   iv[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(mod<span class="sc">$</span>gamma[,iv[i<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">*</span>xi[i,])</span>
<span id="cb64-16"><a href="eq.html#cb64-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(iv)</span>
<span id="cb64-17"><a href="eq.html#cb64-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, global decoding for the three state Poisson-HMM is</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="eq.html#cb65-1" aria-hidden="true" tabindex="-1"></a>(earthquake_global <span class="ot">&lt;-</span> <span class="fu">pois.HMM.viterbi</span>(x, eq_init))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 3 3 3 3 3 3 3 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:global"></span>
<img src="08-earthquake-example_files/figure-html/global-1.png" alt="Global decoding for the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.10: Global decoding for the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:comparelg"></span>
<img src="08-earthquake-example_files/figure-html/comparelg-1.png" alt="Global (green) and local (brown) decoding for the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.11: Global (green) and local (brown) decoding for the three-state Poisson-HMM.
</p>
</div>
<p>The result of local and global decoding are very similar but not identical.</p>
<p>Similarly, we can perform global decoding using <code>momentuHMM</code></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="eq.html#cb67-1" aria-hidden="true" tabindex="-1"></a>(global_vec <span class="ot">&lt;-</span> <span class="fu">viterbi</span>(eq_fit1))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 2 2 2 2 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 2 2 2 2 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 2 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="eq.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotStates</span>(eq_fit1)</span></code></pre></div>
<pre><code>## Decoding state sequence... DONE
## Computing state probabilities... DONE</code></pre>
<p><img src="08-earthquake-example_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<div class="figure"><span style="display:block;" id="fig:compareglobal"></span>
<img src="08-earthquake-example_files/figure-html/compareglobal-1.png" alt="Global decoding for the three-state Poisson-HMM using  pois.HMM.gocal_decoding (purple) and momentuHMM (orange)." width="672" />
<p class="caption">
Figure 9.12: Global decoding for the three-state Poisson-HMM using pois.HMM.gocal_decoding (purple) and momentuHMM (orange).
</p>
</div>
<p>There appears to be some differences between the results obtained from our function and from <code>momentuHMM</code>.</p>
<p><strong>Note:</strong> In both cases, the MC does not assume stationarity and the initial distribution is <span class="math inline">\(\boldsymbol{\delta} = (1/3, 1/3, 1/3)\)</span>.</p>
</div>
<div id="state-predictions" class="section level4 hasAnchor" number="9.0.4.3">
<h4><span class="header-section-number">9.0.4.3</span> State Predictions<a href="eq.html#state-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The state prediction for <span class="math inline">\(h\)</span> steps ahead can be computed by</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="eq.html#cb71-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.state_prediction <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">h=</span><span class="dv">1</span>,x,mod)</span>
<span id="cb71-2"><a href="eq.html#cb71-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb71-3"><a href="eq.html#cb71-3" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb71-4"><a href="eq.html#cb71-4" aria-hidden="true" tabindex="-1"></a> la         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x,mod)</span>
<span id="cb71-5"><a href="eq.html#cb71-5" aria-hidden="true" tabindex="-1"></a> c          <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb71-6"><a href="eq.html#cb71-6" aria-hidden="true" tabindex="-1"></a> llk        <span class="ot">&lt;-</span> c<span class="sc">+</span><span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n]<span class="sc">-</span>c)))</span>
<span id="cb71-7"><a href="eq.html#cb71-7" aria-hidden="true" tabindex="-1"></a> statepreds <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span>h,<span class="at">nrow=</span>mod<span class="sc">$</span>m)</span>
<span id="cb71-8"><a href="eq.html#cb71-8" aria-hidden="true" tabindex="-1"></a> foo <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[,n]<span class="sc">-</span>llk)</span>
<span id="cb71-9"><a href="eq.html#cb71-9" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h){</span>
<span id="cb71-10"><a href="eq.html#cb71-10" aria-hidden="true" tabindex="-1"></a>  foo<span class="ot">&lt;-</span>foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma</span>
<span id="cb71-11"><a href="eq.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  statepreds[,i]<span class="ot">&lt;-</span>foo</span>
<span id="cb71-12"><a href="eq.html#cb71-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-13"><a href="eq.html#cb71-13" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(statepreds)</span>
<span id="cb71-14"><a href="eq.html#cb71-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, the state predictions for <span class="math inline">\(h=1, \dots, 5\)</span> is</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="eq.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pois.HMM.state_prediction</span>(<span class="at">h=</span><span class="dv">5</span>, x, eq_init)</span></code></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]      [,5]
## [1,] 0.7733048 0.6413134 0.5489194 0.4842436 0.4389705
## [2,] 0.1259027 0.1881319 0.2316923 0.2621846 0.2835292
## [3,] 0.1007924 0.1705547 0.2193883 0.2535718 0.2775003</code></pre>
<p>The stationary distribution is</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="eq.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute stationary distribution</span></span>
<span id="cb74-2"><a href="eq.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">diag</span>(eq_init<span class="sc">$</span>m)<span class="sc">-</span>eq_init<span class="sc">$</span>gamma<span class="sc">+</span><span class="dv">1</span>),<span class="fu">rep</span>(<span class="dv">1</span>,eq_init<span class="sc">$</span>m))</span></code></pre></div>
<pre><code>## [1] 0.3333333 0.3333333 0.3333333</code></pre>
<p>Notice that as <span class="math inline">\(h \rightarrow \infty\)</span>, the state distribution approaches the stationary distribution.</p>
</div>
</div>
<div id="bayesian-inference-in-stan" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Bayesian Inference in STAN<a href="eq.html#bayesian-inference-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can fit the three-state Poisson-HMM to the earthquake data using R-STAN.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="eq.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb76-2"><a href="eq.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb76-3"><a href="eq.html#cb76-3" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">T=</span><span class="fu">dim</span>(eq_dat)[<span class="dv">1</span>], <span class="at">m=</span><span class="dv">3</span>, <span class="at">x=</span>eq_dat<span class="sc">$</span>V2)</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="eq.html#cb77-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.stan <span class="ot">&lt;-</span> </span>
<span id="cb77-2"><a href="eq.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;data{</span></span>
<span id="cb77-3"><a href="eq.html#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; m;                       // number of states</span></span>
<span id="cb77-4"><a href="eq.html#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1&gt; T;                       // length of sequence</span></span>
<span id="cb77-5"><a href="eq.html#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; x[T];                    // observations</span></span>
<span id="cb77-6"><a href="eq.html#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb77-7"><a href="eq.html#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="eq.html#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb77-9"><a href="eq.html#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="st">simplex[m] Gamma[m];                  // tpm</span></span>
<span id="cb77-10"><a href="eq.html#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="st">positive_ordered[m] lambda;           // ordered mean of state-dependent (prevent label switching)</span></span>
<span id="cb77-11"><a href="eq.html#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb77-12"><a href="eq.html#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="eq.html#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters{</span></span>
<span id="cb77-14"><a href="eq.html#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[m, m] ta;                    // tpm used to compute stationary distribution                 </span></span>
<span id="cb77-15"><a href="eq.html#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[m] statdist;                // stationary distribution</span></span>
<span id="cb77-16"><a href="eq.html#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="eq.html#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 1:m){</span></span>
<span id="cb77-18"><a href="eq.html#cb77-18" aria-hidden="true" tabindex="-1"></a><span class="st">    for(i in 1:m){</span></span>
<span id="cb77-19"><a href="eq.html#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="st">      ta[i, j] = Gamma[i, j];</span></span>
<span id="cb77-20"><a href="eq.html#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb77-21"><a href="eq.html#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb77-22"><a href="eq.html#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="eq.html#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="st">//compute stationary distribution </span></span>
<span id="cb77-24"><a href="eq.html#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="st">statdist =  to_vector((to_row_vector(rep_vector(1.0, m))/</span></span>
<span id="cb77-25"><a href="eq.html#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="st">      (diag_matrix(rep_vector(1.0, m)) - ta + rep_matrix(1, m, m))));</span></span>
<span id="cb77-26"><a href="eq.html#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb77-27"><a href="eq.html#cb77-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-28"><a href="eq.html#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb77-29"><a href="eq.html#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="st">  // initialise</span></span>
<span id="cb77-30"><a href="eq.html#cb77-30" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] log_Gamma_tr[m];</span></span>
<span id="cb77-31"><a href="eq.html#cb77-31" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp;</span></span>
<span id="cb77-32"><a href="eq.html#cb77-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp_p1;</span></span>
<span id="cb77-33"><a href="eq.html#cb77-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-34"><a href="eq.html#cb77-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb77-35"><a href="eq.html#cb77-35" aria-hidden="true" tabindex="-1"></a><span class="st">  lambda ~ gamma(0.1, 0.01);</span></span>
<span id="cb77-36"><a href="eq.html#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="eq.html#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="st">  // transpose tpm and take log of entries</span></span>
<span id="cb77-38"><a href="eq.html#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:m)</span></span>
<span id="cb77-39"><a href="eq.html#cb77-39" aria-hidden="true" tabindex="-1"></a><span class="st">    for(j in 1:m)</span></span>
<span id="cb77-40"><a href="eq.html#cb77-40" aria-hidden="true" tabindex="-1"></a><span class="st">      log_Gamma_tr[j, i] = log(Gamma[i, j]);</span></span>
<span id="cb77-41"><a href="eq.html#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb77-42"><a href="eq.html#cb77-42" aria-hidden="true" tabindex="-1"></a><span class="st">  // forward algorithm</span></span>
<span id="cb77-43"><a href="eq.html#cb77-43" aria-hidden="true" tabindex="-1"></a><span class="st">  // for t = 1</span></span>
<span id="cb77-44"><a href="eq.html#cb77-44" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:m)</span></span>
<span id="cb77-45"><a href="eq.html#cb77-45" aria-hidden="true" tabindex="-1"></a><span class="st">    lp[i] = log(statdist[i]) + poisson_lpmf(x[1]|lambda[i]);</span></span>
<span id="cb77-46"><a href="eq.html#cb77-46" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb77-47"><a href="eq.html#cb77-47" aria-hidden="true" tabindex="-1"></a><span class="st">  // loop over observations</span></span>
<span id="cb77-48"><a href="eq.html#cb77-48" aria-hidden="true" tabindex="-1"></a><span class="st">  for(t in 2:T){</span></span>
<span id="cb77-49"><a href="eq.html#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="st">  // loop over states</span></span>
<span id="cb77-50"><a href="eq.html#cb77-50" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:m)</span></span>
<span id="cb77-51"><a href="eq.html#cb77-51" aria-hidden="true" tabindex="-1"></a><span class="st">      lp_p1[i] = log_sum_exp(log_Gamma_tr[i] + lp) + poisson_lpmf(x[t]|lambda[i]);</span></span>
<span id="cb77-52"><a href="eq.html#cb77-52" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb77-53"><a href="eq.html#cb77-53" aria-hidden="true" tabindex="-1"></a><span class="st">      lp = lp_p1;</span></span>
<span id="cb77-54"><a href="eq.html#cb77-54" aria-hidden="true" tabindex="-1"></a><span class="st">   }</span></span>
<span id="cb77-55"><a href="eq.html#cb77-55" aria-hidden="true" tabindex="-1"></a><span class="st">   target += log_sum_exp(lp);</span></span>
<span id="cb77-56"><a href="eq.html#cb77-56" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb77-57"><a href="eq.html#cb77-57" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p>We first run 2000 iterations for each for each of the 4 chains, with the first 1000 draws drawn during the warm-up phase</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="eq.html#cb78-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.stanfit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code =</span> pois.HMM.stan, <span class="at">data =</span> stan_data, <span class="at">refresh=</span><span class="dv">2000</span>)</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;b37fb1f59e6ff956bdf58582435d9468&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.00011 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.1 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 0.8606 seconds (Warm-up)
## Chain 1:                0.548921 seconds (Sampling)
## Chain 1:                1.40952 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL &#39;b37fb1f59e6ff956bdf58582435d9468&#39; NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 5.6e-05 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.56 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 0.784481 seconds (Warm-up)
## Chain 2:                0.522786 seconds (Sampling)
## Chain 2:                1.30727 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL &#39;b37fb1f59e6ff956bdf58582435d9468&#39; NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 5.9e-05 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.59 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 0.8352 seconds (Warm-up)
## Chain 3:                0.407458 seconds (Sampling)
## Chain 3:                1.24266 seconds (Total)
## Chain 3: 
## 
## SAMPLING FOR MODEL &#39;b37fb1f59e6ff956bdf58582435d9468&#39; NOW (CHAIN 4).
## Chain 4: 
## Chain 4: Gradient evaluation took 6e-05 seconds
## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.6 seconds.
## Chain 4: Adjust your expectations accordingly!
## Chain 4: 
## Chain 4: 
## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 4: 
## Chain 4:  Elapsed Time: 0.978233 seconds (Warm-up)
## Chain 4:                0.479573 seconds (Sampling)
## Chain 4:                1.45781 seconds (Total)
## Chain 4:</code></pre>
<p>The posterior estimates are</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="eq.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pois.HMM.stanfit,<span class="at">digits_summary =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Inference for Stan model: b37fb1f59e6ff956bdf58582435d9468.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                 mean se_mean    sd     2.5%      25%      50%      75%    97.5%
## Gamma[1,1]     0.855   0.002 0.083    0.640    0.818    0.872    0.914    0.966
## Gamma[1,2]     0.095   0.001 0.075    0.006    0.042    0.078    0.128    0.289
## Gamma[1,3]     0.049   0.001 0.041    0.002    0.019    0.039    0.069    0.155
## Gamma[2,1]     0.091   0.001 0.059    0.016    0.052    0.081    0.119    0.225
## Gamma[2,2]     0.816   0.002 0.086    0.631    0.777    0.828    0.872    0.934
## Gamma[2,3]     0.093   0.002 0.064    0.014    0.050    0.081    0.121    0.237
## Gamma[3,1]     0.075   0.001 0.068    0.002    0.024    0.055    0.106    0.249
## Gamma[3,2]     0.229   0.002 0.118    0.052    0.138    0.214    0.299    0.498
## Gamma[3,3]     0.696   0.002 0.128    0.405    0.617    0.710    0.791    0.899
## lambda[1]     13.113   0.022 0.899   11.252   12.613   13.144   13.684   14.774
## lambda[2]     19.780   0.023 1.104   17.564   19.100   19.781   20.447   21.886
## lambda[3]     29.741   0.034 1.956   26.216   28.371   29.660   30.988   33.771
## ta[1,1]        0.855   0.002 0.083    0.640    0.818    0.872    0.914    0.966
## ta[1,2]        0.095   0.001 0.075    0.006    0.042    0.078    0.128    0.289
## ta[1,3]        0.049   0.001 0.041    0.002    0.019    0.039    0.069    0.155
## ta[2,1]        0.091   0.001 0.059    0.016    0.052    0.081    0.119    0.225
## ta[2,2]        0.816   0.002 0.086    0.631    0.777    0.828    0.872    0.934
## ta[2,3]        0.093   0.002 0.064    0.014    0.050    0.081    0.121    0.237
## ta[3,1]        0.075   0.001 0.068    0.002    0.024    0.055    0.106    0.249
## ta[3,2]        0.229   0.002 0.118    0.052    0.138    0.214    0.299    0.498
## ta[3,3]        0.696   0.002 0.128    0.405    0.617    0.710    0.791    0.899
## statdist[1]    0.383   0.002 0.140    0.133    0.283    0.373    0.474    0.680
## statdist[2]    0.421   0.002 0.128    0.177    0.331    0.421    0.508    0.678
## statdist[3]    0.196   0.001 0.092    0.059    0.128    0.181    0.249    0.408
## lp__        -353.963   0.072 2.535 -360.148 -355.307 -353.565 -352.148 -350.239
##             n_eff  Rhat
## Gamma[1,1]   2724 1.001
## Gamma[1,2]   2658 1.000
## Gamma[1,3]   3948 1.001
## Gamma[2,1]   2243 1.000
## Gamma[2,2]   1466 1.001
## Gamma[2,3]   1824 1.001
## Gamma[3,1]   4488 1.000
## Gamma[3,2]   3928 1.000
## Gamma[3,3]   3061 0.999
## lambda[1]    1659 1.002
## lambda[2]    2259 1.000
## lambda[3]    3292 1.000
## ta[1,1]      2724 1.001
## ta[1,2]      2658 1.000
## ta[1,3]      3948 1.001
## ta[2,1]      2243 1.000
## ta[2,2]      1466 1.001
## ta[2,3]      1824 1.001
## ta[3,1]      4488 1.000
## ta[3,2]      3928 1.000
## ta[3,3]      3061 0.999
## statdist[1]  4025 1.000
## statdist[2]  3821 1.000
## statdist[3]  4769 0.999
## lp__         1238 1.002
## 
## Samples were drawn using NUTS(diag_e) at Mon Jun 12 00:51:21 2023.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="figure"><span style="display:block;" id="fig:postl-1"></span>
<img src="08-earthquake-example_files/figure-html/postl-1.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.13: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postl-2"></span>
<img src="08-earthquake-example_files/figure-html/postl-2.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.14: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postl-3"></span>
<img src="08-earthquake-example_files/figure-html/postl-3.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.15: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-1"></span>
<img src="08-earthquake-example_files/figure-html/postd-1.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.16: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-2"></span>
<img src="08-earthquake-example_files/figure-html/postd-2.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.17: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-3"></span>
<img src="08-earthquake-example_files/figure-html/postd-3.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 9.18: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-inference-for-hmms.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vinky-wang/HMM-Notes/edit/BRANCH/08-earthquake-example.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "https://github.com/vinky-wang/HMM-Notes/raw/BRANCH/08-earthquake-example.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
