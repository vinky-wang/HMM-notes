<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Major Earthquake Analysis | Hidden Markov Model Notes</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Major Earthquake Analysis | Hidden Markov Model Notes" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="vinky-wang/HMM-Notes" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Major Earthquake Analysis | Hidden Markov Model Notes" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Vinky Wang" />


<meta name="date" content="2023-06-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian.html"/>
<link rel="next" href="appendix.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">HMM Notes</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="1" data-path="prelim.html"><a href="prelim.html"><i class="fa fa-check"></i><b>1</b> Preliminaries</a>
<ul>
<li class="chapter" data-level="1.1" data-path="prelim.html"><a href="prelim.html#mix"><i class="fa fa-check"></i><b>1.1</b> Independent Mixture Models</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="prelim.html"><a href="prelim.html#properties"><i class="fa fa-check"></i><b>1.1.1</b> Properties</a></li>
<li class="chapter" data-level="1.1.2" data-path="prelim.html"><a href="prelim.html#parameter-estimation"><i class="fa fa-check"></i><b>1.1.2</b> Parameter Estimation</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="prelim.html"><a href="prelim.html#mc"><i class="fa fa-check"></i><b>1.2</b> Markov Chains</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="prelim.html"><a href="prelim.html#probabilities"><i class="fa fa-check"></i><b>1.2.1</b> Probabilities</a></li>
<li class="chapter" data-level="1.2.2" data-path="prelim.html"><a href="prelim.html#stationary-distribution"><i class="fa fa-check"></i><b>1.2.2</b> Stationary Distribution</a></li>
<li class="chapter" data-level="1.2.3" data-path="prelim.html"><a href="prelim.html#tp"><i class="fa fa-check"></i><b>1.2.3</b> Transition Probabilities Estimation</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="prelim.html"><a href="prelim.html#exercises"><i class="fa fa-check"></i><b>1.3</b> Exercises</a></li>
<li class="chapter" data-level="1.4" data-path="prelim.html"><a href="prelim.html#solutions"><i class="fa fa-check"></i><b>1.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introhmm.html"><a href="introhmm.html"><i class="fa fa-check"></i><b>2</b> Introduction to Hidden Markov Models</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introhmm.html"><a href="introhmm.html#sdd"><i class="fa fa-check"></i><b>2.1</b> State-Dependent Distributions</a></li>
<li class="chapter" data-level="2.2" data-path="introhmm.html"><a href="introhmm.html#marginal-distributions"><i class="fa fa-check"></i><b>2.2</b> Marginal Distributions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introhmm.html"><a href="introhmm.html#univariate-case"><i class="fa fa-check"></i><b>2.2.1</b> Univariate Case</a></li>
<li class="chapter" data-level="2.2.2" data-path="introhmm.html"><a href="introhmm.html#bivariate"><i class="fa fa-check"></i><b>2.2.2</b> Bivariate Case</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introhmm.html"><a href="introhmm.html#moments"><i class="fa fa-check"></i><b>2.3</b> Moments</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introhmm.html"><a href="introhmm.html#univariate-case-1"><i class="fa fa-check"></i><b>2.3.1</b> Univariate Case</a></li>
<li class="chapter" data-level="2.3.2" data-path="introhmm.html"><a href="introhmm.html#bivariate-case"><i class="fa fa-check"></i><b>2.3.2</b> Bivariate Case</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introhmm.html"><a href="introhmm.html#lik"><i class="fa fa-check"></i><b>2.4</b> Likelihood of Hidden Markov Models</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="introhmm.html"><a href="introhmm.html#forsec"><i class="fa fa-check"></i><b>2.4.1</b> Forward Algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="introhmm.html"><a href="introhmm.html#exercises-1"><i class="fa fa-check"></i><b>2.5</b> Exercises</a></li>
<li class="chapter" data-level="2.6" data-path="introhmm.html"><a href="introhmm.html#solutions-1"><i class="fa fa-check"></i><b>2.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="numerical.html"><a href="numerical.html"><i class="fa fa-check"></i><b>3</b> Numerical Maximization of the Likelihood</a>
<ul>
<li class="chapter" data-level="3.1" data-path="numerical.html"><a href="numerical.html#likscale"><i class="fa fa-check"></i><b>3.1</b> Scaling the Likelihood Computation</a></li>
<li class="chapter" data-level="3.2" data-path="numerical.html"><a href="numerical.html#reparam"><i class="fa fa-check"></i><b>3.2</b> Reparameterization to Avoid Constraints</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="numerical.html"><a href="numerical.html#transition-probabilities"><i class="fa fa-check"></i><b>3.2.1</b> Transition Probabilities</a></li>
<li class="chapter" data-level="3.2.2" data-path="numerical.html"><a href="numerical.html#parameters-of-state-dependent-distributions"><i class="fa fa-check"></i><b>3.2.2</b> Parameters of State-Dependent Distributions</a></li>
<li class="chapter" data-level="3.2.3" data-path="numerical.html"><a href="numerical.html#initial-probabilities"><i class="fa fa-check"></i><b>3.2.3</b> Initial Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="numerical.html"><a href="numerical.html#startval"><i class="fa fa-check"></i><b>3.3</b> Strategies for Choosing Starting Values</a></li>
<li class="chapter" data-level="3.4" data-path="numerical.html"><a href="numerical.html#boot"><i class="fa fa-check"></i><b>3.4</b> Obtaining Standard Errors and Confidence Intervals</a></li>
<li class="chapter" data-level="3.5" data-path="numerical.html"><a href="numerical.html#exercises-2"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
<li class="chapter" data-level="3.6" data-path="numerical.html"><a href="numerical.html#solutions-2"><i class="fa fa-check"></i><b>3.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="fbalg.html"><a href="fbalg.html"><i class="fa fa-check"></i><b>4</b> The Forward and Backward Algorithm</a>
<ul>
<li class="chapter" data-level="4.1" data-path="fbalg.html"><a href="fbalg.html#forward-and-backward-probabilities"><i class="fa fa-check"></i><b>4.1</b> Forward and Backward Probabilities</a></li>
<li class="chapter" data-level="4.2" data-path="fbalg.html"><a href="fbalg.html#properties-of-hmms"><i class="fa fa-check"></i><b>4.2</b> Properties of HMMs</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="fbalg.html"><a href="fbalg.html#property"><i class="fa fa-check"></i><b>4.2.1</b> Property</a></li>
<li class="chapter" data-level="4.2.2" data-path="fbalg.html"><a href="fbalg.html#property-1"><i class="fa fa-check"></i><b>4.2.2</b> Property</a></li>
<li class="chapter" data-level="4.2.3" data-path="fbalg.html"><a href="fbalg.html#property-2"><i class="fa fa-check"></i><b>4.2.3</b> Property</a></li>
<li class="chapter" data-level="4.2.4" data-path="fbalg.html"><a href="fbalg.html#property-3"><i class="fa fa-check"></i><b>4.2.4</b> Property</a></li>
<li class="chapter" data-level="4.2.5" data-path="fbalg.html"><a href="fbalg.html#property-4"><i class="fa fa-check"></i><b>4.2.5</b> Property</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="fbalg.html"><a href="fbalg.html#forward-probabilities-as-joint-probabilities"><i class="fa fa-check"></i><b>4.3</b> Forward Probabilities as Joint Probabilities</a></li>
<li class="chapter" data-level="4.4" data-path="fbalg.html"><a href="fbalg.html#backward-probabilities-as-conditional-probabilities"><i class="fa fa-check"></i><b>4.4</b> Backward Probabilities as Conditional Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="em.html"><a href="em.html"><i class="fa fa-check"></i><b>5</b> Expectation-Maximization Algorithm (Baum-Welch)</a>
<ul>
<li class="chapter" data-level="5.1" data-path="em.html"><a href="em.html#em-algorithm-general"><i class="fa fa-check"></i><b>5.1</b> EM Algorithm (General)</a></li>
<li class="chapter" data-level="5.2" data-path="em.html"><a href="em.html#em-algorithm-for-hmms"><i class="fa fa-check"></i><b>5.2</b> EM Algorithm (for HMMs)</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="em.html"><a href="em.html#stationary-markov-chain"><i class="fa fa-check"></i><b>5.2.1</b> Stationary Markov Chain</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="em.html"><a href="em.html#exercises-3"><i class="fa fa-check"></i><b>5.3</b> Exercises</a></li>
<li class="chapter" data-level="5.4" data-path="em.html"><a href="em.html#solutions-3"><i class="fa fa-check"></i><b>5.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="fdp.html"><a href="fdp.html"><i class="fa fa-check"></i><b>6</b> Forecasting, Decoding, and State Prediction</a>
<ul>
<li class="chapter" data-level="6.1" data-path="fdp.html"><a href="fdp.html#conditional-distribution"><i class="fa fa-check"></i><b>6.1</b> Conditional Distribution</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="fdp.html"><a href="fdp.html#as-mixtures-of-state-dependent-probabilities"><i class="fa fa-check"></i><b>6.1.1</b> As Mixtures of State-Dependent Probabilities</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="fdp.html"><a href="fdp.html#forecast-distributions"><i class="fa fa-check"></i><b>6.2</b> Forecast Distributions</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="fdp.html"><a href="fdp.html#as-mixtures-of-state-dependent-probabilities-1"><i class="fa fa-check"></i><b>6.2.1</b> As Mixtures of State-Dependent Probabilities</a></li>
<li class="chapter" data-level="6.2.2" data-path="fdp.html"><a href="fdp.html#forecast-distribution-in-the-limit"><i class="fa fa-check"></i><b>6.2.2</b> Forecast Distribution in the Limit</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="fdp.html"><a href="fdp.html#decoding"><i class="fa fa-check"></i><b>6.3</b> Decoding</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="fdp.html"><a href="fdp.html#local-decoding"><i class="fa fa-check"></i><b>6.3.1</b> Local Decoding</a></li>
<li class="chapter" data-level="6.3.2" data-path="fdp.html"><a href="fdp.html#global-decoding"><i class="fa fa-check"></i><b>6.3.2</b> Global Decoding</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="fdp.html"><a href="fdp.html#state-prediction"><i class="fa fa-check"></i><b>6.4</b> State Prediction</a></li>
<li class="chapter" data-level="6.5" data-path="fdp.html"><a href="fdp.html#exercises-4"><i class="fa fa-check"></i><b>6.5</b> Exercises</a></li>
<li class="chapter" data-level="6.6" data-path="fdp.html"><a href="fdp.html#solutions-4"><i class="fa fa-check"></i><b>6.6</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="bayesian.html"><a href="bayesian.html"><i class="fa fa-check"></i><b>7</b> Bayesian Inference for HMMs</a>
<ul>
<li class="chapter" data-level="7.1" data-path="bayesian.html"><a href="bayesian.html#reparameterization-to-avoid-label-switching"><i class="fa fa-check"></i><b>7.1</b> Reparameterization to Avoid Label Switching</a></li>
<li class="chapter" data-level="7.2" data-path="bayesian.html"><a href="bayesian.html#gibbs-sampling-procedure"><i class="fa fa-check"></i><b>7.2</b> Gibbs Sampling Procedure</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="bayesian.html"><a href="bayesian.html#gen"><i class="fa fa-check"></i><b>7.2.1</b> Generating Sample Paths of the MC</a></li>
<li class="chapter" data-level="7.2.2" data-path="bayesian.html"><a href="bayesian.html#decom"><i class="fa fa-check"></i><b>7.2.2</b> Decomposing the Observed Counts into Regime Contributions</a></li>
<li class="chapter" data-level="7.2.3" data-path="bayesian.html"><a href="bayesian.html#updating-the-parameters"><i class="fa fa-check"></i><b>7.2.3</b> Updating the Parameters</a></li>
<li class="chapter" data-level="7.2.4" data-path="bayesian.html"><a href="bayesian.html#repeat-the-above"><i class="fa fa-check"></i><b>7.2.4</b> Repeat the Above</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="bayesian.html"><a href="bayesian.html#exercises-5"><i class="fa fa-check"></i><b>7.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="eq.html"><a href="eq.html"><i class="fa fa-check"></i><b>8</b> Major Earthquake Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#fitting-a-poisson-mixture-distribution"><i class="fa fa-check"></i>Fitting a Poisson Mixture Distribution</a></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#fitting-a-poisson-hmm-by-numerical-maximization"><i class="fa fa-check"></i>Fitting a Poisson-HMM by Numerical Maximization</a>
<ul>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#parametric-bootstrapping-for-confidence-intervals"><i class="fa fa-check"></i>Parametric Bootstrapping for Confidence Intervals</a></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#using-momentuhmm"><i class="fa fa-check"></i>Using <code>momentuHMM</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#fitting-a-poisson-hmm-by-the-em-algorithm"><i class="fa fa-check"></i>Fitting a Poisson-HMM by the EM Algorithm</a></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#forecasting-decoding-and-state-prediction"><i class="fa fa-check"></i>Forecasting, Decoding, and State Prediction</a>
<ul>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#forecasting"><i class="fa fa-check"></i>Forecasting</a></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#decoding-1"><i class="fa fa-check"></i>Decoding</a></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#state-predictions"><i class="fa fa-check"></i>State Predictions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="eq.html"><a href="eq.html#fitting-a-poisson-hmm-using-stan"><i class="fa fa-check"></i>Fitting a Poisson-HMM using STAN</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>9</b> Appendix</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hidden Markov Model Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="eq" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Major Earthquake Analysis<a href="eq.html#eq" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We apply the concepts in the previous chapters to the series of annual counts of major earthquakes (i.e. magnitude 7 and above) from the textbook.</p>
<p>The data can be read into <strong>R</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="eq.html#cb23-1" aria-hidden="true" tabindex="-1"></a>eq_dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;http://www.hmms-for-time-series.de/second/data/earthquakes.txt&quot;</span>)</span></code></pre></div>
<p>We use the following packages for the analysis</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="eq.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb24-2"><a href="eq.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb24-3"><a href="eq.html#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb24-4"><a href="eq.html#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb24-5"><a href="eq.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(momentuHMM)</span>
<span id="cb24-6"><a href="eq.html#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:e1"></span>
<img src="08-earthquake-example_files/figure-html/e1-1.png" alt="Number of major earthquakes worldwide from 1900-2006." width="672" />
<p class="caption">
Figure 8.1: Number of major earthquakes worldwide from 1900-2006.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:e2"></span>
<img src="08-earthquake-example_files/figure-html/e2-1.png" alt="Histogram of major earthquakes overlaid with a Poisson density of mean equal to the observed counts." width="672" />
<p class="caption">
Figure 8.2: Histogram of major earthquakes overlaid with a Poisson density of mean equal to the observed counts.
</p>
</div>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:e4">Table 8.1: </span>Summary of the major earthquakes.
</caption>
<thead>
<tr>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
variance
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
19.36
</td>
<td style="text-align:right;">
51.57
</td>
</tr>
</tbody>
</table>
<div id="fitting-a-poisson-mixture-distribution" class="section level2 unnumbered hasAnchor">
<h2>Fitting a Poisson Mixture Distribution<a href="eq.html#fitting-a-poisson-mixture-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Note:</strong> See <a href="prelim.html#prelim">Preliminaries</a></p>
<p>We may consider fitting a Poisson mixture distribution since earthquake counts are unbounded and there appears to be overdispersion as evident by the multimodal peaks in Figure <a href="eq.html#fig:e2">8.2</a> and sample variance <span class="math inline">\(s^2 \approx 52 &gt; 19 \approx \bar{x}\)</span> in Table <a href="eq.html#tab:e4">8.1</a>.</p>
<p>Suppose <span class="math inline">\(m=3\)</span> and the three components are Poisson-distributed with means <span class="math inline">\(\lambda_1, \lambda_2\)</span>, and <span class="math inline">\(\lambda_3\)</span>. Let <span class="math inline">\(\delta_1\)</span>, <span class="math inline">\(\delta_2\)</span>, and <span class="math inline">\(\delta_3\)</span> be the respective mixing parameters. The mixture distribution <span class="math inline">\(p\)</span> is given by</p>
<p><span class="math display">\[p(x) = \delta_1 \frac{\lambda_1^x e^{-\lambda_1}}{x!} + \delta_2 \frac{\lambda_2^x e^{-\lambda_2}}{x!} + \delta_3 \frac{\lambda_3^x e^{-\lambda_3}}{x!}\]</span></p>
<p>The likelihood is given by</p>
<p><span class="math display">\[L(\lambda_1, \lambda_2, \lambda_3, \delta_1, \delta_2|x_1, \dots, x_n) = \prod_{i=1}^n \left( \delta_1 \frac{\lambda_1^{x_i} e^{-\lambda_1}}{x_i!} + \delta_2 \frac{\lambda_2^{x_i} e^{-\lambda_2}}{x_i!} + (1 - \delta_1 - \delta_2) \frac{\lambda_3^{x_i} e^{-\lambda_3}}{x_i!} \right)\]</span></p>
<p>The log-likelihood can be maximized using the unconstrained optimizer <code>nlm</code> on reparameterized parameters by the following:</p>
<p><strong>Step 1</strong>: Reparameterize the “natural parameters” <span class="math inline">\(\boldsymbol{\delta}\)</span> and <span class="math inline">\(\boldsymbol{\lambda}\)</span> into “working parameters” <span class="math inline">\(\eta_i = \log \lambda_i \qquad{(i = 1, \dots, m)}\)</span> and <span class="math inline">\(\tau_i = \log \left(\frac{\delta_i}{1 - \sum_{j=2}^m \delta_j}\right) (i = 2, \dots, m)\)</span></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="eq.html#cb25-1" aria-hidden="true" tabindex="-1"></a>n2w <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, delta)<span class="fu">log</span>(<span class="fu">c</span>(lambda, delta[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">sum</span>(delta[<span class="sc">-</span><span class="dv">1</span>]))))</span></code></pre></div>
<p><strong>Step 2</strong>: Compute the negative log-likelihood using the working parameters</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="eq.html#cb26-1" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> <span class="cf">function</span>(wpar, x){</span>
<span id="cb26-2"><a href="eq.html#cb26-2" aria-hidden="true" tabindex="-1"></a>  zzz <span class="ot">&lt;-</span> <span class="fu">w2n</span>(wpar)</span>
<span id="cb26-3"><a href="eq.html#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">log</span>(<span class="fu">outer</span>(x, zzz<span class="sc">$</span>lambda, dpois)<span class="sc">%*%</span>zzz<span class="sc">$</span>delta))}</span></code></pre></div>
<p><strong>Step 3</strong>: Transform the parameters back into natural parameters</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="eq.html#cb27-1" aria-hidden="true" tabindex="-1"></a>w2n <span class="ot">&lt;-</span> <span class="cf">function</span>(wpar){</span>
<span id="cb27-2"><a href="eq.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> (<span class="fu">length</span>(wpar)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb27-3"><a href="eq.html#cb27-3" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(wpar[<span class="dv">1</span><span class="sc">:</span>m])</span>
<span id="cb27-4"><a href="eq.html#cb27-4" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">c</span>(<span class="dv">0</span>, wpar[(m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>m<span class="dv">-1</span>)]))</span>
<span id="cb27-5"><a href="eq.html#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda, <span class="at">delta=</span>delta<span class="sc">/</span><span class="fu">sum</span>(delta)))}</span></code></pre></div>
<p>Hence, for a Poisson mixture distribution with means <span class="math inline">\(\lambda_1, = 10, \lambda_2 = 20, \lambda_3 = 25\)</span> and probabilities <span class="math inline">\(\delta_1 = \delta_2 = \delta_3 = \frac{1}{3}\)</span>,</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="eq.html#cb28-1" aria-hidden="true" tabindex="-1"></a>wpar <span class="ot">&lt;-</span> <span class="fu">n2w</span>(<span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">25</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">/</span><span class="dv">3</span>)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="eq.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">w2n</span>(<span class="fu">nlm</span>(mllk, wpar, eq_dat<span class="sc">$</span>Count)<span class="sc">$</span>estimate)</span></code></pre></div>
<p>we obtain the following parameter estimates</p>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-9">Table 8.2: </span>Parameter estimates for the fitted three component Poisson independent mixture model.
</caption>
<thead>
<tr>
<th style="text-align:right;">
lambda
</th>
<th style="text-align:right;">
delta
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
12.73573
</td>
<td style="text-align:right;">
0.2775329
</td>
</tr>
<tr>
<td style="text-align:right;">
19.78515
</td>
<td style="text-align:right;">
0.5928037
</td>
</tr>
<tr>
<td style="text-align:right;">
31.62940
</td>
<td style="text-align:right;">
0.1296634
</td>
</tr>
</tbody>
</table>
<p>and the negative log likelihood</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="eq.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlm</span>(mllk, wpar, eq_dat<span class="sc">$</span>Count)<span class="sc">$</span>minimum</span></code></pre></div>
<pre><code>## [1] 356.8489</code></pre>
<p><strong>Note:</strong> See Table 1.2 and Figure 1.4 of the textbook for a comparison of fitted mixture models with varying number of components.</p>
</div>
<div id="fitting-a-poisson-hmm-by-numerical-maximization" class="section level2 unnumbered hasAnchor">
<h2>Fitting a Poisson-HMM by Numerical Maximization<a href="eq.html#fitting-a-poisson-hmm-by-numerical-maximization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Note:</strong> See <a href="introhmm.html#introhmm">Introduction to Hidden Markov Models</a> and Appendix A of the textbook.</p>
<div class="figure"><span style="display:block;" id="fig:acf"></span>
<img src="08-earthquake-example_files/figure-html/acf-1.png" alt="Autocorrelation plot for major earthquakes." width="672" />
<p class="caption">
Figure 8.3: Autocorrelation plot for major earthquakes.
</p>
</div>
<p>Instead of fitting an (independent) Poisson mixture distribution, we may consider fitting a Poisson-HMM to account for the strong, positive serial dependence as evident in Figure <a href="eq.html#fig:acf">8.3</a>.</p>
<p><strong>Step 1:</strong> Reparameterize the “natural parameters” <span class="math inline">\(\boldsymbol{\Gamma}, \boldsymbol{\lambda}\)</span>, and <span class="math inline">\(\boldsymbol{\delta}\)</span> to the “working parameters”.</p>
<p>Set
<span class="math display">\[\eta_i = \log \lambda_i \qquad{(i = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\nu_{ij} = \begin{cases} 1 &amp; \qquad{\text{for } i = j} \\ \log(\gamma_{ij}) &amp; \qquad{\text{for } i \neq j} \end{cases}\]</span></p>
<p><span class="math display">\[\delta_i = \begin{cases} \log \left(\frac{(\delta_2, \dots, \delta_m)}{\delta_1}\right) &amp; \qquad{\text{if not stationary}}\\ \text{NULL} &amp; \qquad{\text{otherwise}} \end{cases}\]</span></p>
<p>See <a href="numerical.html#reparam">Reparameterization to Avoid Constraints</a>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="eq.html#cb32-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.pn2pw <span class="ot">&lt;-</span> <span class="cf">function</span>(m,lambda,gamma,<span class="at">delta=</span><span class="cn">NULL</span>,<span class="at">stationary=</span><span class="cn">TRUE</span>){ </span>
<span id="cb32-2"><a href="eq.html#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="eq.html#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># eta = log(lambda)</span></span>
<span id="cb32-4"><a href="eq.html#cb32-4" aria-hidden="true" tabindex="-1"></a>  tlambda <span class="ot">&lt;-</span> <span class="fu">log</span>(lambda)</span>
<span id="cb32-5"><a href="eq.html#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(tlambda)</span>
<span id="cb32-6"><a href="eq.html#cb32-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb32-7"><a href="eq.html#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For i = j, nu_ii = 1 </span></span>
<span id="cb32-8"><a href="eq.html#cb32-8" aria-hidden="true" tabindex="-1"></a>  foo     <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma<span class="sc">/</span><span class="fu">diag</span>(gamma))</span>
<span id="cb32-9"><a href="eq.html#cb32-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-10"><a href="eq.html#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For i != j, nu_ij = log(gamma_ij)</span></span>
<span id="cb32-11"><a href="eq.html#cb32-11" aria-hidden="true" tabindex="-1"></a>  tgamma  <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(foo[<span class="sc">!</span><span class="fu">diag</span>(m)])</span>
<span id="cb32-12"><a href="eq.html#cb32-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-13"><a href="eq.html#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If stationary, set to pi = null</span></span>
<span id="cb32-14"><a href="eq.html#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stationary) {tdelta  <span class="ot">&lt;-</span> <span class="cn">NULL</span>}</span>
<span id="cb32-15"><a href="eq.html#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, pi = log((delta_2, ..., delta_m)/delta_1)</span></span>
<span id="cb32-16"><a href="eq.html#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {tdelta <span class="ot">&lt;-</span> <span class="fu">log</span>(delta[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">/</span>delta[<span class="dv">1</span>])}</span>
<span id="cb32-17"><a href="eq.html#cb32-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb32-18"><a href="eq.html#cb32-18" aria-hidden="true" tabindex="-1"></a>  parvect <span class="ot">&lt;-</span> <span class="fu">c</span>(tlambda,tgamma,tdelta)</span>
<span id="cb32-19"><a href="eq.html#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(parvect)</span>
<span id="cb32-20"><a href="eq.html#cb32-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.pn2pw</code> takes in arguments <code>m</code> number of states (numeric), <code>lambda</code> Poisson means (vector), <code>delta</code> initial probabilities, and <code>stationary</code> (<code>TRUE/FALSE</code>). By default, the MC is assumed to be stationary with the initial distribution equal to the stationary distribution. The function returns a vector containing the working parameters.</p>
<p><strong>Step 2:</strong> Compute the log-likelihood by the forward algorithm using the scaling strategy.</p>
<p>The general algorithm is:</p>
<p><span class="math inline">\(w_1 \leftarrow \boldsymbol{\delta P} (x_1) \boldsymbol{1&#39;};\)</span> <span class="math inline">\(\boldsymbol{\phi}_1 \leftarrow \boldsymbol{\delta P} (x_1);\)</span> <span class="math inline">\(l \leftarrow \log w_1\)</span></p>
<p>for <span class="math inline">\(t=2, 3, \dots, T\)</span></p>
<p><span class="math display">\[\begin{align}
\boldsymbol{v}
&amp;\leftarrow \boldsymbol{\phi}_{t-1} \boldsymbol{\Gamma P} (x_t)\\
u &amp; \leftarrow \boldsymbol{v 1&#39;}\\
l &amp;\leftarrow l + \log u\\
\boldsymbol{\phi}_t &amp; \leftarrow \frac{\boldsymbol{v}}{u}
\end{align}\]</span></p>
<p>See <a href="numerical.html#likscale">Scaling the Likelihood Computation</a> and Note (4).</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="eq.html#cb33-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.lforward <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod){</span>
<span id="cb33-2"><a href="eq.html#cb33-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-3"><a href="eq.html#cb33-3" aria-hidden="true" tabindex="-1"></a>  n             <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb33-4"><a href="eq.html#cb33-4" aria-hidden="true" tabindex="-1"></a>  lalpha        <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,mod<span class="sc">$</span>m,n)</span>
<span id="cb33-5"><a href="eq.html#cb33-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-6"><a href="eq.html#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># At time t=1</span></span>
<span id="cb33-7"><a href="eq.html#cb33-7" aria-hidden="true" tabindex="-1"></a>  foo           <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb33-8"><a href="eq.html#cb33-8" aria-hidden="true" tabindex="-1"></a>  sumfoo        <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb33-9"><a href="eq.html#cb33-9" aria-hidden="true" tabindex="-1"></a>  lscale        <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb33-10"><a href="eq.html#cb33-10" aria-hidden="true" tabindex="-1"></a>  foo           <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb33-11"><a href="eq.html#cb33-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-12"><a href="eq.html#cb33-12" aria-hidden="true" tabindex="-1"></a>  lalpha[,<span class="dv">1</span>]    <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(foo)</span>
<span id="cb33-13"><a href="eq.html#cb33-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-14"><a href="eq.html#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For t &gt; 1</span></span>
<span id="cb33-15"><a href="eq.html#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb33-16"><a href="eq.html#cb33-16" aria-hidden="true" tabindex="-1"></a>    foo          <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb33-17"><a href="eq.html#cb33-17" aria-hidden="true" tabindex="-1"></a>    sumfoo       <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb33-18"><a href="eq.html#cb33-18" aria-hidden="true" tabindex="-1"></a>    lscale       <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb33-19"><a href="eq.html#cb33-19" aria-hidden="true" tabindex="-1"></a>    foo          <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb33-20"><a href="eq.html#cb33-20" aria-hidden="true" tabindex="-1"></a>    lalpha[,i]   <span class="ot">&lt;-</span> <span class="fu">log</span>(foo)<span class="sc">+</span>lscale</span>
<span id="cb33-21"><a href="eq.html#cb33-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-22"><a href="eq.html#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(lalpha)</span>
<span id="cb33-23"><a href="eq.html#cb33-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.lforward</code> takes in arguments <code>x</code> data and <code>mod</code> list consisting of <code>m</code> states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities.</p>
<p><strong>Step 3:</strong> Maximize the log-likelihood/Minimize the negative log-likelihood</p>
<p>The function <code>nlm</code> in <strong>R</strong> performs the minimization of any function using a Newton-type algorithm. In order to minimize the negative log-likelihood, we first write a function that compute the negative log-likelihood from the working parameters. The same forward algorithm scheme applies.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="eq.html#cb34-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.mllk <span class="ot">&lt;-</span> <span class="cf">function</span>(parvect,x,m,<span class="at">stationary=</span><span class="cn">TRUE</span>,...)</span>
<span id="cb34-2"><a href="eq.html#cb34-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb34-3"><a href="eq.html#cb34-3" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(<span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(x,<span class="fu">exp</span>(parvect),<span class="at">log=</span><span class="cn">TRUE</span>)))</span>
<span id="cb34-4"><a href="eq.html#cb34-4" aria-hidden="true" tabindex="-1"></a> n        <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb34-5"><a href="eq.html#cb34-5" aria-hidden="true" tabindex="-1"></a> pn       <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pw2pn</span>(m,parvect,<span class="at">stationary=</span>stationary)</span>
<span id="cb34-6"><a href="eq.html#cb34-6" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> pn<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],pn<span class="sc">$</span>lambda)</span>
<span id="cb34-7"><a href="eq.html#cb34-7" aria-hidden="true" tabindex="-1"></a> sumfoo   <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb34-8"><a href="eq.html#cb34-8" aria-hidden="true" tabindex="-1"></a> lscale   <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb34-9"><a href="eq.html#cb34-9" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb34-10"><a href="eq.html#cb34-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb34-11"><a href="eq.html#cb34-11" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb34-12"><a href="eq.html#cb34-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(x[i])){P<span class="ot">&lt;-</span><span class="fu">dpois</span>(x[i],pn<span class="sc">$</span>lambda)}</span>
<span id="cb34-13"><a href="eq.html#cb34-13" aria-hidden="true" tabindex="-1"></a>     <span class="cf">else</span> {P<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span>,m)}</span>
<span id="cb34-14"><a href="eq.html#cb34-14" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo <span class="sc">%*%</span> pn<span class="sc">$</span>gamma<span class="sc">*</span>P</span>
<span id="cb34-15"><a href="eq.html#cb34-15" aria-hidden="true" tabindex="-1"></a>   sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb34-16"><a href="eq.html#cb34-16" aria-hidden="true" tabindex="-1"></a>   lscale <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb34-17"><a href="eq.html#cb34-17" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb34-18"><a href="eq.html#cb34-18" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb34-19"><a href="eq.html#cb34-19" aria-hidden="true" tabindex="-1"></a> mllk     <span class="ot">&lt;-</span> <span class="sc">-</span>lscale</span>
<span id="cb34-20"><a href="eq.html#cb34-20" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(mllk)</span>
<span id="cb34-21"><a href="eq.html#cb34-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Step 4</strong>: Transform the parameters back into natural parameters.</p>
<p>Set</p>
<p><span class="math display">\[\hat{\lambda_i} = \exp(\hat{\eta_i}) \qquad{(i = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\hat{\gamma}_{ij} = \frac{\exp(\hat{\nu_{ik}})}{\sum_{k=1, k \neq i}^m\exp(\hat{\nu_ik})} \qquad{\text{for } (i, j = 1, \dots, m)}\]</span></p>
<p><span class="math display">\[\hat{\boldsymbol{\delta}} = \begin{cases} \boldsymbol{1} (\boldsymbol{I} - \hat{\boldsymbol{\Gamma}} + \boldsymbol{U})^{-1}&amp; \qquad{\text{if stationary}}\\ \frac{(1, \exp(\hat{\delta_2}), \dots, \exp(\hat{\delta}_m))}{1 + \exp(\hat{\delta_2}) + \dots + \exp(\hat{\delta}_m)} &amp; \qquad{\text{otherwise}} \end{cases}\]</span></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="eq.html#cb35-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.pw2pn <span class="ot">&lt;-</span> <span class="cf">function</span>(m,parvect,<span class="at">stationary=</span><span class="cn">TRUE</span>){</span>
<span id="cb35-2"><a href="eq.html#cb35-2" aria-hidden="true" tabindex="-1"></a> lambda        <span class="ot">&lt;-</span> <span class="fu">exp</span>(parvect[<span class="dv">1</span><span class="sc">:</span>m])</span>
<span id="cb35-3"><a href="eq.html#cb35-3" aria-hidden="true" tabindex="-1"></a> gamma         <span class="ot">&lt;-</span> <span class="fu">diag</span>(m)</span>
<span id="cb35-4"><a href="eq.html#cb35-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (m<span class="sc">==</span><span class="dv">1</span>) <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda,<span class="at">gamma=</span>gamma,<span class="at">delta=</span><span class="dv">1</span>))</span>
<span id="cb35-5"><a href="eq.html#cb35-5" aria-hidden="true" tabindex="-1"></a> gamma[<span class="sc">!</span>gamma] <span class="ot">&lt;-</span> <span class="fu">exp</span>(parvect[(m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(m<span class="sc">*</span>m)])</span>
<span id="cb35-6"><a href="eq.html#cb35-6" aria-hidden="true" tabindex="-1"></a> gamma         <span class="ot">&lt;-</span> gamma<span class="sc">/</span><span class="fu">apply</span>(gamma,<span class="dv">1</span>,sum)</span>
<span id="cb35-7"><a href="eq.html#cb35-7" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(stationary){delta<span class="ot">&lt;-</span><span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">diag</span>(m)<span class="sc">-</span>gamma<span class="sc">+</span><span class="dv">1</span>),<span class="fu">rep</span>(<span class="dv">1</span>,m))}</span>
<span id="cb35-8"><a href="eq.html#cb35-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> {foo<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">exp</span>(parvect[(m<span class="sc">*</span>m<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(m<span class="sc">*</span>m<span class="sc">+</span>m<span class="dv">-1</span>)]))</span>
<span id="cb35-9"><a href="eq.html#cb35-9" aria-hidden="true" tabindex="-1"></a>   delta<span class="ot">&lt;-</span>foo<span class="sc">/</span><span class="fu">sum</span>(foo)}</span>
<span id="cb35-10"><a href="eq.html#cb35-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda=</span>lambda,<span class="at">gamma=</span>gamma,<span class="at">delta=</span>delta))</span>
<span id="cb35-11"><a href="eq.html#cb35-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.pw2pn</code> takes in arguments <code>m</code> number of states, <code>parvect</code> working parameters (vector), and <code>stationary</code> (<code>TRUE/FALSE</code>). By default, the MC is assumed to be stationary with the initial distribution equal to the stationary distribution. The function returns a list containing the natural parameters.</p>
<p>We can combine the parts above into the <code>pois.HMM.mle</code> function.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="eq.html#cb36-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.mle <span class="ot">&lt;-</span> <span class="cf">function</span>(x,m,lambda0,gamma0,<span class="at">delta0=</span><span class="cn">NULL</span>,<span class="at">stationary=</span><span class="cn">TRUE</span>,...){</span>
<span id="cb36-2"><a href="eq.html#cb36-2" aria-hidden="true" tabindex="-1"></a> parvect0  <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m,lambda0,gamma0,delta0,<span class="at">stationary=</span>stationary)</span>
<span id="cb36-3"><a href="eq.html#cb36-3" aria-hidden="true" tabindex="-1"></a> mod       <span class="ot">&lt;-</span> <span class="fu">nlm</span>(pois.HMM.mllk,parvect0,<span class="at">x=</span>x,<span class="at">m=</span>m,<span class="at">stationary=</span>stationary)</span>
<span id="cb36-4"><a href="eq.html#cb36-4" aria-hidden="true" tabindex="-1"></a> pn        <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pw2pn</span>(<span class="at">m=</span>m,mod<span class="sc">$</span>estimate,<span class="at">stationary=</span>stationary)</span>
<span id="cb36-5"><a href="eq.html#cb36-5" aria-hidden="true" tabindex="-1"></a> mllk      <span class="ot">&lt;-</span> mod<span class="sc">$</span>minimum</span>
<span id="cb36-6"><a href="eq.html#cb36-6" aria-hidden="true" tabindex="-1"></a> np        <span class="ot">&lt;-</span> <span class="fu">length</span>(parvect0)</span>
<span id="cb36-7"><a href="eq.html#cb36-7" aria-hidden="true" tabindex="-1"></a> AIC       <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>(mllk<span class="sc">+</span>np)</span>
<span id="cb36-8"><a href="eq.html#cb36-8" aria-hidden="true" tabindex="-1"></a> n         <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(x))</span>
<span id="cb36-9"><a href="eq.html#cb36-9" aria-hidden="true" tabindex="-1"></a> BIC       <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>mllk<span class="sc">+</span>np<span class="sc">*</span><span class="fu">log</span>(n)</span>
<span id="cb36-10"><a href="eq.html#cb36-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">list</span>(<span class="at">m=</span>m,<span class="at">lambda=</span>pn<span class="sc">$</span>lambda,<span class="at">gamma=</span>pn<span class="sc">$</span>gamma,<span class="at">delta=</span>pn<span class="sc">$</span>delta,<span class="at">code=</span>mod<span class="sc">$</span>code,<span class="at">mllk=</span>mllk,<span class="at">AIC=</span>AIC,<span class="at">BIC=</span>BIC)</span>
<span id="cb36-11"><a href="eq.html#cb36-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Hence, for a three-state Poisson-HMM with the following parameters</p>
<p><span class="math display">\[\boldsymbol{\lambda} = (10, 20, 25)\]</span></p>
<p><span class="math display">\[\boldsymbol{\Gamma} = \begin{pmatrix} 0.8 &amp; 0.1 &amp; 0.1\\ 0.1 &amp; 0.8 &amp; 0.1\\ 0.1 &amp; 0.1 &amp; 0.8 \end{pmatrix}\]</span></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="eq.html#cb37-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb37-2"><a href="eq.html#cb37-2" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">25</span>)</span>
<span id="cb37-3"><a href="eq.html#cb37-3" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.8</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.8</span>),<span class="dv">3</span>,<span class="dv">3</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>if we assume that the MC is stationary</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="eq.html#cb38-1" aria-hidden="true" tabindex="-1"></a>eq_init_s <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m,</span>
<span id="cb38-2"><a href="eq.html#cb38-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">lambda=</span>lambda,</span>
<span id="cb38-3"><a href="eq.html#cb38-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">gamma =</span> gamma)</span>
<span id="cb38-4"><a href="eq.html#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="eq.html#cb38-5" aria-hidden="true" tabindex="-1"></a>(mod3s<span class="ot">&lt;-</span><span class="fu">pois.HMM.mle</span>(eq_dat<span class="sc">$</span>Count, eq_init_s<span class="sc">$</span>m,eq_init_s<span class="sc">$</span>lambda,eq_init_s<span class="sc">$</span>gamma,<span class="at">stationary=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.14573 19.72101 29.71437
## 
## $gamma
##              [,1]      [,2]       [,3]
## [1,] 9.546243e-01 0.0244426 0.02093313
## [2,] 4.976679e-02 0.8993673 0.05086592
## [3,] 1.504495e-09 0.1966420 0.80335799
## 
## $delta
## [1] 0.4436420 0.4044983 0.1518597
## 
## $code
## [1] 1
## 
## $mllk
## [1] 329.4603
## 
## $AIC
## [1] 676.9206
## 
## $BIC
## [1] 700.976</code></pre>
<p>and if we do not assume stationary and that <span class="math inline">\(\boldsymbol{\delta} = (\frac{1}{3}, \frac{1}{3}, \frac{1}{3})\)</span> and that the initial distribution is <span class="math inline">\(\boldsymbol{\delta} = (\frac{1}{3}, \frac{1}{3}, \frac{1}{3})\)</span></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="eq.html#cb40-1" aria-hidden="true" tabindex="-1"></a>eq_init_ns <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m,</span>
<span id="cb40-2"><a href="eq.html#cb40-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">lambda=</span>lambda,</span>
<span id="cb40-3"><a href="eq.html#cb40-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">gamma =</span> gamma,</span>
<span id="cb40-4"><a href="eq.html#cb40-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">delta =</span> <span class="fu">rep</span>(<span class="dv">1</span>, m)<span class="sc">/</span>m)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="eq.html#cb41-1" aria-hidden="true" tabindex="-1"></a>(mod3h <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(eq_dat<span class="sc">$</span>Count,eq_init_ns<span class="sc">$</span>m,eq_init_ns<span class="sc">$</span>lambda,eq_init_ns<span class="sc">$</span>gamma,<span class="at">delta=</span>eq_init_ns<span class="sc">$</span>delta,<span class="at">stationary=</span><span class="cn">FALSE</span>))</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.13374 19.71312 29.70964
## 
## $gamma
##              [,1]       [,2]       [,3]
## [1,] 9.392937e-01 0.03209754 0.02860881
## [2,] 4.040106e-02 0.90643731 0.05316163
## [3,] 9.052023e-12 0.19025401 0.80974599
## 
## $delta
## [1] 9.999998e-01 8.700482e-08 8.281945e-08
## 
## $code
## [1] 1
## 
## $mllk
## [1] 328.5275
## 
## $AIC
## [1] 679.055
## 
## $BIC
## [1] 708.4561</code></pre>
<div id="parametric-bootstrapping-for-confidence-intervals" class="section level3 unnumbered hasAnchor">
<h3>Parametric Bootstrapping for Confidence Intervals<a href="eq.html#parametric-bootstrapping-for-confidence-intervals" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also perform parameteric bootstrapping to obtain confidence intervals of the above estimates.</p>
<p><strong>Note:</strong> See <a href="numerical.html#boot">Obtaining Standard Errors and Confidence Intervals</a>.</p>
<p><strong>Step 1</strong>: Fit the model</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="eq.html#cb43-1" aria-hidden="true" tabindex="-1"></a>eq_mle <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(eq_dat<span class="sc">$</span>Count,eq_init_ns<span class="sc">$</span>m,eq_init_ns<span class="sc">$</span>lambda,eq_init_ns<span class="sc">$</span>gamma,<span class="at">delta=</span>eq_init_ns<span class="sc">$</span>delta,<span class="at">stationary=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><strong>Step 2</strong>: Generate a bootstrap sample from the fitted model.</p>
<p>The following function generates a sample from a Poisson-HMM of length <code>ny</code> from starting values <code>m</code> number of states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities which are stored as <code>mod</code> (list).</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="eq.html#cb44-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_sample  <span class="ot">&lt;-</span> <span class="cf">function</span>(ny,mod){</span>
<span id="cb44-2"><a href="eq.html#cb44-2" aria-hidden="true" tabindex="-1"></a> mvect                    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m</span>
<span id="cb44-3"><a href="eq.html#cb44-3" aria-hidden="true" tabindex="-1"></a> state                    <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ny)</span>
<span id="cb44-4"><a href="eq.html#cb44-4" aria-hidden="true" tabindex="-1"></a> state[<span class="dv">1</span>]                 <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect,<span class="dv">1</span>,<span class="at">prob=</span>mod<span class="sc">$</span>delta)</span>
<span id="cb44-5"><a href="eq.html#cb44-5" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ny) state[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect,<span class="dv">1</span>,<span class="at">prob=</span>mod<span class="sc">$</span>gamma[state[i<span class="dv">-1</span>],])</span>
<span id="cb44-6"><a href="eq.html#cb44-6" aria-hidden="true" tabindex="-1"></a> x                        <span class="ot">&lt;-</span> <span class="fu">rpois</span>(ny,<span class="at">lambda=</span>mod<span class="sc">$</span>lambda[state])</span>
<span id="cb44-7"><a href="eq.html#cb44-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(x)</span>
<span id="cb44-8"><a href="eq.html#cb44-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="eq.html#cb45-1" aria-hidden="true" tabindex="-1"></a>boot_sample <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="fu">length</span>(eq_dat<span class="sc">$</span>Count), eq_mle)</span></code></pre></div>
<p><strong>Step 3</strong>: Estimate parameters using the bootstrap sample.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="eq.html#cb46-1" aria-hidden="true" tabindex="-1"></a>boot_mle <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(boot_sample, eq_mle<span class="sc">$</span>m, eq_mle<span class="sc">$</span>lambda, eq_mle<span class="sc">$</span>gamma)</span></code></pre></div>
<pre><code>## Warning in nlm(pois.HMM.mllk, parvect0, x = x, m = m, stationary = stationary):
## NA/Inf replaced by maximum positive value</code></pre>
<p><strong>Step 4</strong>: Repeat (for a large) B times.</p>
<p>We can combine the parts above into the <code>pois.HMM.boot</code> function.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="eq.html#cb48-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.boot <span class="ot">&lt;-</span> <span class="cf">function</span>(B, x, m, lambda0, gamma0, <span class="at">delta0=</span><span class="cn">NULL</span>, <span class="at">stationary=</span><span class="cn">TRUE</span>){</span>
<span id="cb48-2"><a href="eq.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-3"><a href="eq.html#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model</span></span>
<span id="cb48-4"><a href="eq.html#cb48-4" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(x, m, lambda0, gamma0, <span class="at">stationary=</span>stationary)</span>
<span id="cb48-5"><a href="eq.html#cb48-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-6"><a href="eq.html#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize</span></span>
<span id="cb48-7"><a href="eq.html#cb48-7" aria-hidden="true" tabindex="-1"></a>  bs_sample <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb48-8"><a href="eq.html#cb48-8" aria-hidden="true" tabindex="-1"></a>  bs_mod <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb48-9"><a href="eq.html#cb48-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-10"><a href="eq.html#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate B bootstrap samples</span></span>
<span id="cb48-11"><a href="eq.html#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb48-12"><a href="eq.html#cb48-12" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb48-13"><a href="eq.html#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(a){</span>
<span id="cb48-14"><a href="eq.html#cb48-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb48-15"><a href="eq.html#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(i)</span>
<span id="cb48-16"><a href="eq.html#cb48-16" aria-hidden="true" tabindex="-1"></a>        bs_sample[[i]] <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="fu">length</span>(x), mod)</span>
<span id="cb48-17"><a href="eq.html#cb48-17" aria-hidden="true" tabindex="-1"></a>        bs_mod[[i]] <span class="ot">&lt;-</span> <span class="fu">pois.HMM.mle</span>(bs_sample[[i]], m, mod<span class="sc">$</span>lambda, mod<span class="sc">$</span>gamma, mod<span class="sc">$</span>delta)</span>
<span id="cb48-18"><a href="eq.html#cb48-18" aria-hidden="true" tabindex="-1"></a>        a <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb48-19"><a href="eq.html#cb48-19" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb48-20"><a href="eq.html#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">error=</span><span class="cf">function</span>(w){</span>
<span id="cb48-21"><a href="eq.html#cb48-21" aria-hidden="true" tabindex="-1"></a>          a <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb48-22"><a href="eq.html#cb48-22" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb48-23"><a href="eq.html#cb48-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-24"><a href="eq.html#cb48-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-25"><a href="eq.html#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bs_mod)</span>
<span id="cb48-26"><a href="eq.html#cb48-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> Some errors would occasionally arise from solving the stationary distribution of bootstrap samples that may not have had a unique stationary distribution. To overcome this, the <code>tryCatch</code> function was used to throw out these problematic samples and regenerate a new sample. As there were at most two samples that resulted in the error, the generated bootstrap samples should still be representative of the dataset.</p>
<p>Hence, for the three-state Poisson-HMM with parameters</p>
<p><span class="math display">\[\boldsymbol{\lambda} = (10, 20, 25)\]</span></p>
<p><span class="math display">\[\boldsymbol{\Gamma} = \begin{pmatrix} 0.8 &amp; 0.1 &amp; 0.1\\ 0.1 &amp; 0.8 &amp; 0.1\\ 0.1 &amp; 0.1 &amp; 0.8 \end{pmatrix}\]</span></p>
<p><span class="math display">\[\boldsymbol{\delta} = (\frac{1}{3}, \frac{1}{3}, \frac{1}{3})\]</span></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="eq.html#cb49-1" aria-hidden="true" tabindex="-1"></a>eq_boot <span class="ot">&lt;-</span> <span class="fu">pois.HMM.boot</span>(<span class="dv">500</span>, eq_dat<span class="sc">$</span>Count, eq_init_ns<span class="sc">$</span>m, eq_init_ns<span class="sc">$</span>lambda, eq_init_ns<span class="sc">$</span>gamma, <span class="at">delta=</span>eq_init_ns<span class="sc">$</span>delta)</span></code></pre></div>
<p>and the <span class="math inline">\(90\%\)</span> confidence interval using the “percentile method”</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="eq.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe for parameters from bootstrap samples</span></span>
<span id="cb50-2"><a href="eq.html#cb50-2" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">2</span>)</span>
<span id="cb50-3"><a href="eq.html#cb50-3" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_lambda_boot)</span>
<span id="cb50-4"><a href="eq.html#cb50-4" aria-hidden="true" tabindex="-1"></a>eq_lambda_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_lambda_boot)</span>
<span id="cb50-5"><a href="eq.html#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="eq.html#cb50-6" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">3</span>)</span>
<span id="cb50-7"><a href="eq.html#cb50-7" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_gamma_boot)</span>
<span id="cb50-8"><a href="eq.html#cb50-8" aria-hidden="true" tabindex="-1"></a>eq_gamma_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_gamma_boot)</span>
<span id="cb50-9"><a href="eq.html#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="eq.html#cb50-10" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">sapply</span>(eq_boot, <span class="st">&quot;[[&quot;</span>, <span class="dv">4</span>)</span>
<span id="cb50-11"><a href="eq.html#cb50-11" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(eq_delta_boot)</span>
<span id="cb50-12"><a href="eq.html#cb50-12" aria-hidden="true" tabindex="-1"></a>eq_delta_boot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(eq_delta_boot)</span>
<span id="cb50-13"><a href="eq.html#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="eq.html#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the 90% confidence interval</span></span>
<span id="cb50-15"><a href="eq.html#cb50-15" aria-hidden="true" tabindex="-1"></a>eq_boot_df <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">cbind</span>(<span class="fu">sapply</span>(eq_lambda_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)),</span>
<span id="cb50-16"><a href="eq.html#cb50-16" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(eq_gamma_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)),</span>
<span id="cb50-17"><a href="eq.html#cb50-17" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sapply</span>(eq_delta_boot, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb50-18"><a href="eq.html#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() </span>
<span id="cb50-19"><a href="eq.html#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="eq.html#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;lambda&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb50-21"><a href="eq.html#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb50-22"><a href="eq.html#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb50-23"><a href="eq.html#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>, <span class="dv">3</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb50-24"><a href="eq.html#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(eq_boot_df)[<span class="dv">13</span><span class="sc">:</span><span class="dv">15</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;delta&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb50-25"><a href="eq.html#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="eq.html#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="eq.html#cb50-27" aria-hidden="true" tabindex="-1"></a>eq_boot_df <span class="sc">%&gt;%</span></span>
<span id="cb50-28"><a href="eq.html#cb50-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-29"><a href="eq.html#cb50-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">&quot;Bootstrap 90% Confidence Intervals for the parameters of the three-state HMM.&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-30"><a href="eq.html#cb50-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_minimal</span>(<span class="at">full_width=</span>T)</span></code></pre></div>
<table class=" lightable-minimal" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-26">Table 8.3: </span>Bootstrap 90% Confidence Intervals for the parameters of the three-state HMM.
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
5%
</th>
<th style="text-align:right;">
95%
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
lambda1
</td>
<td style="text-align:right;">
11.8405
</td>
<td style="text-align:right;">
14.6116
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda2
</td>
<td style="text-align:right;">
16.9308
</td>
<td style="text-align:right;">
22.0249
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda3
</td>
<td style="text-align:right;">
19.4806
</td>
<td style="text-align:right;">
33.0097
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma11
</td>
<td style="text-align:right;">
0.8232
</td>
<td style="text-align:right;">
0.9880
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma12
</td>
<td style="text-align:right;">
0.0137
</td>
<td style="text-align:right;">
0.2132
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma13
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma21
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1162
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma22
</td>
<td style="text-align:right;">
0.6603
</td>
<td style="text-align:right;">
0.9637
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma23
</td>
<td style="text-align:right;">
0.0515
</td>
<td style="text-align:right;">
0.5534
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma31
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1108
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma32
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
0.1908
</td>
</tr>
<tr>
<td style="text-align:left;">
gamma33
</td>
<td style="text-align:right;">
0.4466
</td>
<td style="text-align:right;">
0.9485
</td>
</tr>
<tr>
<td style="text-align:left;">
delta1
</td>
<td style="text-align:right;">
0.1370
</td>
<td style="text-align:right;">
0.7485
</td>
</tr>
<tr>
<td style="text-align:left;">
delta2
</td>
<td style="text-align:right;">
0.1114
</td>
<td style="text-align:right;">
0.6606
</td>
</tr>
<tr>
<td style="text-align:left;">
delta3
</td>
<td style="text-align:right;">
0.0404
</td>
<td style="text-align:right;">
0.3770
</td>
</tr>
</tbody>
</table>
<div class="figure"><span style="display:block;" id="fig:boot"></span>
<img src="08-earthquake-example_files/figure-html/boot-1.png" alt="500 Bootstrap samples for the state-dependent parameters of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 8.4: 500 Bootstrap samples for the state-dependent parameters of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:boot3"></span>
<img src="08-earthquake-example_files/figure-html/boot3-1.png" alt="500 Bootstrap samples for the initial probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 8.5: 500 Bootstrap samples for the initial probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:boot2"></span>
<img src="08-earthquake-example_files/figure-html/boot2-1.png" alt="500 Bootstrap samples for the transition probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval." width="672" />
<p class="caption">
Figure 8.6: 500 Bootstrap samples for the transition probabilities of the fitted three-state Poisson-HMM. The area within the red dotted lines correspond to the 90% confidence interval.
</p>
</div>
</div>
<div id="using-momentuhmm" class="section level3 unnumbered hasAnchor">
<h3>Using <code>momentuHMM</code><a href="eq.html#using-momentuhmm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also fit the three-state Poisson-HMM from the above using <code>momentuHMM</code>, which is a popular package for the maximum likelihood analysis of animal movement behaviour using multivariate Hidden Markov Models. <span class="citation">McClintock and Michelot (<a href="#ref-momentuhmm" role="doc-biblioref">2018</a>)</span></p>
<p>First, convert the data into the <code>prepData</code> object and set the names of the states. Since</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="eq.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prepData</span></span>
<span id="cb51-2"><a href="eq.html#cb51-2" aria-hidden="true" tabindex="-1"></a>eq_prepped <span class="ot">&lt;-</span> <span class="fu">prepData</span>(eq_dat,</span>
<span id="cb51-3"><a href="eq.html#cb51-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coordNames =</span> <span class="cn">NULL</span>,</span>
<span id="cb51-4"><a href="eq.html#cb51-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">covNames =</span>  <span class="fu">c</span>(<span class="st">&quot;Count&quot;</span>))</span>
<span id="cb51-5"><a href="eq.html#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="eq.html#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the states</span></span>
<span id="cb51-7"><a href="eq.html#cb51-7" aria-hidden="true" tabindex="-1"></a>stateNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;state1&quot;</span>, <span class="st">&quot;state2&quot;</span>, <span class="st">&quot;state3&quot;</span>)</span></code></pre></div>
<p>Next, specify the state-dependent model. In our case, we fit the intercept only model.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="eq.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit intercept only model</span></span>
<span id="cb52-2"><a href="eq.html#cb52-2" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> <span class="er">~</span> <span class="dv">1</span></span></code></pre></div>
<p>Now, fit the model using <code>fitHMM</code></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="eq.html#cb53-1" aria-hidden="true" tabindex="-1"></a>mod3h_momentuHMM <span class="ot">&lt;-</span> <span class="fu">fitHMM</span>(eq_prepped, </span>
<span id="cb53-2"><a href="eq.html#cb53-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">nbStates=</span><span class="dv">3</span>, </span>
<span id="cb53-3"><a href="eq.html#cb53-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">dist=</span><span class="fu">list</span>(<span class="at">Count=</span><span class="st">&quot;pois&quot;</span>),</span>
<span id="cb53-4"><a href="eq.html#cb53-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">Par0 =</span> <span class="fu">list</span>(<span class="at">Count =</span> eq_init_ns<span class="sc">$</span>lambda, <span class="at">delta=</span>eq_init_ns<span class="sc">$</span>delta),</span>
<span id="cb53-5"><a href="eq.html#cb53-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">formula =</span> formula,</span>
<span id="cb53-6"><a href="eq.html#cb53-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">stateNames =</span> stateNames,</span>
<span id="cb53-7"><a href="eq.html#cb53-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">stationary =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The resulting MLEs are very similar to that obtained from running the functions from above.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="eq.html#cb54-1" aria-hidden="true" tabindex="-1"></a>mod3h_momentuHMM </span></code></pre></div>
<pre><code>## Value of the maximum log-likelihood: -328.5884 
## 
## 
## Count parameters:
## -----------------
##          state1   state2   state3
## lambda 13.13513 19.70822 29.70794
## 
## Regression coeffs for the transition probabilities:
## ---------------------------------------------------
##               1 -&gt; 2    1 -&gt; 3    2 -&gt; 1   2 -&gt; 3    3 -&gt; 1    3 -&gt; 2
## (Intercept) -3.42222 -3.520977 -3.119039 -2.83615 -28.60659 -1.448253
## 
## Transition probability matrix:
## ------------------------------
##              state1     state2     state3
## state1 9.414330e-01 0.03072828 0.02783867
## state2 4.007763e-02 0.90674107 0.05318130
## state3 3.052488e-13 0.19027062 0.80972938
## 
## Initial distribution:
## ---------------------
##       state1       state2       state3 
## 1.000000e+00 1.833456e-08 1.427794e-08</code></pre>
<p>The corresponding <span class="math inline">\(95 \%\)</span> confidence intervals are</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="eq.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CIreal</span>(mod3h_momentuHMM)</span></code></pre></div>
<pre><code>## $Count
## $Count$est
##          state1   state2   state3
## lambda 13.13513 19.70822 29.70794
## 
## $Count$se
##           state1    state2   state3
## lambda 0.6600995 0.8708107 1.679509
## 
## $Count$lower
##          state1   state2   state3
## lambda 11.84136 18.00146 26.41616
## 
## $Count$upper
##         state1   state2   state3
## lambda 14.4289 21.41497 32.99972
## 
## 
## $gamma
## $gamma$est
##              state1     state2     state3
## state1 9.414330e-01 0.03072828 0.02783867
## state2 4.007763e-02 0.90674107 0.05318130
## state3 3.052488e-13 0.19027062 0.80972938
## 
## $gamma$se
##              state1     state2     state3
## state1 4.445528e-02 0.04082282 0.03293175
## state2 3.190339e-02 0.05399426 0.04414623
## state3 4.291928e-14 0.11385140 0.11385140
## 
## $gamma$lower
##              state1      state2      state3
## state1 7.679853e-01 0.002155143 0.002630290
## state2 8.151374e-03 0.735557101 0.009973817
## state3 2.317242e-13 0.052321545 0.499974591
## 
## $gamma$upper
##              state1    state2    state3
## state1 9.873516e-01 0.3175655 0.2371871
## state2 1.749874e-01 0.9714172 0.2384795
## state3 4.021022e-13 0.5000254 0.9476785
## 
## 
## $delta
## $delta$est
##            state1       state2       state3
## ID:Animal1      1 1.833456e-08 1.427794e-08
## 
## $delta$se
##                  state1       state2       state3
## ID:Animal1 1.046115e-13 1.046128e-13 1.493643e-21
## 
## $delta$lower
##            state1       state2       state3
## ID:Animal1      1 1.833436e-08 1.427794e-08
## 
## $delta$upper
##            state1       state2       state3
## ID:Animal1      1 1.833477e-08 1.427794e-08</code></pre>
</div>
</div>
<div id="fitting-a-poisson-hmm-by-the-em-algorithm" class="section level2 unnumbered hasAnchor">
<h2>Fitting a Poisson-HMM by the EM Algorithm<a href="eq.html#fitting-a-poisson-hmm-by-the-em-algorithm" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Note:</strong> See <a href="em.html#em">EM Algorithm (Baum-Welch)</a></p>
<p>Alternatively, we may obtain MLEs of the three-state Poisson HMM by the EM algorithm.</p>
<p><strong>E-Step</strong> Replace all quantities <span class="math inline">\(v_jk (t)\)</span>, <span class="math inline">\(u_j (t)\)</span> by their conditional expectations given the observations <span class="math inline">\(\boldsymbol{x}^{(T)}\)</span> and current parameter estimates:</p>
<p><span class="math display">\[\hat{u}_j = \Pr (C_t = j|\boldsymbol{x}^{(T)}) = \frac{\alpha_t (j) \beta_t (j)}{L_T}\]</span></p>
<p><span class="math display">\[{\hat{v}}_{jk} (t) = \Pr (C_{t-1} = j, C_t = k| \boldsymbol{x}^{(T)}) \frac{\alpha_{t-1} (j) \gamma_{jk} p_k (x_t) \beta_t (k)}{L_T}\]</span></p>
<p>This can be broken down into</p>
<p><strong>Step 1</strong>: Compute the forward and backward probabilities.</p>
<p>We can use the same forward algorithm from the above and apply the backward algorithm <code>pois.HMM.lbackward</code>.</p>
<p>The general algorithm is:</p>
<p><span class="math display">\[\begin{align}
\boldsymbol{\phi}_T \leftarrow \frac{\boldsymbol{1}}{w_T}$; $l \leftarrow \log w_T\\
\text{for } t = T-1, \dots, 1\\
\boldsymbol{v} &amp;\leftarrow \boldsymbol{\Gamma P} (x_{t+1}) \boldsymbol{\phi_{t+1}}\\
l &amp;\leftarrow l + \log \boldsymbol{v}\\
u &amp;\leftarrow \boldsymbol{v 1&#39;}\\
\boldsymbol{\phi}_t &amp;\leftarrow \frac{\boldsymbol{v}}{u}\\
l &amp; \leftarrow l + \log u
\end{align}\]</span></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="eq.html#cb58-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.lbackward<span class="ot">&lt;-</span><span class="cf">function</span>(x,mod){</span>
<span id="cb58-2"><a href="eq.html#cb58-2" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb58-3"><a href="eq.html#cb58-3" aria-hidden="true" tabindex="-1"></a> m          <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb58-4"><a href="eq.html#cb58-4" aria-hidden="true" tabindex="-1"></a> lbeta      <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,m,n)</span>
<span id="cb58-5"><a href="eq.html#cb58-5" aria-hidden="true" tabindex="-1"></a> lbeta[,n]  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,m)</span>
<span id="cb58-6"><a href="eq.html#cb58-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb58-7"><a href="eq.html#cb58-7" aria-hidden="true" tabindex="-1"></a> <span class="co"># For t = T</span></span>
<span id="cb58-8"><a href="eq.html#cb58-8" aria-hidden="true" tabindex="-1"></a> foo        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>m,m)</span>
<span id="cb58-9"><a href="eq.html#cb58-9" aria-hidden="true" tabindex="-1"></a> lscale     <span class="ot">&lt;-</span> <span class="fu">log</span>(m)</span>
<span id="cb58-10"><a href="eq.html#cb58-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb58-11"><a href="eq.html#cb58-11" aria-hidden="true" tabindex="-1"></a> <span class="co"># For t = (T-1),..., 1</span></span>
<span id="cb58-12"><a href="eq.html#cb58-12" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> (n<span class="dv">-1</span>)<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb58-13"><a href="eq.html#cb58-13" aria-hidden="true" tabindex="-1"></a>    foo        <span class="ot">&lt;-</span> mod<span class="sc">$</span>gamma<span class="sc">%*%</span>(<span class="fu">dpois</span>(x[i<span class="sc">+</span><span class="dv">1</span>],mod<span class="sc">$</span>lambda)<span class="sc">*</span>foo)</span>
<span id="cb58-14"><a href="eq.html#cb58-14" aria-hidden="true" tabindex="-1"></a>    lbeta[,i]  <span class="ot">&lt;-</span> <span class="fu">log</span>(foo)<span class="sc">+</span>lscale</span>
<span id="cb58-15"><a href="eq.html#cb58-15" aria-hidden="true" tabindex="-1"></a>    sumfoo     <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb58-16"><a href="eq.html#cb58-16" aria-hidden="true" tabindex="-1"></a>    foo        <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb58-17"><a href="eq.html#cb58-17" aria-hidden="true" tabindex="-1"></a>    lscale     <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb58-18"><a href="eq.html#cb58-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-19"><a href="eq.html#cb58-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(lbeta)</span>
<span id="cb58-20"><a href="eq.html#cb58-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.lbackward</code> takes in the same arguments as the <code>pois.HMM.lforward</code>.</p>
<p><strong>Step 2:</strong> Replace <span class="math inline">\(u_j(t)\)</span> by <span class="math inline">\(\hat{u}_j (t)\)</span> and <span class="math inline">\(v_{jk}(t)\)</span> by <span class="math inline">\(\hat{v}_{jk} (t)\)</span>.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="eq.html#cb59-1" aria-hidden="true" tabindex="-1"></a>uhat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mod){</span>
<span id="cb59-2"><a href="eq.html#cb59-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb59-3"><a href="eq.html#cb59-3" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb59-4"><a href="eq.html#cb59-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-5"><a href="eq.html#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Forward probabilities</span></span>
<span id="cb59-6"><a href="eq.html#cb59-6" aria-hidden="true" tabindex="-1"></a>  la <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x, mod)</span>
<span id="cb59-7"><a href="eq.html#cb59-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-8"><a href="eq.html#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Backward probabilities</span></span>
<span id="cb59-9"><a href="eq.html#cb59-9" aria-hidden="true" tabindex="-1"></a>  lb <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x, mod)</span>
<span id="cb59-10"><a href="eq.html#cb59-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-11"><a href="eq.html#cb59-11" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb59-12"><a href="eq.html#cb59-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-13"><a href="eq.html#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># L_T (with some constant amount)</span></span>
<span id="cb59-14"><a href="eq.html#cb59-14" aria-hidden="true" tabindex="-1"></a>  llk <span class="ot">&lt;-</span> c <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n] <span class="sc">-</span> c)))</span>
<span id="cb59-15"><a href="eq.html#cb59-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-16"><a href="eq.html#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize</span></span>
<span id="cb59-17"><a href="eq.html#cb59-17" aria-hidden="true" tabindex="-1"></a>  stateprobs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol=</span>n, <span class="at">nrow=</span>m)</span>
<span id="cb59-18"><a href="eq.html#cb59-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-19"><a href="eq.html#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## (a_t(j) b_t (j))/L_T </span></span>
<span id="cb59-20"><a href="eq.html#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb59-21"><a href="eq.html#cb59-21" aria-hidden="true" tabindex="-1"></a>    stateprobs[,i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[, i] <span class="sc">+</span> lb[, i] <span class="sc">-</span> llk)</span>
<span id="cb59-22"><a href="eq.html#cb59-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-23"><a href="eq.html#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stateprobs)</span>
<span id="cb59-24"><a href="eq.html#cb59-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-25"><a href="eq.html#cb59-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-26"><a href="eq.html#cb59-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-27"><a href="eq.html#cb59-27" aria-hidden="true" tabindex="-1"></a>vhat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mod){</span>
<span id="cb59-28"><a href="eq.html#cb59-28" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb59-29"><a href="eq.html#cb59-29" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb59-30"><a href="eq.html#cb59-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-31"><a href="eq.html#cb59-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Forward probabilities</span></span>
<span id="cb59-32"><a href="eq.html#cb59-32" aria-hidden="true" tabindex="-1"></a>  la <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x, mod)</span>
<span id="cb59-33"><a href="eq.html#cb59-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-34"><a href="eq.html#cb59-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Backward probabilities</span></span>
<span id="cb59-35"><a href="eq.html#cb59-35" aria-hidden="true" tabindex="-1"></a>  lb <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x, mod)</span>
<span id="cb59-36"><a href="eq.html#cb59-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-37"><a href="eq.html#cb59-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tpm</span></span>
<span id="cb59-38"><a href="eq.html#cb59-38" aria-hidden="true" tabindex="-1"></a>  lgamma <span class="ot">&lt;-</span> <span class="fu">log</span>(mod<span class="sc">$</span>gamma)</span>
<span id="cb59-39"><a href="eq.html#cb59-39" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">max</span>(la[, n])</span>
<span id="cb59-40"><a href="eq.html#cb59-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-41"><a href="eq.html#cb59-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># L_T (with some constant amount)</span></span>
<span id="cb59-42"><a href="eq.html#cb59-42" aria-hidden="true" tabindex="-1"></a>  llk <span class="ot">&lt;-</span> c <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[, n] <span class="sc">-</span> c)))</span>
<span id="cb59-43"><a href="eq.html#cb59-43" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(m, m, n))</span>
<span id="cb59-44"><a href="eq.html#cb59-44" aria-hidden="true" tabindex="-1"></a>  px <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>mod<span class="sc">$</span>m, <span class="at">ncol=</span>n)</span>
<span id="cb59-45"><a href="eq.html#cb59-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-46"><a href="eq.html#cb59-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb59-47"><a href="eq.html#cb59-47" aria-hidden="true" tabindex="-1"></a>    px[, i] <span class="ot">&lt;-</span> <span class="fu">dpois</span>(x[i], mod<span class="sc">$</span>lambda)</span>
<span id="cb59-48"><a href="eq.html#cb59-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-49"><a href="eq.html#cb59-49" aria-hidden="true" tabindex="-1"></a>  lpx <span class="ot">&lt;-</span> <span class="fu">log</span>(px)</span>
<span id="cb59-50"><a href="eq.html#cb59-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-51"><a href="eq.html#cb59-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb59-52"><a href="eq.html#cb59-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m){</span>
<span id="cb59-53"><a href="eq.html#cb59-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m){</span>
<span id="cb59-54"><a href="eq.html#cb59-54" aria-hidden="true" tabindex="-1"></a>        v[j, k, i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[j, i<span class="dv">-1</span>] <span class="sc">+</span> lgamma[j, k] <span class="sc">+</span> lpx[k, i] <span class="sc">+</span> lb[k, i] <span class="sc">-</span> llk)</span>
<span id="cb59-55"><a href="eq.html#cb59-55" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb59-56"><a href="eq.html#cb59-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-57"><a href="eq.html#cb59-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-58"><a href="eq.html#cb59-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(v)</span>
<span id="cb59-59"><a href="eq.html#cb59-59" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> The term <code>c</code> in the code is a constant added to the log-forward and log-backward probabilities to prevent numerical underflow.</p>
<p><strong>M-Step</strong> Maximize the complete data log-likelihood with respect to the parameter estimates, with functions of the missing data replaced by their conditional expectations.</p>
<p>That is, maximize</p>
<p><span class="math display">\[\begin{align}
\log \left(\Pr(\boldsymbol{x}^{(T)}, \boldsymbol{c}^{(T)}) \right)
&amp;= \sum_{j=1}^m \hat{u}_j (1) + \log \delta_j + \sum_{j=1}^m \sum_{k=1}^m \left(\sum_{t=2}^T \hat{v}_{jk} (t)\right) \log \gamma_{jk} + \sum_{j=1}^m \sum_{t=1}^T \hat{u}_j (t) \log p_j (x_t)
\end{align}\]</span></p>
<p>with respect to <span class="math inline">\(\boldsymbol{\theta} = (\boldsymbol{\delta}, \boldsymbol{\Gamma}, \boldsymbol{\lambda})\)</span>.</p>
<p>The maximizations of the parameters are given by</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="eq.html#cb60-1" aria-hidden="true" tabindex="-1"></a>E_delta <span class="ot">&lt;-</span> <span class="cf">function</span>(uhat){</span>
<span id="cb60-2"><a href="eq.html#cb60-2" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> uhat[, <span class="dv">1</span>]</span>
<span id="cb60-3"><a href="eq.html#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(d)</span>
<span id="cb60-4"><a href="eq.html#cb60-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-5"><a href="eq.html#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="eq.html#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="eq.html#cb60-7" aria-hidden="true" tabindex="-1"></a>E_gamma <span class="ot">&lt;-</span> <span class="cf">function</span>(vhat, mod){</span>
<span id="cb60-8"><a href="eq.html#cb60-8" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> <span class="fu">apply</span>(vhat, <span class="at">MARGIN=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">FUN=</span>sum)</span>
<span id="cb60-9"><a href="eq.html#cb60-9" aria-hidden="true" tabindex="-1"></a>  denom <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(num)</span>
<span id="cb60-10"><a href="eq.html#cb60-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> num<span class="sc">/</span>denom</span>
<span id="cb60-11"><a href="eq.html#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(g)</span>
<span id="cb60-12"><a href="eq.html#cb60-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-13"><a href="eq.html#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="eq.html#cb60-14" aria-hidden="true" tabindex="-1"></a>E_pois_lambda <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod,uhat){</span>
<span id="cb60-15"><a href="eq.html#cb60-15" aria-hidden="true" tabindex="-1"></a> n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb60-16"><a href="eq.html#cb60-16" aria-hidden="true" tabindex="-1"></a> m <span class="ot">&lt;-</span> mod<span class="sc">$</span>m</span>
<span id="cb60-17"><a href="eq.html#cb60-17" aria-hidden="true" tabindex="-1"></a> xx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(x, m), <span class="at">nrow=</span>m, <span class="at">ncol=</span>n, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb60-18"><a href="eq.html#cb60-18" aria-hidden="true" tabindex="-1"></a> lambda_hat <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(uhat<span class="sc">*</span>xx)<span class="sc">/</span><span class="fu">rowSums</span>(uhat)</span>
<span id="cb60-19"><a href="eq.html#cb60-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(lambda_hat)</span>
<span id="cb60-20"><a href="eq.html#cb60-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can combine the parts above into the <code>BaumWelch</code> function. <code>BaumWelch</code> performs the EM algorithm by taking initial model parameters as inputs, then repeatedly fitting until convergence or the maximum number of iterations is reached (by default <code>maxit=50</code>).</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="eq.html#cb61-1" aria-hidden="true" tabindex="-1"></a>BaumWelch <span class="ot">&lt;-</span> <span class="cf">function</span>(x, m, lambda0, gamma0, delta0, <span class="at">maxit =</span> <span class="dv">50</span>){</span>
<span id="cb61-2"><a href="eq.html#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial parameters</span></span>
<span id="cb61-3"><a href="eq.html#cb61-3" aria-hidden="true" tabindex="-1"></a>  mod_old <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m =</span> m, <span class="at">lambda =</span> lambda0, <span class="at">gamma =</span> gamma0, <span class="at">delta =</span> delta0)</span>
<span id="cb61-4"><a href="eq.html#cb61-4" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb61-5"><a href="eq.html#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(iter <span class="sc">&lt;</span> maxit){</span>
<span id="cb61-6"><a href="eq.html#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># E-step</span></span>
<span id="cb61-7"><a href="eq.html#cb61-7" aria-hidden="true" tabindex="-1"></a>    u_hat <span class="ot">&lt;-</span> <span class="fu">uhat</span>(x, mod_old)</span>
<span id="cb61-8"><a href="eq.html#cb61-8" aria-hidden="true" tabindex="-1"></a>    v_hat <span class="ot">&lt;-</span> <span class="fu">vhat</span>(x, mod_old)</span>
<span id="cb61-9"><a href="eq.html#cb61-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-10"><a href="eq.html#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M-step</span></span>
<span id="cb61-11"><a href="eq.html#cb61-11" aria-hidden="true" tabindex="-1"></a>    delta_new <span class="ot">&lt;-</span> <span class="fu">E_delta</span>(u_hat)</span>
<span id="cb61-12"><a href="eq.html#cb61-12" aria-hidden="true" tabindex="-1"></a>    gamma_new <span class="ot">&lt;-</span> <span class="fu">E_gamma</span>(v_hat, mod_old)</span>
<span id="cb61-13"><a href="eq.html#cb61-13" aria-hidden="true" tabindex="-1"></a>    lambda_new <span class="ot">&lt;-</span> <span class="fu">E_pois_lambda</span>(x, mod_old, u_hat)</span>
<span id="cb61-14"><a href="eq.html#cb61-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-15"><a href="eq.html#cb61-15" aria-hidden="true" tabindex="-1"></a>    mod_old <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m, <span class="at">lambda=</span>lambda_new, <span class="at">gamma=</span>gamma_new, <span class="at">delta=</span>delta_new)</span>
<span id="cb61-16"><a href="eq.html#cb61-16" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">=</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb61-17"><a href="eq.html#cb61-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-18"><a href="eq.html#cb61-18" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m=</span>m, <span class="at">lambda=</span>lambda_new, <span class="at">gamma=</span>gamma_new, <span class="at">delta=</span>delta_new)</span>
<span id="cb61-19"><a href="eq.html#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mod)</span>
<span id="cb61-20"><a href="eq.html#cb61-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Hence, for the three-state Poisson-HMM with parameters</p>
<p><span class="math display">\[\boldsymbol{\lambda} = (10, 20, 25)\]</span></p>
<p><span class="math display">\[\boldsymbol{\Gamma} = \begin{pmatrix} 0.8 &amp; 0.1 &amp; 0.1\\ 0.1 &amp; 0.8 &amp; 0.1\\ 0.1 &amp; 0.1 &amp; 0.8 \end{pmatrix}\]</span></p>
<p><span class="math display">\[\boldsymbol{\delta} = (\frac{1}{3}, \frac{1}{3}, \frac{1}{3})\]</span></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="eq.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a three-state HMM</span></span>
<span id="cb62-2"><a href="eq.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BaumWelch</span>(eq_dat<span class="sc">$</span>Count, eq_init_ns<span class="sc">$</span>m, eq_init_ns<span class="sc">$</span>lambda, eq_init_ns<span class="sc">$</span>gamma, <span class="at">delta =</span> eq_init_ns<span class="sc">$</span>delta)</span></code></pre></div>
<pre><code>## $m
## [1] 3
## 
## $lambda
## [1] 13.13376 19.71316 29.70972
## 
## $gamma
##              [,1]       [,2]       [,3]
## [1,] 9.392939e-01 0.03209847 0.02860765
## [2,] 4.040172e-02 0.90643612 0.05316216
## [3,] 2.113508e-32 0.19025585 0.80974415
## 
## $delta
## [1]  1.000000e+00  3.977303e-84 2.817232e-235</code></pre>
</div>
<div id="forecasting-decoding-and-state-prediction" class="section level2 unnumbered hasAnchor">
<h2>Forecasting, Decoding, and State Prediction<a href="eq.html#forecasting-decoding-and-state-prediction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Note:</strong> See <a href="fdp.html#fdp">Forecasting, Decoding, and State Prediction</a> and Appendix A of the textbook.</p>
<div id="forecasting" class="section level3 unnumbered hasAnchor">
<h3>Forecasting<a href="eq.html#forecasting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The forecast probabilities <span class="math inline">\(\Pr(X_{T+h} = x|\boldsymbol{X}^{(T)} = \boldsymbol{x}^{(T)})\)</span> can be computed by</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="eq.html#cb64-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.forecast <span class="ot">&lt;-</span> <span class="cf">function</span>(xf,<span class="at">h=</span><span class="dv">1</span>,x,mod)</span>
<span id="cb64-2"><a href="eq.html#cb64-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb64-3"><a href="eq.html#cb64-3" aria-hidden="true" tabindex="-1"></a> n        <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb64-4"><a href="eq.html#cb64-4" aria-hidden="true" tabindex="-1"></a> nxf      <span class="ot">&lt;-</span> <span class="fu">length</span>(xf)</span>
<span id="cb64-5"><a href="eq.html#cb64-5" aria-hidden="true" tabindex="-1"></a> dxf      <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>h,<span class="at">ncol=</span>nxf)</span>
<span id="cb64-6"><a href="eq.html#cb64-6" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb64-7"><a href="eq.html#cb64-7" aria-hidden="true" tabindex="-1"></a> sumfoo   <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb64-8"><a href="eq.html#cb64-8" aria-hidden="true" tabindex="-1"></a> lscale   <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb64-9"><a href="eq.html#cb64-9" aria-hidden="true" tabindex="-1"></a> foo      <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb64-10"><a href="eq.html#cb64-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb64-11"><a href="eq.html#cb64-11" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb64-12"><a href="eq.html#cb64-12" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb64-13"><a href="eq.html#cb64-13" aria-hidden="true" tabindex="-1"></a>   sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb64-14"><a href="eq.html#cb64-14" aria-hidden="true" tabindex="-1"></a>   lscale <span class="ot">&lt;-</span> lscale<span class="sc">+</span><span class="fu">log</span>(sumfoo)</span>
<span id="cb64-15"><a href="eq.html#cb64-15" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb64-16"><a href="eq.html#cb64-16" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb64-17"><a href="eq.html#cb64-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h)</span>
<span id="cb64-18"><a href="eq.html#cb64-18" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb64-19"><a href="eq.html#cb64-19" aria-hidden="true" tabindex="-1"></a>   foo    <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma</span>
<span id="cb64-20"><a href="eq.html#cb64-20" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m) dxf[i,] <span class="ot">&lt;-</span> dxf[i,] <span class="sc">+</span> foo[j]<span class="sc">*</span><span class="fu">dpois</span>(xf,mod<span class="sc">$</span>lambda[j])</span>
<span id="cb64-21"><a href="eq.html#cb64-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb64-22"><a href="eq.html#cb64-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(dxf)</span>
<span id="cb64-23"><a href="eq.html#cb64-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Note:</strong> <code>pois.HMM.forecast</code> takes in arguments <code>xf</code> the range of <span class="math inline">\(x\)</span>-values for the forecast probabilities, <code>h</code> the forecast horizon, <code>x</code> data, and <code>mod</code> list consisting of <code>m</code> states, <code>lambda</code> means for the Poisson state-dependent distribution, and <code>delta</code> initial probabilities.</p>
<p>For example, the forecast distributions for 1 to 4 years ahead with possible values up to 45 earthquakes for the three-state Poisson-HMM (non-stationary) is</p>
<div class="figure"><span style="display:block;" id="fig:forecastfour"></span>
<img src="08-earthquake-example_files/figure-html/forecastfour-1.png" alt="Forecast probabilities for the fitted three-state Poisson-HMM (non-stationary) for 1 to 4 years ahead." width="672" />
<p class="caption">
Figure 8.7: Forecast probabilities for the fitted three-state Poisson-HMM (non-stationary) for 1 to 4 years ahead.
</p>
</div>
<p>The function from above can be modified to compute the bivariate forecast distribution.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="eq.html#cb65-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.forecast_bivariate <span class="ot">&lt;-</span> <span class="cf">function</span>(xf1, xf2, x, mod){</span>
<span id="cb65-2"><a href="eq.html#cb65-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb65-3"><a href="eq.html#cb65-3" aria-hidden="true" tabindex="-1"></a>  nxf1 <span class="ot">&lt;-</span> <span class="fu">length</span>(xf1)</span>
<span id="cb65-4"><a href="eq.html#cb65-4" aria-hidden="true" tabindex="-1"></a>  nxf2 <span class="ot">&lt;-</span> <span class="fu">length</span>(xf2)</span>
<span id="cb65-5"><a href="eq.html#cb65-5" aria-hidden="true" tabindex="-1"></a>  dxf <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>nxf1, <span class="at">ncol=</span>nxf2)</span>
<span id="cb65-6"><a href="eq.html#cb65-6" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>], mod<span class="sc">$</span>lambda)</span>
<span id="cb65-7"><a href="eq.html#cb65-7" aria-hidden="true" tabindex="-1"></a>  sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb65-8"><a href="eq.html#cb65-8" aria-hidden="true" tabindex="-1"></a>  lscale <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb65-9"><a href="eq.html#cb65-9" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb65-10"><a href="eq.html#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="eq.html#cb65-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb65-12"><a href="eq.html#cb65-12" aria-hidden="true" tabindex="-1"></a>    foo <span class="ot">&lt;-</span> foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma<span class="sc">*</span><span class="fu">dpois</span>(x[t], mod<span class="sc">$</span>lambda)</span>
<span id="cb65-13"><a href="eq.html#cb65-13" aria-hidden="true" tabindex="-1"></a>    sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb65-14"><a href="eq.html#cb65-14" aria-hidden="true" tabindex="-1"></a>    lscale <span class="ot">&lt;-</span> lscale <span class="sc">+</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb65-15"><a href="eq.html#cb65-15" aria-hidden="true" tabindex="-1"></a>    foo <span class="ot">&lt;-</span> foo<span class="sc">/</span>sumfoo</span>
<span id="cb65-16"><a href="eq.html#cb65-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-17"><a href="eq.html#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="eq.html#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nxf1){</span>
<span id="cb65-19"><a href="eq.html#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nxf2){</span>
<span id="cb65-20"><a href="eq.html#cb65-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m){</span>
<span id="cb65-21"><a href="eq.html#cb65-21" aria-hidden="true" tabindex="-1"></a>        dxf[i, j] <span class="ot">&lt;-</span> dxf[i, j] <span class="sc">+</span> foo[s]<span class="sc">*</span><span class="fu">dpois</span>(xf1[i], mod<span class="sc">$</span>lambda[s]) <span class="sc">+</span> foo[s]<span class="sc">*</span><span class="fu">dpois</span>(xf2[j], mod<span class="sc">$</span>lambda[s])</span>
<span id="cb65-22"><a href="eq.html#cb65-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-23"><a href="eq.html#cb65-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-24"><a href="eq.html#cb65-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-25"><a href="eq.html#cb65-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-26"><a href="eq.html#cb65-26" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(foo)</span>
<span id="cb65-27"><a href="eq.html#cb65-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, <span class="math inline">\(\Pr(X_{T+1} \leq 10, X_{T+2} \leq 10|\boldsymbol{X}^{(T)})\)</span> is</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="eq.html#cb66-1" aria-hidden="true" tabindex="-1"></a>eq_forecast <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">pois.HMM.forecast_bivariate</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,eq_dat<span class="sc">$</span>Count, eq_init_ns))</span>
<span id="cb66-2"><a href="eq.html#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="eq.html#cb66-3" aria-hidden="true" tabindex="-1"></a>eq_forecast <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="eq.html#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">&quot;Bivariate Forecast Distribution of $X_{T+1}$ (rows) and $X_{T+2}$ (columns).&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-5"><a href="eq.html#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_minimal</span>(<span class="at">full_width=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb66-6"><a href="eq.html#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div>
<table class=" lightable-minimal table" style="font-family: &quot;Trebuchet MS&quot;, verdana, sans-serif; margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-39">Table 8.4: </span>Bivariate Forecast Distribution of <span class="math inline">\(X_{T+1}\)</span> (rows) and <span class="math inline">\(X_{T+2}\)</span> (columns).
</caption>
<thead>
<tr>
<th style="text-align:right;">
X1
</th>
<th style="text-align:right;">
X2
</th>
<th style="text-align:right;">
X3
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0.961864
</td>
<td style="text-align:right;">
0.0370039
</td>
<td style="text-align:right;">
0.0011321
</td>
</tr>
</tbody>
</table>
</div>
<div id="decoding-1" class="section level3 unnumbered hasAnchor">
<h3>Decoding<a href="eq.html#decoding-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Local decoding can be computed using the forward and backward algorithms from above. Similar to computing <span class="math inline">\(\hat{u}\)</span> in the <strong>E step</strong> of the EM algorithm, the <code>pois.HMM.state_probs</code> computes the state probabilities then <code>pois.HMM.local_decoding</code> determines the most likely state at each time.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="eq.html#cb67-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.state_probs <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod)</span>
<span id="cb67-2"><a href="eq.html#cb67-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb67-3"><a href="eq.html#cb67-3" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb67-4"><a href="eq.html#cb67-4" aria-hidden="true" tabindex="-1"></a> la         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x,mod)</span>
<span id="cb67-5"><a href="eq.html#cb67-5" aria-hidden="true" tabindex="-1"></a> lb         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lbackward</span>(x,mod)</span>
<span id="cb67-6"><a href="eq.html#cb67-6" aria-hidden="true" tabindex="-1"></a> c          <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb67-7"><a href="eq.html#cb67-7" aria-hidden="true" tabindex="-1"></a> llk        <span class="ot">&lt;-</span> c<span class="sc">+</span><span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n]<span class="sc">-</span>c)))</span>
<span id="cb67-8"><a href="eq.html#cb67-8" aria-hidden="true" tabindex="-1"></a> stateprobs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span>n,<span class="at">nrow=</span>mod<span class="sc">$</span>m)</span>
<span id="cb67-9"><a href="eq.html#cb67-9" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) stateprobs[,i]<span class="ot">&lt;-</span><span class="fu">exp</span>(la[,i]<span class="sc">+</span>lb[,i]<span class="sc">-</span>llk)</span>
<span id="cb67-10"><a href="eq.html#cb67-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(stateprobs)</span>
<span id="cb67-11"><a href="eq.html#cb67-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-12"><a href="eq.html#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="eq.html#cb67-13" aria-hidden="true" tabindex="-1"></a>pois.HMM.local_decoding <span class="ot">&lt;-</span> <span class="cf">function</span>(x,mod)</span>
<span id="cb67-14"><a href="eq.html#cb67-14" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb67-15"><a href="eq.html#cb67-15" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb67-16"><a href="eq.html#cb67-16" aria-hidden="true" tabindex="-1"></a> stateprobs <span class="ot">&lt;-</span> <span class="fu">pois.HMM.state_probs</span>(x,mod)</span>
<span id="cb67-17"><a href="eq.html#cb67-17" aria-hidden="true" tabindex="-1"></a> ild        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,n)</span>
<span id="cb67-18"><a href="eq.html#cb67-18" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) ild[i]<span class="ot">&lt;-</span><span class="fu">which.max</span>(stateprobs[,i])</span>
<span id="cb67-19"><a href="eq.html#cb67-19" aria-hidden="true" tabindex="-1"></a> ild</span>
<span id="cb67-20"><a href="eq.html#cb67-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, local decoding for the three state Poisson-HMM (non-stationary) is</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="eq.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Local decoding</span></span>
<span id="cb68-2"><a href="eq.html#cb68-2" aria-hidden="true" tabindex="-1"></a>(earthquake_local <span class="ot">&lt;-</span> <span class="fu">pois.HMM.local_decoding</span>(eq_dat<span class="sc">$</span>Count, eq_init_ns))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 3 3 3 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 3 1 2 2 2 2 2 2 2 2 2 3 3 3 3 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 2 2 1 1 1 2 2 2 2 2 2 2 2 2 1 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:local"></span>
<img src="08-earthquake-example_files/figure-html/local-1.png" alt="Local decoding for the three-state Poisson-HMM (non-stationary). The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time." width="672" />
<p class="caption">
Figure 8.8: Local decoding for the three-state Poisson-HMM (non-stationary). The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time.
</p>
</div>
<p>We can also perform local decoding using <code>momentuHMM</code></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="eq.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Local decoding</span></span>
<span id="cb70-2"><a href="eq.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute state probabilities for each time step</span></span>
<span id="cb70-3"><a href="eq.html#cb70-3" aria-hidden="true" tabindex="-1"></a>state_probs <span class="ot">&lt;-</span> <span class="fu">stateProbs</span>(mod3h_momentuHMM)</span>
<span id="cb70-4"><a href="eq.html#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="eq.html#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Select state that maximizes probability</span></span>
<span id="cb70-6"><a href="eq.html#cb70-6" aria-hidden="true" tabindex="-1"></a>local_vec        <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(eq_dat<span class="sc">$</span>Count))</span>
<span id="cb70-7"><a href="eq.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(eq_dat<span class="sc">$</span>Count)) local_vec[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(state_probs[i,])</span>
<span id="cb70-8"><a href="eq.html#cb70-8" aria-hidden="true" tabindex="-1"></a>local_vec</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 2 2 2 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 2 2 2 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 2 2 2
##  [75] 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:comparelocal"></span>
<img src="08-earthquake-example_files/figure-html/comparelocal-1.png" alt="Local decoding for the three-state Poisson-HMM (non-stationary). The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time using  pois.HMM.local_decoding (purple) and momentuHMM (orange)." width="672" />
<p class="caption">
Figure 8.9: Local decoding for the three-state Poisson-HMM (non-stationary). The horizontal lines indicate the state-dependent means and the points indicate the decoded state at the given time using pois.HMM.local_decoding (purple) and momentuHMM (orange).
</p>
</div>
<p>Global decoding can be computed using the Viterbi algorithm</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="eq.html#cb72-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.viterbi<span class="ot">&lt;-</span><span class="cf">function</span>(x,mod)</span>
<span id="cb72-2"><a href="eq.html#cb72-2" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb72-3"><a href="eq.html#cb72-3" aria-hidden="true" tabindex="-1"></a> n              <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb72-4"><a href="eq.html#cb72-4" aria-hidden="true" tabindex="-1"></a> xi             <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,n,mod<span class="sc">$</span>m)</span>
<span id="cb72-5"><a href="eq.html#cb72-5" aria-hidden="true" tabindex="-1"></a> foo            <span class="ot">&lt;-</span> mod<span class="sc">$</span>delta<span class="sc">*</span><span class="fu">dpois</span>(x[<span class="dv">1</span>],mod<span class="sc">$</span>lambda)</span>
<span id="cb72-6"><a href="eq.html#cb72-6" aria-hidden="true" tabindex="-1"></a> xi[<span class="dv">1</span>,]         <span class="ot">&lt;-</span> foo<span class="sc">/</span><span class="fu">sum</span>(foo)</span>
<span id="cb72-7"><a href="eq.html#cb72-7" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb72-8"><a href="eq.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb72-9"><a href="eq.html#cb72-9" aria-hidden="true" tabindex="-1"></a>  foo<span class="ot">&lt;-</span><span class="fu">apply</span>(xi[i<span class="dv">-1</span>,]<span class="sc">*</span>mod<span class="sc">$</span>gamma,<span class="dv">2</span>,max)<span class="sc">*</span><span class="fu">dpois</span>(x[i],mod<span class="sc">$</span>lambda)</span>
<span id="cb72-10"><a href="eq.html#cb72-10" aria-hidden="true" tabindex="-1"></a>  xi[i,] <span class="ot">&lt;-</span> foo<span class="sc">/</span><span class="fu">sum</span>(foo)</span>
<span id="cb72-11"><a href="eq.html#cb72-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-12"><a href="eq.html#cb72-12" aria-hidden="true" tabindex="-1"></a> iv<span class="ot">&lt;-</span><span class="fu">numeric</span>(n)</span>
<span id="cb72-13"><a href="eq.html#cb72-13" aria-hidden="true" tabindex="-1"></a> iv[n]     <span class="ot">&lt;-</span><span class="fu">which.max</span>(xi[n,])</span>
<span id="cb72-14"><a href="eq.html#cb72-14" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> (n<span class="dv">-1</span>)<span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb72-15"><a href="eq.html#cb72-15" aria-hidden="true" tabindex="-1"></a>   iv[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(mod<span class="sc">$</span>gamma[,iv[i<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">*</span>xi[i,])</span>
<span id="cb72-16"><a href="eq.html#cb72-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(iv)</span>
<span id="cb72-17"><a href="eq.html#cb72-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, global decoding for the three state Poisson-HMM (non-stationary) is</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="eq.html#cb73-1" aria-hidden="true" tabindex="-1"></a>(earthquake_global <span class="ot">&lt;-</span> <span class="fu">pois.HMM.viterbi</span>(eq_dat<span class="sc">$</span>Count, eq_init_ns))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 3 3 3 3 3 3 3 3 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 1 1</code></pre>
<div class="figure"><span style="display:block;" id="fig:global"></span>
<img src="08-earthquake-example_files/figure-html/global-1.png" alt="Global decoding for the three-state Poisson-HMM (non-stationary)." width="672" />
<p class="caption">
Figure 8.10: Global decoding for the three-state Poisson-HMM (non-stationary).
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:comparelg"></span>
<img src="08-earthquake-example_files/figure-html/comparelg-1.png" alt="Global (green) and local (brown) decoding for the three-state Poisson-HMM (non-stationary)." width="672" />
<p class="caption">
Figure 8.11: Global (green) and local (brown) decoding for the three-state Poisson-HMM (non-stationary).
</p>
</div>
<p>The result of local and global decoding are very similar but not identical.</p>
<p>Similarly, we can perform global decoding using <code>momentuHMM</code></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="eq.html#cb75-1" aria-hidden="true" tabindex="-1"></a>(global_vec <span class="ot">&lt;-</span> <span class="fu">viterbi</span>(mod3h_momentuHMM))</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 3 3 3 3 3 3 2 2 2 2 2 2 2 2 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [38] 2 2 2 2 2 3 3 3 3 3 3 3 3 3 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 2 2 2
##  [75] 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="eq.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotStates</span>(mod3h_momentuHMM)</span></code></pre></div>
<pre><code>## Decoding state sequence... DONE
## Computing state probabilities... DONE</code></pre>
<p><img src="08-earthquake-example_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<div class="figure"><span style="display:block;" id="fig:compareglobal"></span>
<img src="08-earthquake-example_files/figure-html/compareglobal-1.png" alt="Global decoding for the three-state Poisson-HMM using  pois.HMM.gocal_decoding (purple) and momentuHMM (orange)." width="672" />
<p class="caption">
Figure 8.12: Global decoding for the three-state Poisson-HMM using pois.HMM.gocal_decoding (purple) and momentuHMM (orange).
</p>
</div>
<p>There appears to be some differences between the results obtained from our function and from <code>momentuHMM</code>.</p>
</div>
<div id="state-predictions" class="section level3 unnumbered hasAnchor">
<h3>State Predictions<a href="eq.html#state-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The state prediction for <span class="math inline">\(h\)</span> steps ahead can be computed by</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="eq.html#cb79-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.state_prediction <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">h=</span><span class="dv">1</span>,x,mod)</span>
<span id="cb79-2"><a href="eq.html#cb79-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb79-3"><a href="eq.html#cb79-3" aria-hidden="true" tabindex="-1"></a> n          <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb79-4"><a href="eq.html#cb79-4" aria-hidden="true" tabindex="-1"></a> la         <span class="ot">&lt;-</span> <span class="fu">pois.HMM.lforward</span>(x,mod)</span>
<span id="cb79-5"><a href="eq.html#cb79-5" aria-hidden="true" tabindex="-1"></a> c          <span class="ot">&lt;-</span> <span class="fu">max</span>(la[,n])</span>
<span id="cb79-6"><a href="eq.html#cb79-6" aria-hidden="true" tabindex="-1"></a> llk        <span class="ot">&lt;-</span> c<span class="sc">+</span><span class="fu">log</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(la[,n]<span class="sc">-</span>c)))</span>
<span id="cb79-7"><a href="eq.html#cb79-7" aria-hidden="true" tabindex="-1"></a> statepreds <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span>h,<span class="at">nrow=</span>mod<span class="sc">$</span>m)</span>
<span id="cb79-8"><a href="eq.html#cb79-8" aria-hidden="true" tabindex="-1"></a> foo <span class="ot">&lt;-</span> <span class="fu">exp</span>(la[,n]<span class="sc">-</span>llk)</span>
<span id="cb79-9"><a href="eq.html#cb79-9" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h){</span>
<span id="cb79-10"><a href="eq.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  foo<span class="ot">&lt;-</span>foo<span class="sc">%*%</span>mod<span class="sc">$</span>gamma</span>
<span id="cb79-11"><a href="eq.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  statepreds[,i]<span class="ot">&lt;-</span>foo</span>
<span id="cb79-12"><a href="eq.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-13"><a href="eq.html#cb79-13" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(statepreds)</span>
<span id="cb79-14"><a href="eq.html#cb79-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, the state predictions for <span class="math inline">\(h=1, \dots, 5\)</span> for the three-state Poisson-HMM (non-stationary)</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="eq.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pois.HMM.state_prediction</span>(<span class="at">h=</span><span class="dv">5</span>, eq_dat<span class="sc">$</span>Count, eq_init_ns)</span></code></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]      [,5]
## [1,] 0.7733048 0.6413134 0.5489194 0.4842436 0.4389705
## [2,] 0.1259027 0.1881319 0.2316923 0.2621846 0.2835292
## [3,] 0.1007924 0.1705547 0.2193883 0.2535718 0.2775003</code></pre>
<p>The stationary distribution is</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="eq.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute stationary distribution</span></span>
<span id="cb82-2"><a href="eq.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">diag</span>(m)<span class="sc">-</span>gamma<span class="sc">+</span><span class="dv">1</span>),<span class="fu">rep</span>(<span class="dv">1</span>,m))</span></code></pre></div>
<pre><code>## [1] 0.3333333 0.3333333 0.3333333</code></pre>
<p>Notice that as <span class="math inline">\(h \rightarrow \infty\)</span>, the state distribution approaches the stationary distribution.</p>
</div>
</div>
<div id="fitting-a-poisson-hmm-using-stan" class="section level2 unnumbered hasAnchor">
<h2>Fitting a Poisson-HMM using STAN<a href="eq.html#fitting-a-poisson-hmm-using-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Note</strong>: See <a href="bayesian.html#bayesian">Bayesian Inference for HMMs</a>, <span class="citation">Leos-Barajas and Michelot (<a href="#ref-leosbarajas2018introduction" role="doc-biblioref">2018</a>)</span>, and <span class="citation">Damiano, Peterson, and Weylandt (<a href="#ref-Damiano_Peterson_Weylandt_2017" role="doc-biblioref">2017</a>)</span>.</p>
<p>We can perform Bayesian inference for the three-state Poisson-HMM using STAN <span class="citation">Stan Development Team (<a href="#ref-stan" role="doc-biblioref">2023</a>)</span>.</p>
<p>In STAN, the main building blocks are the:</p>
<p><code>data block</code>: used to define the input data for the model to fit in STAN. Declare the data types, their dimensions, any restrictions, and their names of the data to model.</p>
<p>Here, we specify the length of the sequence of the earthquake series, the number of states, and the vector of observed earthquake counts.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="eq.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;data{</span></span>
<span id="cb84-2"><a href="eq.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; m;                       // number of states</span></span>
<span id="cb84-3"><a href="eq.html#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1&gt; T;                       // length of sequence</span></span>
<span id="cb84-4"><a href="eq.html#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; x[T];                    // observations</span></span>
<span id="cb84-5"><a href="eq.html#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb84-6"><a href="eq.html#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p><code>parameters block</code>: used to define the parameters of the model that will be estimated. Declare the data types, their dimensions, any restrictions, and their names of the parameters to model.</p>
<p>Here, we specify the state-dependent means, transition probability matrix, and the initial distribution (assuming non-stationarity).</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="eq.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;parameters{</span></span>
<span id="cb85-2"><a href="eq.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="st">simplex[m] Gamma[m];                  // transition probability matrix</span></span>
<span id="cb85-3"><a href="eq.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="st">positive_ordered[m] lambda;           // state-dependent means (ordered to prevent label switching)</span></span>
<span id="cb85-4"><a href="eq.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span></code></pre></div>
<p><code>transformed parameters block</code>: used to define any derived parameters that are not directly estimated but are derived from the parameters defined in the previous block. Declare the data types, their dimensions, any restrictions, their names, and the operation of the parameters to transform.</p>
<p>If we assume that the Markov Chain is stationary, then we can compute the stationary distribution from the tpm.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="eq.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;transformed parameters{</span></span>
<span id="cb86-2"><a href="eq.html#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[m, m] ta;                    // tpm used to compute stationary distribution                 </span></span>
<span id="cb86-3"><a href="eq.html#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[m] statdist;                // stationary distribution</span></span>
<span id="cb86-4"><a href="eq.html#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="eq.html#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 1:m){</span></span>
<span id="cb86-6"><a href="eq.html#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="st">    for(i in 1:m){</span></span>
<span id="cb86-7"><a href="eq.html#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="st">      ta[i, j] = Gamma[i, j];</span></span>
<span id="cb86-8"><a href="eq.html#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb86-9"><a href="eq.html#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb86-10"><a href="eq.html#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="eq.html#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="st">//compute stationary distribution </span></span>
<span id="cb86-12"><a href="eq.html#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="st">statdist =  to_vector((to_row_vector(rep_vector(1.0, m))/</span></span>
<span id="cb86-13"><a href="eq.html#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="st">      (diag_matrix(rep_vector(1.0, m)) - ta + rep_matrix(1, m, m))));</span></span>
<span id="cb86-14"><a href="eq.html#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb86-15"><a href="eq.html#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p><strong>Note:</strong> The tpm is transposed so that each row corresponds to the probabilities of transitioning into a state, rather than out of a state.</p>
<p><code>model block</code>: used to define the prior distribution, likelihood, and any other necessary variables.</p>
<p>Here, we use the following prior specifications:</p>
<p><span class="math display">\[\boldsymbol{\lambda} \sim Gamma(\alpha=1, \beta=0.01)\]</span></p>
<p><span class="math display">\[\boldsymbol{\Gamma} \sim Unif(-\infty, \infty)\]</span></p>
<p><span class="math display">\[\boldsymbol{\delta} \sim Unif(-\infty, \infty)\]</span>
The <a href="numerical.html#reparam">forward algorithm</a> can be used to obtain the posterior distribution of the hidden states at a given time <span class="math inline">\(t\)</span> based on all the information available up to that time <span class="math inline">\(\Pr(C_t|\boldsymbol{X}^{(t)})\)</span>.</p>
<p><span class="math display">\[\begin{align}
\log (\alpha_t, j)
&amp;= \log \left(\sum_{i=1}^m \gamma_{ij} \alpha_{t-1, i} \right)\\
&amp;= \log \left(\sum_{i=1}^m \exp (\log (\gamma_{ij}) + \log (\alpha_{t-1, i}))\right)
\end{align}\]</span></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="eq.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;model{</span></span>
<span id="cb87-2"><a href="eq.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] log_Gamma_tr[m];</span></span>
<span id="cb87-3"><a href="eq.html#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp;</span></span>
<span id="cb87-4"><a href="eq.html#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp_p1;</span></span>
<span id="cb87-5"><a href="eq.html#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="eq.html#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb87-7"><a href="eq.html#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="st">  lambda ~ gamma(1, 0.01);</span></span>
<span id="cb87-8"><a href="eq.html#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="eq.html#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="st">  // transpose tpm and take log of entries</span></span>
<span id="cb87-10"><a href="eq.html#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:m)</span></span>
<span id="cb87-11"><a href="eq.html#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="st">    for(j in 1:m)</span></span>
<span id="cb87-12"><a href="eq.html#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="st">      log_Gamma_tr[j, i] = log(Gamma[i, j]);</span></span>
<span id="cb87-13"><a href="eq.html#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb87-14"><a href="eq.html#cb87-14" aria-hidden="true" tabindex="-1"></a><span class="st">  // forward algorithm</span></span>
<span id="cb87-15"><a href="eq.html#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="st">    // for t = 1</span></span>
<span id="cb87-16"><a href="eq.html#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="st">    for(i in 1:m)</span></span>
<span id="cb87-17"><a href="eq.html#cb87-17" aria-hidden="true" tabindex="-1"></a><span class="st">      lp[i] = log(statdist[i]) + poisson_lpmf(x[1]|lambda[i]);</span></span>
<span id="cb87-18"><a href="eq.html#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb87-19"><a href="eq.html#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="st">    // for t &gt; 1</span></span>
<span id="cb87-20"><a href="eq.html#cb87-20" aria-hidden="true" tabindex="-1"></a><span class="st">    for(t in 2:T){</span></span>
<span id="cb87-21"><a href="eq.html#cb87-21" aria-hidden="true" tabindex="-1"></a><span class="st">      for (i in 1:m)</span></span>
<span id="cb87-22"><a href="eq.html#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="st">        lp_p1[i] = log_sum_exp(log_Gamma_tr[i] + lp) + poisson_lpmf(x[t]|lambda[i]);</span></span>
<span id="cb87-23"><a href="eq.html#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb87-24"><a href="eq.html#cb87-24" aria-hidden="true" tabindex="-1"></a><span class="st">        lp = lp_p1;</span></span>
<span id="cb87-25"><a href="eq.html#cb87-25" aria-hidden="true" tabindex="-1"></a><span class="st">   }</span></span>
<span id="cb87-26"><a href="eq.html#cb87-26" aria-hidden="true" tabindex="-1"></a><span class="st">   target += log_sum_exp(lp);</span></span>
<span id="cb87-27"><a href="eq.html#cb87-27" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb87-28"><a href="eq.html#cb87-28" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<pre><code>## [1] &quot;model{\n  vector[m] log_Gamma_tr[m];\n  vector[m] lp;\n  vector[m] lp_p1;\n\n  // priors\n  lambda ~ gamma(1, 0.01);\n\n  // transpose tpm and take log of entries\n  for(i in 1:m)\n    for(j in 1:m)\n      log_Gamma_tr[j, i] = log(Gamma[i, j]);\n    \n  // forward algorithm\n    // for t = 1\n    for(i in 1:m)\n      lp[i] = log(statdist[i]) + poisson_lpmf(x[1]|lambda[i]);\n  \n    // for t &gt; 1\n    for(t in 2:T){\n      for (i in 1:m)\n        lp_p1[i] = log_sum_exp(log_Gamma_tr[i] + lp) + poisson_lpmf(x[t]|lambda[i]);\n      \n        lp = lp_p1;\n   }\n   target += log_sum_exp(lp);\n  }\n&quot;</code></pre>
<p>All together,</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="eq.html#cb89-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.stan <span class="ot">&lt;-</span> </span>
<span id="cb89-2"><a href="eq.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;data{</span></span>
<span id="cb89-3"><a href="eq.html#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; m;                       // number of states</span></span>
<span id="cb89-4"><a href="eq.html#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1&gt; T;                       // length of sequence</span></span>
<span id="cb89-5"><a href="eq.html#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; x[T];                    // observations</span></span>
<span id="cb89-6"><a href="eq.html#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb89-7"><a href="eq.html#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="eq.html#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb89-9"><a href="eq.html#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="st">simplex[m] Gamma[m];                  // tpm</span></span>
<span id="cb89-10"><a href="eq.html#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="st">positive_ordered[m] lambda;           // ordered mean of state-dependent (prevent label switching)</span></span>
<span id="cb89-11"><a href="eq.html#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb89-12"><a href="eq.html#cb89-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-13"><a href="eq.html#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters{</span></span>
<span id="cb89-14"><a href="eq.html#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[m, m] ta;                    // tpm used to compute stationary distribution                 </span></span>
<span id="cb89-15"><a href="eq.html#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="st">  simplex[m] statdist;                // stationary distribution</span></span>
<span id="cb89-16"><a href="eq.html#cb89-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-17"><a href="eq.html#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 1:m){</span></span>
<span id="cb89-18"><a href="eq.html#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="st">    for(i in 1:m){</span></span>
<span id="cb89-19"><a href="eq.html#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="st">      ta[i, j] = Gamma[i, j];</span></span>
<span id="cb89-20"><a href="eq.html#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb89-21"><a href="eq.html#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb89-22"><a href="eq.html#cb89-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-23"><a href="eq.html#cb89-23" aria-hidden="true" tabindex="-1"></a><span class="st">//compute stationary distribution </span></span>
<span id="cb89-24"><a href="eq.html#cb89-24" aria-hidden="true" tabindex="-1"></a><span class="st">statdist =  to_vector((to_row_vector(rep_vector(1.0, m))/</span></span>
<span id="cb89-25"><a href="eq.html#cb89-25" aria-hidden="true" tabindex="-1"></a><span class="st">      (diag_matrix(rep_vector(1.0, m)) - ta + rep_matrix(1, m, m))));</span></span>
<span id="cb89-26"><a href="eq.html#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb89-27"><a href="eq.html#cb89-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-28"><a href="eq.html#cb89-28" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb89-29"><a href="eq.html#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="st">  // initialise</span></span>
<span id="cb89-30"><a href="eq.html#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] log_Gamma_tr[m];</span></span>
<span id="cb89-31"><a href="eq.html#cb89-31" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp;</span></span>
<span id="cb89-32"><a href="eq.html#cb89-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[m] lp_p1;</span></span>
<span id="cb89-33"><a href="eq.html#cb89-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-34"><a href="eq.html#cb89-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb89-35"><a href="eq.html#cb89-35" aria-hidden="true" tabindex="-1"></a><span class="st">  lambda ~ gamma(1, 0.01);</span></span>
<span id="cb89-36"><a href="eq.html#cb89-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-37"><a href="eq.html#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="st">  // transpose tpm and take log of entries</span></span>
<span id="cb89-38"><a href="eq.html#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:m)</span></span>
<span id="cb89-39"><a href="eq.html#cb89-39" aria-hidden="true" tabindex="-1"></a><span class="st">    for(j in 1:m)</span></span>
<span id="cb89-40"><a href="eq.html#cb89-40" aria-hidden="true" tabindex="-1"></a><span class="st">      log_Gamma_tr[j, i] = log(Gamma[i, j]);</span></span>
<span id="cb89-41"><a href="eq.html#cb89-41" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb89-42"><a href="eq.html#cb89-42" aria-hidden="true" tabindex="-1"></a><span class="st">  // forward algorithm</span></span>
<span id="cb89-43"><a href="eq.html#cb89-43" aria-hidden="true" tabindex="-1"></a><span class="st">  // for t = 1</span></span>
<span id="cb89-44"><a href="eq.html#cb89-44" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:m)</span></span>
<span id="cb89-45"><a href="eq.html#cb89-45" aria-hidden="true" tabindex="-1"></a><span class="st">    lp[i] = log(statdist[i]) + poisson_lpmf(x[1]|lambda[i]);</span></span>
<span id="cb89-46"><a href="eq.html#cb89-46" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb89-47"><a href="eq.html#cb89-47" aria-hidden="true" tabindex="-1"></a><span class="st">  // loop over observations</span></span>
<span id="cb89-48"><a href="eq.html#cb89-48" aria-hidden="true" tabindex="-1"></a><span class="st">  for(t in 2:T){</span></span>
<span id="cb89-49"><a href="eq.html#cb89-49" aria-hidden="true" tabindex="-1"></a><span class="st">  // loop over states</span></span>
<span id="cb89-50"><a href="eq.html#cb89-50" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:m)</span></span>
<span id="cb89-51"><a href="eq.html#cb89-51" aria-hidden="true" tabindex="-1"></a><span class="st">      lp_p1[i] = log_sum_exp(log_Gamma_tr[i] + lp) + poisson_lpmf(x[t]|lambda[i]);</span></span>
<span id="cb89-52"><a href="eq.html#cb89-52" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb89-53"><a href="eq.html#cb89-53" aria-hidden="true" tabindex="-1"></a><span class="st">      lp = lp_p1;</span></span>
<span id="cb89-54"><a href="eq.html#cb89-54" aria-hidden="true" tabindex="-1"></a><span class="st">   }</span></span>
<span id="cb89-55"><a href="eq.html#cb89-55" aria-hidden="true" tabindex="-1"></a><span class="st">   target += log_sum_exp(lp);</span></span>
<span id="cb89-56"><a href="eq.html#cb89-56" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb89-57"><a href="eq.html#cb89-57" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span></span></code></pre></div>
<p>Then for the three state-Poisson HMM,</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="eq.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Format data into list for STAN</span></span>
<span id="cb90-2"><a href="eq.html#cb90-2" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">T=</span><span class="fu">dim</span>(eq_dat)[<span class="dv">1</span>], <span class="at">m=</span><span class="dv">3</span>, <span class="at">x=</span>eq_dat<span class="sc">$</span>Count)</span></code></pre></div>
<p>Running 2000 iterations for each of the 4 chains, with the first 1000 draws drawn during the warm-up phase,</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="eq.html#cb91-1" aria-hidden="true" tabindex="-1"></a>pois.HMM.stanfit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code =</span> pois.HMM.stan, <span class="at">data =</span> stan_data, <span class="at">refresh=</span><span class="dv">2000</span>)</span></code></pre></div>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c
## clang -arch arm64 -I&quot;/Library/Frameworks/R.framework/Resources/include&quot; -DNDEBUG   -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/Rcpp/include/&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/unsupported&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/BH/include&quot; -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/StanHeaders/include/src/&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/StanHeaders/include/&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppParallel/include/&quot;  -I&quot;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/opt/R/arm64/include   -fPIC  -falign-functions=64 -Wall -g -O2  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/Dense:1:
## In file included from /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/Core:88:
## /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/Dense:1:
## /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1
## 
## SAMPLING FOR MODEL &#39;9875485ac4343cdf02f82dbe9761d256&#39; NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000123 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.23 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 0.820039 seconds (Warm-up)
## Chain 1:                0.450072 seconds (Sampling)
## Chain 1:                1.27011 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL &#39;9875485ac4343cdf02f82dbe9761d256&#39; NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 5e-05 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.5 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 0.823041 seconds (Warm-up)
## Chain 2:                0.527402 seconds (Sampling)
## Chain 2:                1.35044 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL &#39;9875485ac4343cdf02f82dbe9761d256&#39; NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 4.9e-05 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.49 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 0.812108 seconds (Warm-up)
## Chain 3:                0.457366 seconds (Sampling)
## Chain 3:                1.26947 seconds (Total)
## Chain 3: 
## 
## SAMPLING FOR MODEL &#39;9875485ac4343cdf02f82dbe9761d256&#39; NOW (CHAIN 4).
## Chain 4: 
## Chain 4: Gradient evaluation took 4.9e-05 seconds
## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.49 seconds.
## Chain 4: Adjust your expectations accordingly!
## Chain 4: 
## Chain 4: 
## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 4: 
## Chain 4:  Elapsed Time: 0.76585 seconds (Warm-up)
## Chain 4:                0.455552 seconds (Sampling)
## Chain 4:                1.2214 seconds (Total)
## Chain 4:</code></pre>
<p>we obtain the following posterior estimates</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="eq.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pois.HMM.stanfit,<span class="at">digits_summary =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Inference for Stan model: 9875485ac4343cdf02f82dbe9761d256.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                 mean se_mean    sd     2.5%      25%      50%      75%    97.5%
## Gamma[1,1]     0.862   0.002 0.085    0.669    0.825    0.879    0.919    0.966
## Gamma[1,2]     0.091   0.002 0.076    0.006    0.039    0.073    0.122    0.274
## Gamma[1,3]     0.047   0.001 0.042    0.002    0.017    0.036    0.066    0.152
## Gamma[2,1]     0.090   0.002 0.065    0.014    0.048    0.077    0.115    0.237
## Gamma[2,2]     0.817   0.002 0.085    0.626    0.778    0.831    0.874    0.935
## Gamma[2,3]     0.093   0.001 0.058    0.015    0.051    0.083    0.120    0.237
## Gamma[3,1]     0.077   0.001 0.069    0.002    0.025    0.059    0.110    0.249
## Gamma[3,2]     0.231   0.002 0.115    0.055    0.148    0.214    0.300    0.493
## Gamma[3,3]     0.691   0.002 0.124    0.423    0.609    0.706    0.783    0.891
## lambda[1]     13.198   0.019 0.857   11.423   12.686   13.221   13.729   14.875
## lambda[2]     19.828   0.026 1.069   17.689   19.181   19.836   20.478   21.929
## lambda[3]     29.905   0.036 1.905   26.419   28.600   29.855   31.105   33.882
## ta[1,1]        0.862   0.002 0.085    0.669    0.825    0.879    0.919    0.966
## ta[1,2]        0.091   0.002 0.076    0.006    0.039    0.073    0.122    0.274
## ta[1,3]        0.047   0.001 0.042    0.002    0.017    0.036    0.066    0.152
## ta[2,1]        0.090   0.002 0.065    0.014    0.048    0.077    0.115    0.237
## ta[2,2]        0.817   0.002 0.085    0.626    0.778    0.831    0.874    0.935
## ta[2,3]        0.093   0.001 0.058    0.015    0.051    0.083    0.120    0.237
## ta[3,1]        0.077   0.001 0.069    0.002    0.025    0.059    0.110    0.249
## ta[3,2]        0.231   0.002 0.115    0.055    0.148    0.214    0.300    0.493
## ta[3,3]        0.691   0.002 0.124    0.423    0.609    0.706    0.783    0.891
## statdist[1]    0.391   0.002 0.142    0.143    0.286    0.380    0.485    0.688
## statdist[2]    0.418   0.002 0.130    0.172    0.326    0.416    0.509    0.679
## statdist[3]    0.191   0.001 0.092    0.056    0.124    0.177    0.240    0.414
## lp__        -345.917   0.079 2.515 -351.814 -347.287 -345.502 -344.077 -342.235
##             n_eff  Rhat
## Gamma[1,1]   2066 1.000
## Gamma[1,2]   1987 1.000
## Gamma[1,3]   4086 1.001
## Gamma[2,1]   1333 1.002
## Gamma[2,2]   1526 1.002
## Gamma[2,3]   3405 1.000
## Gamma[3,1]   3718 1.001
## Gamma[3,2]   4353 1.000
## Gamma[3,3]   3762 1.001
## lambda[1]    1953 1.002
## lambda[2]    1658 1.000
## lambda[3]    2877 1.001
## ta[1,1]      2066 1.000
## ta[1,2]      1987 1.000
## ta[1,3]      4086 1.001
## ta[2,1]      1333 1.002
## ta[2,2]      1526 1.002
## ta[2,3]      3405 1.000
## ta[3,1]      3718 1.001
## ta[3,2]      4353 1.000
## ta[3,3]      3762 1.001
## statdist[1]  5011 1.000
## statdist[2]  3710 1.001
## statdist[3]  4474 1.001
## lp__         1025 1.004
## 
## Samples were drawn using NUTS(diag_e) at Fri Jun 16 13:19:35 2023.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="figure"><span style="display:block;" id="fig:postl-1"></span>
<img src="08-earthquake-example_files/figure-html/postl-1.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.13: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postl-2"></span>
<img src="08-earthquake-example_files/figure-html/postl-2.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.14: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postl-3"></span>
<img src="08-earthquake-example_files/figure-html/postl-3.png" alt="Posterior distribution for the state-dependent means of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.15: Posterior distribution for the state-dependent means of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-1"></span>
<img src="08-earthquake-example_files/figure-html/postg-1.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.16: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-2"></span>
<img src="08-earthquake-example_files/figure-html/postg-2.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.17: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-3"></span>
<img src="08-earthquake-example_files/figure-html/postg-3.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.18: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-4"></span>
<img src="08-earthquake-example_files/figure-html/postg-4.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.19: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-5"></span>
<img src="08-earthquake-example_files/figure-html/postg-5.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.20: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-6"></span>
<img src="08-earthquake-example_files/figure-html/postg-6.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.21: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-7"></span>
<img src="08-earthquake-example_files/figure-html/postg-7.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.22: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-8"></span>
<img src="08-earthquake-example_files/figure-html/postg-8.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.23: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postg-9"></span>
<img src="08-earthquake-example_files/figure-html/postg-9.png" alt="Posterior distribution for the transition probabilities of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.24: Posterior distribution for the transition probabilities of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-1"></span>
<img src="08-earthquake-example_files/figure-html/postd-1.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.25: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-2"></span>
<img src="08-earthquake-example_files/figure-html/postd-2.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.26: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>
<div class="figure"><span style="display:block;" id="fig:postd-3"></span>
<img src="08-earthquake-example_files/figure-html/postd-3.png" alt="Posterior distribution for the initial distribution of the three-state Poisson-HMM." width="672" />
<p class="caption">
Figure 8.27: Posterior distribution for the initial distribution of the three-state Poisson-HMM.
</p>
</div>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Damiano_Peterson_Weylandt_2017" class="csl-entry">
Damiano, Luis, Brian Peterson, and Michael Weylandt. 2017. <em>A Tutorial on Hidden Markov Models Using Stan</em>. <a href="https://luisdamiano.github.io/stancon18/hmm_stan_tutorial.pdf">https://luisdamiano.github.io/stancon18/hmm_stan_tutorial.pdf</a>.
</div>
<div id="ref-leosbarajas2018introduction" class="csl-entry">
Leos-Barajas, Vianey, and Théo Michelot. 2018. <span>“An Introduction to Animal Movement Modeling with Hidden Markov Models Using Stan for Bayesian Inference.”</span> <a href="https://arxiv.org/abs/1806.10639">https://arxiv.org/abs/1806.10639</a>.
</div>
<div id="ref-momentuhmm" class="csl-entry">
McClintock, Brett T., and Th’eo Michelot. 2018. <span>“Momentu<span>HMM</span>: <span>R</span> Package for Generalized Hidden <span>M</span>arkov Models of Animal Movement.”</span> <em>Methods in Ecology and Evolution</em> 9 (6): 1518–30. <a href="https://doi.org/10.1111/2041-210X.12995">https://doi.org/10.1111/2041-210X.12995</a>.
</div>
<div id="ref-stan" class="csl-entry">
Stan Development Team. 2023. <span>“<span>RStan</span>: The <span>R</span> Interface to <span>Stan</span>.”</span> <a href="https://mc-stan.org/">https://mc-stan.org/</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vinky-wang/HMM-Notes/edit/BRANCH/08-earthquake-example.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "https://github.com/vinky-wang/HMM-Notes/raw/BRANCH/08-earthquake-example.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
